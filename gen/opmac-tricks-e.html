<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, shrink-to-fit=no">

	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

	<link rel="alternate" hreflang="cs" href="opmac-tricks.html">
	<link rel="alternate" hreflang="en" href="opmac-tricks-e.html">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">

	<title>OPmac - tips, tricks, tutorials</title>

	<style>
		.my-sidebar-toc {
			max-height: 48vh;
			overflow-y: auto;
			max-width: 480px;
			box-shadow: 0 0 1rem 0 rgba(0,0,0,.15) inset;
		}

		.my-sidebar-toc ul {
			list-style-type: none;
		}

		.my-sidebar-toc ul ul {
			padding-left: 1.25rem;
		}

		.my-sidebar-toc ul a {
			display: block;
			padding: 0.1rem 1rem 0 2rem;
			color: #6c757d;
			text-decoration: none;
		}

		.my-sidebar-toc ul a:hover {
			color: #007bff;
		}

		.my-content {
			max-width: 720px;
		}

		.my-content pre {
			padding: 0.5rem;
			background-color: #f8f9fa;
			border-radius: .25rem;
			box-shadow: 0 0 1rem 0 rgba(0,0,0,.15) inset;
		}

		@media (min-width: 992px) {
			.my-sidebar-toc {
				max-height: initial;
			}

			@supports (position: sticky) or (-webkit-position:sticky) {
				.my-sidebar-toc {
				    max-height: calc(100vh - 8rem);
				    position: sticky;
				    top: 7rem;
				}

				.my-sidebar {
					-webkit-position: sticky;
					position: sticky;
					top: 0;
					max-height: 100vh;
				}

				.my-sidebar > h2 {
				    position: sticky;
				    top: 2.25rem;
				}
			}
		}

		.back-to-top {
			cursor: pointer;
			position: fixed;
			bottom: 20px;
			right: 20px;
			display:none;
		}

		.my-shadow {
			box-shadow: 0 0 1rem 0 rgba(0,0,0,.15);
		}

		a.list-group-item small {
		  white-space: nowrap;
		}
	</style>
</head>
<body style="min-width: 448px">

	<nav class="navbar navbar-expand-md navbar-dark bg-dark px-5">
		<a class="navbar-brand" href="opmac-e.html">OPmac</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active">
					<a class="nav-link" href="#">OPmac - tips, tricks, tutorials<span class="sr-only"> (this page)</span></a>
				</li>
			</ul>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<a class="nav-link" href="opmac-tricks-en.pdf">PDF <i class="far fa-file-pdf"></i></a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="opmac-tricks.html">Čeština <img src="img/cs.png" style="max-height: 1.33rem"></a>
				</li>
			</ul>
		</div>
	</nav>

	<div class="container-fluid">
		<div class="row flex-xl-nowrap">

			<aside class="my-sidebar col-12 col-lg-4 p-0 bg-light">
				<h2 class="text-center my-2">Table of contents</h2>
				<nav class="my-sidebar-toc mx-auto mb-3 mb-lg-0 bg-white pb-3">
					<ul class='my-3 p-0'>                  <li><a href='#pismo'>Fonts</a>
	<ul>
                          <li><a href='#svyska'>The ex height correction</a></li><li><a href='#currvf'>More intelligent \typosize and \typoscale</a></li><li><a href='#scaleto'>Font size changed by given width of the text</a></li><li><a href='#showfonts'>Listing of all fonts loaded by OPmac</a></li><li><a href='#onlycm'>Setting the set of preloaded math fonts</a></li><li><a href='#embrac'>Upright brackets in italic text</a></li><li><a href='#capinsert'>Resize first letter in the paragraph</a></li><li><a href='#fakebold'>Faked bold</a></li><li><a href='#jumping'>Underline omitting the descenders</a></li>
	</ul>
</li>                  <li><a href='#barvy'>Colors</a>
	<ul>
                          <li><a href='#coluser'>Color switchers like font switchers</a></li><li><a href='#collatex'>Color switchers like in LaTeX</a></li><li><a href='#colmnote'>Colors in margin notes</a></li><li><a href='#colmath'>Math nucleus colorization without subscript or superscript</a></li><li><a href='#colaccent'>Only math accent colorized</a></li><li><a href='#setrgbcolor'>Colors given in RGB</a></li><li><a href='#rgb'>RGB as internal color space</a></li><li><a href='#cmixdef'>Color mixing like at painter's palette</a></li><li><a href='#normalcmyk'>CMYK normalization</a></li><li><a href='#x11rgb'>The declaration of color set from X11</a></li>
	</ul>
</li>                  <li><a href='#transformace'>Transformations</a>
	<ul>
                          <li><a href='#transformbox'>Transformed box with new bounding box calculated</a></li><li><a href='#rotsimple'>Rotated box by 90 degrees</a></li><li><a href='#shbox'>Scaling box to desired size</a></li><li><a href='#sipky'>Curved arrows</a></li><li><a href='#cancel'>Canceled text</a></li><li><a href='#circletext'>Text around a circle</a></li><li><a href='#nopt'>Modification of \ignorept macro and new \nopt macro</a></li>
	</ul>
</li>                  <li><a href='#stranka'>Page</a>
	<ul>
                          <li><a href='#headline'>Running heads</a></li><li><a href='#podklad'>Background image on each page</a></li><li><a href='#maybebreak'>The page/line break only if there is small space to the end of page/line</a></li><li><a href='#sloupce'>Columns like in news paper</a></li><li><a href='#crop'>Crop marks</a></li><li><a href='#nopageno'>No page numbers in one-page documents</a></li><li><a href='#outbox'>Little pages with sizes given by box</a></li>
	</ul>
</li>                  <li><a href='#verbatim-prostredi'>Verbatim</a>
	<ul>
                          <li><a href='#loctt'>Local tthook</a></li><li><a href='#code'>Robust verbatim in titles of sections</a></li><li><a href='#ttpenalty'>\clubpenalties and \widowpenalties between lines in code listing</a></li><li><a href='#hisyntax'>Automatic syntax highlighting</a></li><li><a href='#hisyntaxhtml'>HTML syntax highlighting</a></li><li><a href='#hisyntaxpy'>Python syntax highlighting</a></li><li><a href='#hisyntaxcss'>C# syntax highlighting</a></li><li><a href='#ttram'>Listings in frames</a></li><li><a href='#verbbreak'>Long line breaking in listings</a></li><li><a href='#verbtab'>TABs in verbatim listings</a></li><li><a href='#verbindent'>Smart indentation of code lines in verbatim</a></li>
	</ul>
</li>                  <li><a href='#poznamky'>Notes</a>
	<ul>
                          <li><a href='#footcat'>Catcode changes in the footnotes</a></li><li><a href='#thefnote'>Different formatting of the mark in text and footnote</a></li><li><a href='#hyperlinkfnote'>The footnote mark connected to footnote by hyperlink</a></li><li><a href='#fnoteshape'>Paragraph shape in the footnote</a></li><li><a href='#fnotebroken'>Broken footnotes with colors</a></li><li><a href='#tnote'>Local notes for tables</a></li><li><a href='#rotmnote'>Rotated marginal notes</a></li><li><a href='#nmnote'>Numbered marginal notes</a></li>
	</ul>
</li>                  <li><a href='#odrazky'>Lists</a>
	<ul>
                          <li><a href='#vnoreni'>Nested \begitems...\enditems with given item marks</a></li><li><a href='#vnoreniB'>Another solution for nested \begitems...\enditems</a></li><li><a href='#vertii'>Vertical spacing in \begitems...\enditems</a></li><li><a href='#noindent'>No indent after list of items</a></li><li><a href='#gitemnum'>Global numbering of items</a></li>
	</ul>
</li>                  <li><a href='#draft'>Draft</a>
	<ul>
                          <li><a href='#draftlabels'>Printing labels in draft mode</a></li><li><a href='#rfc'>Request for correction in draft mode</a></li>
	</ul>
</li>                  <li><a href='#cislovani-odkazy'>Numbering, references</a>
	<ul>
                          <li><a href='#cislovani'>Systematic declaration of numbers</a></li><li><a href='#pictab'>List of figures and tables</a></li><li><a href='#caplisting'>Captions for code listings</a></li><li><a href='#capformat'>Different formatting of the table and figure captions</a></li><li><a href='#urlbreakpoint'>URL hyphenation</a></li>
	</ul>
</li>                  <li><a href='#kapitoly-sekce'>Chapters, sections</a>
	<ul>
                          <li><a href='#seccc'>Subsubsection</a></li><li><a href='#notoc'>Different hyphenation of title in text and table of contents</a></li><li><a href='#part'>New level of titles (part) in the text and in the TOC</a></li><li><a href='#notopins'>How to prevent \topins on chapter page</a></li><li><a href='#globnonum'>Global \nonum for all chapters and sections</a></li>
	</ul>
</li>                  <li><a href='#pracovni-soubor'>REF file</a>
	<ul>
                          <li><a href='#refconsistent'>Checks of REF file consistency</a></li><li><a href='#qrcode'>Data of QR code in REF file</a></li>
	</ul>
</li>                  <li><a href='#vyznacovani'>Printing selections</a>
	<ul>
                          <li><a href='#soul'>Underlining, overlining, letterspacing</a></li><li><a href='#hyphprocess'>Hyphenation preprocessing</a></li><li><a href='#coltext'>Background-colored text</a></li><li><a href='#specline'>Marginal line around selected text</a></li>
	</ul>
</li>                  <li><a href='#makro-premety'>Macro tricks</a>
	<ul>
                          <li><a href='#replacestrings'>Usage of \replacestrings</a></li><li><a href='#argofvector'>Calculation of the direction of given vector</a></li><li><a href='#optdef'>Defining a macro with optional parameter</a></li><li><a href='#noendspace'>Removing the last space in the parameter</a></li><li><a href='#eoldef'>Macro with a parameter to the end of line</a></li><li><a href='#keyval'>The key=value dictionaries</a></li><li><a href='#flags'>The options in key=value dictionaries</a></li><li><a href='#balanced'>Nested brackets of another type than {}</a></li><li><a href='#readtoks'>Reading parameter text token per token</a></li><li><a href='#etoks'>Expandable reading text token per token</a></li><li><a href='#appendto'>An improved \addto for macros with parameters</a></li><li><a href='#patchto'>The \patchto macro can modify another macro</a></li><li><a href='#for'>The for-loop</a></li><li><a href='#rep'>The loop at expand processor only</a></li><li><a href='#newcommand'>\newcommand like in LaTeX</a></li><li><a href='#lipsum'>Testing text Lorem ipsum dolor sit</a></li><li><a href='#showif'>Hidden text from unprivileged readers</a></li><li><a href='#plists'>Linked lists</a></li><li><a href='#revlist'>The list expanded in revesed order</a></li><li><a href='#sb'>Normal underscore outside the math mode</a></li><li><a href='#stripspace'>Stripping last space from parameter</a></li><li><a href='#varsep'>Variant separators of parameters</a></li><li><a href='#vardelim'>Parameter delimited by variant separator</a></li>
	</ul>
</li>                  <li><a href='#struktura'>Markup</a>
	<ul>
                          <li><a href='#latexchap'>LaTeX markup of chapters and sections</a></li><li><a href='#sec'>Name conflict with \sec macro</a></li>
	</ul>
</li>                  <li><a href='#jazyky'>Languages</a>
	<ul>
                          <li><a href='#multilang'>Multilingual texts</a></li><li><a href='#nextlang'>Adding a new language</a></li><li><a href='#Uppercase'>Uppercase of German ß</a></li><li><a href='#exseven'>Uppercase \mtext phrases</a></li><li><a href='#hebrew'>Hebrew -- right to left typesetting</a></li>
	</ul>
</li>                  <li><a href='#matematicka-sazba'>Math</a>
	<ul>
                          <li><a href='#alphachars'>Czech texts in math</a></li><li><a href='#eqnum'>The reference to the previous equation</a></li><li><a href='#overtilde'>Expandable tilde over math formula of arbitrary size</a></li><li><a href='#mathbox'>Math text (in box) depending on mathstyle</a></li><li><a href='#mrepeat'>Repeating math symbols at break points</a></li><li><a href='#dots'>Intelligent \dots like in AMSTeX</a></li><li><a href='#dddot'>\dddot for third derivation</a></li><li><a href='#bbgreek'>Greek letters in \bbchar family</a></li><li><a href='#smartgreek'>Upright greek letters in math</a></li><li><a href='#bfmath'>Normal \bf and \bi in math mode</a></li><li><a href='#vecmath'>Vectors in sansserif bold including greek letters</a></li><li><a href='#dfam'>Dynamically allocated math families</a></li><li><a href='#matrixR'>Matrices with one column outside</a></li><li><a href='#matrixA'>Matrices with one row outside</a></li><li><a href='#mspecdef'>Visual marks in math</a></li><li><a href='#varstyle'>Math style dependent macros</a></li>
	</ul>
</li>                  <li><a href='#tabulky'>Tables</a>
	<ul>
                          <li><a href='#etable'>Table which spans to more columns and rows</a></li><li><a href='#tabcrow'>Vertical centered text in more rows</a></li><li><a href='#tabpmod'>Variations of paragraphs with p declarator</a></li><li><a href='#tablemb'>Vertical alignment of p cells in table row</a></li><li><a href='#crlpvv'>\crlp and double vertical lines</a></li><li><a href='#tableverb'>Verbatim text in tables</a></li><li><a href='#booktabs'>Tables like in booktabs package</a></li><li><a href='#crx'>Colored lines in the table</a></li><li><a href='#cellcolor'>Colored cells in the table</a></li><li><a href='#multispanc'>Colored multispan</a></li><li><a href='#tableto'>Tables with the given width</a></li><li><a href='#partab'>The cells with paragraph-like formatting</a></li><li><a href='#decltab'>The extended multiletter column declarations</a></li><li><a href='#dekadic'>The decimal point aligned in the table</a></li><li><a href='#dekadic2'>The decimal point aligned, another solution</a></li><li><a href='#ltable1'>The table over more than one page</a></li><li><a href='#ltable2'>Long tables with the repeated title</a></li>
	</ul>
</li>                  <li><a href='#obrazky'>Images</a>
	<ul>
                          <li><a href='#inspicspace'>The space as a separator of \inspic parameter</a></li><li><a href='#inkinspic'>The Inkscape labels for pictures</a></li><li><a href='#capside'>Caption beside of the image</a></li><li><a href='#inspic'>\inspic loads the same image only once</a></li>
	</ul>
</li>                  <li><a href='#odstavec'>Paragraph</a>
	<ul>
                          <li><a href='#setparshape'>Comfortable \parshape setting</a></li><li><a href='#putshape'>Rectangular text-cropping with an image</a></li>
	</ul>
</li>                  <li><a href='#slidy'>Slides</a>
	<ul>
                          <li><a href='#sparta'>Simple slides</a></li><li><a href='#slidekuk'>Slideshow -- partial exposure</a></li>
	</ul>
</li>                  <li><a href='#bibliograficke-udaje'>Bibliography</a>
	<ul>
                          <li><a href='#pcite'>Cites with the inserted text</a></li><li><a href='#ccite'>The [name year] condensed cites</a></li><li><a href='#modcite'>The modification of (name year) cites</a></li><li><a href='#abib'>Cite-marks in the bibliography when \nonumcitations is used</a></li><li><a href='#bibmark'>Short cite-marks generated by opmac-bib</a></li><li><a href='#bibmarkcheck'>Are cite-marks unique?</a></li><li><a href='#bibnumindent'>Bibliography indentation by maximal cite number</a></li><li><a href='#bibmarkindent'>Bibliography indentation by maximal mark</a></li><li><a href='#morebibs'>More independent bibliography lists</a></li><li><a href='#bibtexenc'>OPmac-bib: no more BibTeX problems</a></li>
	</ul>
</li>                  <li><a href='#slovnicek'>Glossary</a>
	<ul>
                          <li><a href='#gloslast'>Glossary at the end of the document</a></li><li><a href='#glosfirst'>Glossary at the begin of the document</a></li><li><a href='#glossort'>Glossary sorted by Czech sorting rules</a></li><li><a href='#glosref'>Glossary with hyperlinks</a></li><li><a href='#acronym'>Acronyms</a></li>
	</ul>
</li>                  <li><a href='#rejstrik'>Index</a>
	<ul>
                          <li><a href='#sort'>Using sort from indexes for another purposes</a></li><li><a href='#klikpgr'>Pages in the Index as hyperlinks</a></li><li><a href='#iindexb'>Alternative page-lists in the index</a></li><li><a href='#iibe'>Index entry valid in page range</a></li><li><a href='#strcmp'>The sorting experiment</a></li><li><a href='#currchar'>Sections inside the index by first letter</a></li>
	</ul>
</li>                  <li><a href='#meta'>Format</a>
	<ul>
                          <li><a href='#opformat'>OPmac macros as part of a format</a></li><li><a href='#curl'>Sorted names of these tricks on your terminal</a></li>
	</ul>
</li></ul>
				</nav>
			</aside>

			<div class="col-12 col-lg-8 px-0 my-shadow">
				<div class="py-3 px-2 px-sm-3">
					<main class="my-content mx-auto ml-xl-5" role="main">

						<section class="mb-5">
							<img src="img/opmac-logo.jpg" class="img-fluid rounded mx-auto d-block" style="max-height: 80px">

							<h1 class="text-center font-weight-light">OPmac - tips, tricks, tutorials</h1>

							<p>This page includes solutions of various tasks when using <a href="opmac-e.html">OPmac</a>. Each solution would be “small” it means you can see whole solution at once in your www browser. The constellation of each solution is similar: user description followed by macro code followed by explanation of the macro code. User can copy and paste the macro code to his/her document simply by the mouse.</p>
							<p>If there exists any tip from you, OPmac user, please don't hesitate and send it to me. I'll welcome it and save it here (with the author of the solution mentioned).</p>

							<div class="alert alert-info" role="alert">
								You can also download PDF version of this document
								<a href="opmac-tricks-en.pdf" class="btn btn-secondary btn-sm">PDF <i class="far fa-file-pdf"></i></a>
							</div>
						</section>


		                
                    <div class="card mx-auto mb-5 my-shadow" style="max-width: 520px">
                    <div class="card-header text-center">
                        <strong>Most recent articles</strong>
                    </div>
                    <div class="list-group list-group-flush">

                    <a href="#hyperlinkfnote" class="list-group-item list-group-item-action d-flex justify-content-between">
    The footnote mark connected to footnote by hyperlink
    <small>03/19/2020</small>
</a> <a href="#dekadic2" class="list-group-item list-group-item-action d-flex justify-content-between">
    The decimal point aligned, another solution
    <small>12/07/2019</small>
</a> <a href="#vecmath" class="list-group-item list-group-item-action d-flex justify-content-between">
    Vectors in sansserif bold including greek letters
    <small>10/20/2019</small>
</a> <a href="#nopt" class="list-group-item list-group-item-action d-flex justify-content-between">
    Modification of \ignorept macro and new \nopt macro
    <small>06/23/2019</small>
</a> <a href="#hisyntaxcss" class="list-group-item list-group-item-action d-flex justify-content-between">
    C# syntax highlighting
    <small>06/21/2019</small>
</a>

                    </div></div>


		                 <section id="pismo" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Fonts</h2>
                                    <a href="#pismo"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='svyska' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The ex height correction</h3> <a href='#svyska'><i class='fas fa-link'></i></a></div></header><section><p>The visual incompatibility of font height can sometimes occur. For example typewriter font <code>\tt</code> has different ex height than normal text font even though both fonts are loaded at the same size. The correction can be done simply by <code>\thefontscale</code> macro from OPmac. The scale factor is based on the current size of the font (no on the fixed design size). The following macro can be used, for example: </p><pre class='pr-3'><code>\def\tt{\tentt\thefontscale[1120]} 
</code></pre><p>This definition scales the <code>\tt</code> font 1.12 times with respect to surrounded font. The current font size can be arbitrary. The example above with the ratio 1.12 is suitable for Bookman + Courier fonts. </p></section><footer class='text-right'><a href='opmac-tricks.html#svyska' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0001</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='currvf' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>More intelligent \typosize and \typoscale</h3> <a href='#currvf'><i class='fas fa-link'></i></a></div></header><section><p>The macros <code>\typosize</code> and <code>\typoscale</code> resize the fonts in all variants but they don't respect the current variant selected before <code>\typosize</code> or <code>\typoscale</code> is used. They always reset the current variant to <code>\rm</code>. This is feature of OPmac because <code>\thefontsize</code> and <code>\thefontscale</code> can be used for resizing single selected variant of the font. </p><p>The problem can be illustrated in this example: </p><pre class='pr-3'><code>\bf text \typosize[13/15] big 
</code></pre><p>The word “big” is printed in <code>\rm</code>, not in <code>\bf</code>. We can redefine <code>\typosize</code> and <code>\typoscale</code> macros so, that they do respect the current variant. This can be done by the following code: </p><pre class='pr-3'><code>\let\currvf=\rm 
\addto\rm{\let\currvf\rm}   \addprotect\rm 
\addto\it{\let\currvf\it}   \addprotect\it 
\addto\bf{\let\currvf\bf}   \addprotect\bf 
\addto\bi{\let\currvf\bi}   \addprotect\bi 
 
\def\textfontsize[#1]{\if$#1$\else 
  \fontdim=#1\ptunit \ifx\fontdimB\undefined \edef\fontdimB{\the\fontdim}\fi 
  \let\dgsize=\fontdim 
  \edef\sizespec{at\the\fontdim}% 
  \resizeall \currvf 
  \let\dgsize=\undefined 
  \fi 
} 
</code></pre><p>The macros <code>\rm</code>, <code>\bf</code>, <code>\it</code> and <code>\bi</code> select the appropriate font variant (of course) and they save the information about selected variant of font into <code>\currvf</code>. The <code>\addprotect</code> is used in order to avoid the problems when <code>\rm</code>, <code>\bf</code> etc. are inside <code>\write</code> parameters. The internal macro of OPmac <code>\textfontsize</code> is redefined: only the occurrence of <code>\rm</code> (after <code>\resizeall</code>) is replaced by <code>\currvf</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#currvf' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0132</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-11-23'>11/23/2015</time></span> </footer></article> <article id='scaleto' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Font size changed by given width of the text</h3> <a href='#scaleto'><i class='fas fa-link'></i></a></div></header><section><p>We prepare the macro <code>\scaleto size {text}</code> which prints “text” by actual font resized, that the “text” width is the given size. For example <code>\scaleto5cm{hello}</code> creates a&nbsp;box with the text “hello” resized that the width of the text “hello” is <code>5cm</code>. This can be usable for creating titles of posters, for resizing the title to the <code>\hsize</code> etc. </p><pre class='pr-3'><code>\def\scaleto#1#{\bgroup\def\bw{#1}\scaletoA} 
\def\scaletoA #1{\expandafter\let \expandafter\thefont \the\font 
   \calculatefontdim{#1}\edef\dgsize{\the\fontdim}\letfont\thefont=\thefont at\fontdim 
   \calculatefontdim{#1}\letfont\thefont=\thefont at\fontdim 
   \hbox to\bw{\thefont#1}% 
   \egroup 
} 
\def\calculatefontdim#1{% 
   \setbox0=\hbox{\thefont #1}\tmpdim=\bw \tmpnum=\wd0 
   \divide\tmpnum by256 \divide\tmpdim by\tmpnum \multiply\tmpdim by256 
   \fontdim=\expandafter\ignorept\the\tmpdim\fontdim 
} 
</code></pre><p>The macro calculates the right aspect ratio by dividing the desires size by the real size of the text. The <code>\fontdim</code> is multiplied by this ratio. The calculating is done twice. After first attempt the <code>\fontdim</code> and <code>\dgsize</code> are changed. This means that the suitable optical size of the font is used. But this can change the real size of the text. So, the second calculation does correction of this and only geometrical resizing is done during second attempt. </p><p>If eTeX is activated then the ratio of two dimensions can be calculated more comfortable by <code>\dividedimen</code> macro, which works at expand processor level. </p><pre class='pr-3'><code>\def\dividedimen (#1/#2){\expandafter\ignorept\the 
   \dimexpr\numexpr\number\dimexpr#1\relax*65536/\number\dimexpr#2\relax\relax sp\relax 
} 
\def\calculatefontdim#1{% 
   \setbox0=\hbox{\thefont #1}% 
   \fontdim=\dividedimen(\bw/\wd0)\fontdim 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#scaleto' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0027</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-05,2013-11-22'>09/05/2013</time></span> </footer></article> <article id='showfonts' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Listing of all fonts loaded by OPmac</h3> <a href='#showfonts'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes, it is usable to list loaded fonts. For example user needs to know used fonts after <code>\input lmfonts</code> and <code>\typosize[11/13]</code>. User can type <code>\showfonts</code>, if this macro is defined like: </p><pre class='pr-3'><code>\def\showfonts{\bgroup 
   \def\wterm##1{\immediate\write16{##1}} 
   \def\resizefont##1{\wterm{##1= \fontname##1}}\resizeall 
   \tmpnum=0 \loop 
      \wterm{\the\tmpnum: \fontname\textfont\tmpnum\space/ 
                          \fontname\scriptfont\tmpnum\space/ 
                          \fontname\scriptscriptfont\tmpnum} 
      \advance\tmpnum by1 \ifnum\tmpnum&lt;16 \repeat 
   \egroup} 
</code></pre><p>The <code>\showfonts</code> prints the names of all textual fonts registered by <code>\regfont</code>. Moreover, it prints names of all math fonts of families 0&nbsp;to 15. </p></section><footer class='text-right'><a href='opmac-tricks.html#showfonts' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0029</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-24'>09/24/2013</time></span> </footer></article> <article id='onlycm' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Setting the set of preloaded math fonts</h3> <a href='#onlycm'><i class='fas fa-link'></i></a></div></header><section><p>When we use <code>\showfonts</code> from previous OPmac trick then we find that OPmac preloads not only standard CM fonts but also a&nbsp;lot of special fonts from AMS package and EC fonts package. Maybe, we needn't to use such special fonts and, moreover, we have these fonts not installed in TeX distribution. </p><p>We can avoid this dependency on external fonts using <code>\let\normalmathloading=\relax</code>. This setting must be done before <code>\input opmac</code>. Next, you have to define math sets <code>\normalmath</code> and <code>\boldmath</code> followed by execution of <code>\normalmath</code>. For example, we want to use only CM fonts and nothing else. Then we can write </p><pre class='pr-3'><code>\let\normalmathloading=\relax 
\input opmac 
 
\def\normalmath{% 
  \loadmathfamily 0 cmr  % CM Roman 
  \loadmathfamily 1 cmmi % CM Math Italic 
  \loadmathfamily 2 cmsy % CM Standard symbols 
  \loadmathfamily 3 cmex % CM extra symbols 
  \loadmathfamily 8 cmbx % bold 
  \setmathfamily  9 \tenbi % bold slanted 
  \setmathfamily 10 \tenrm 
  \setmathfamily 11 \tenit 
  \setmathdimens 
} 
\def\boldmath{% 
  \loadmathfamily 0 cmbx  % CM Roman Bold Extended 
  \loadmathfamily 1 cmmib % CM Math Italic Bold 
  \loadmathfamily 2 cmbsy % CM Standard symbols Bold 
  \loadmathfamily 3 cmex  % CM extra symbols 
  \loadmathfamily 8 cmbx  % bold 
  \setmathfamily  9 \tenbi % bold slanted 
  \setmathfamily 10 \tenrm 
  \setmathfamily 11 \tenit 
  \setmathdimens 
} 
\normalmath 
</code></pre><p>Of course, the math symbols from ignored fonts will not work after such setting, i. e. AMS symbols will be unavailable, <code>\script</code>, <code>\frak</code>, <code>\bbchar</code> will not work, <code>\bf</code> and <code>\bi</code> prints normal bold (not sans serif). On the other hand, the processing isn't dependent on availability of AMS nor EC fonts in your TeX distribution. </p><p>Another solution of the same task can be: copy the file <code>ams-math.tex</code> into your new file (say <code>my-math.tex</code>) and do changes in this file as you wish. Then you can load this file *before* <code>\input opmac</code>. So: </p><pre class='pr-3'><code>\input my-math 
\input opmac 
</code></pre><p>Explanation: If <code>\normalmath</code> is defined before <code>\input opmac</code> then OPmac doesn't load <code>ams-math.tex</code> file any more. </p></section><footer class='text-right'><a href='opmac-tricks.html#onlycm' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0111</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-06-17'>06/17/2015</time></span> </footer></article> <article id='embrac' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Upright brackets in italic text</h3> <a href='#embrac'><i class='fas fa-link'></i></a></div></header><section><p>The feature from LaTeX package <code>embrac.sty</code> (300 lines of very nontransparent code) can be implemented in OPmac by only one line. </p><p>The typographical requirement to keep brackets <code>()</code> unslanted in slanted text can occur. This means that if we type <code>{\em italics with (brackets)}</code>, then we get </p><pre class='pr-3'><code>{\it italics with {\rm(}brackets{\/\rm)}} 
</code></pre><p>This can be solved by following definition: </p><pre class='pr-3'><code>\addto\em{\adef({\ifmmode(\else{\rm(}\fi}\adef){\ifmmode)\else{\/\rm)}\fi}} 
</code></pre><p>This definition set the brackets as active in italics and keeps the original meaning of brackets in math mode. So, it works: </p><pre class='pr-3'><code>{\em Text $\bigl((yxy)+z\bigr)$ and something (in brackets)}. 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#embrac' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0064</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-06-07'>06/07/2013</time></span> </footer></article> <article id='capinsert' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Resize first letter in the paragraph</h3> <a href='#capinsert'><i class='fas fa-link'></i></a></div></header><section><p>We implement the macro <code>\Capinsert</code>, which resizes the first letter in the paragraph: </p><pre class='pr-3'><code>\Capinsert First letter will be resized, i.e. the F in this case... 
or 
\Capinsert {left typesetting} First letter will be resized... 
</code></pre><p>We need to declare the size of resized letter and how to include it into the lines of the paragraph. The declaration part can look like: </p><pre class='pr-3'><code>\newdimen\ptem     \ptem=.1em        % unit dependent on "em" 
\newdimen\Capsize  \Capsize=44\ptem  % desired size 
\newdimen\Capabove \Capabove=8\ptem  % top enjambment over baseline 
\newdimen\Capafter \Capafter=1\ptem  % the space amount after the letter 
\def\Capprefix{\localcolor\Red}      % the macro executed before the letter 
 
%% The shape declaration for each letter 
% \declCap letter {left shift; 1. line correction, 2. line corr., etc.} 
\declCap {default} {0;0,0,0}  % default values for undeclared letters 
\declCap W {3;0,4,6} 
\declCap A {1;6,2,-2} 
\declCap L {0;9,0,0} 
... 
</code></pre><p>The implementation follows. Note, that the similar feature solves the LaTeX package <code>lettrine</code>. </p><pre class='pr-3'><code>\def\declCap #1#2{\sxdef{cap:=#1}{#2}} 
\def\Capinsert{\def\leftCapmaterial{}\futurelet\next\CapinsertA} 
\def\CapinsertA{\ifx\next\bgroup \expandafter\CapinsertB \else 
\expandafter\CapinsertC \fi} 
\def\CapinsertB #1{\def\leftCapmaterial{#1}\CapinsertC} 
\def\CapinsertC #1{\par 
  \isdefined{cap:=#1}\iftrue \edef\tmp{\csname cap:=#1\endcsname}% 
                     \else   \edef\tmp{\csname cap:=default\endcsname}\fi 
  \setbox0=\hbox{{\thefontsize[\expandafter\ignorept\the\Capsize]\Capprefix#1}\kern\Capafter}% 
  \expandafter \CapinsertD \tmp,,% 
  \noindent\kern-\firstlineindent \rlap{\kern-\protrudeCap\ptem\llap{\leftCapmaterial}% 
                                        \vbox to0pt{\kern-\Capabove\box0\vss}}% 
  \kern\firstlineindent 
} 
\def\CapinsertD #1;{\tmpnum=1 \let\firstlineindent=\undefined 
   \def\parshapeparams{}\def\protrudeCap{#1}\CapinsertE} 
\def\CapinsertE #1,{\ifx,#1,\parshape =\tmpnum \parshapeparams 0pt \hsize 
  \else 
     \advance\tmpnum by1 
     \tmpdim=\wd0 \advance\tmpdim by-#1\ptem \advance\tmpdim by-\protrudeCap\ptem 
     \edef\parshapeparams{\parshapeparams\the\tmpdim}% 
     \ifx\firstlineindent\undefined \let\firstlineindent\parshapeparams \fi 
     \advance\tmpdim by-\hsize \tmpdim=-\tmpdim 
     \edef\parshapeparams{\parshapeparams\the\tmpdim}% 
     \expandafter \CapinsertE \fi 
} 
</code></pre><p>The detail description of this macro can be found at <a href='http://tex.stackexchange.com/questions/186701/thoughts-on-turning-this-dropcap-lettrine-code-into-a-macro' title='tex.stackexchange'>tex.stackexchange</a>. </p></section><footer class='text-right'><a href='opmac-tricks.html#capinsert' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0075</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-27'>06/27/2014</time></span> </footer></article> <article id='fakebold' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Faked bold</h3> <a href='#fakebold'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes, the real bod isn't available. But we need to point out some letter or character by bold shape (especially in math). For example, the symbols from AMS-A or AMS-B collections are not available in bold shape. The faked bod can help you in such cases. The usage is simple: </p><pre class='pr-3'><code>Formula: $a+b\fakebold{+}c = \fakebold{\script D}$. 
</code></pre><p>The <code>\fakebold</code> macro is based on PDF code inserted using <code>\pdfliteral</code> </p><pre class='pr-3'><code>\def\fakebold#1{\pdfliteral{2 Tr .3 w}#1\pdfliteral{0 Tr 0 w}} 
</code></pre><p>The code <code>2 Tr .3 w</code> gives the message to PDF RIP: the characters defined by their outlines will be not only filled but they will be stroked around outline too. The width of the stroke line is declared as <code>.3 bp</code> (see the <code>w</code> parameter). The result seems like bold shape. </p><p>You can experiment with another effects. For example the characters will be only stroked but not filled: <code>1 Tr</code>. The stroke width have to be set, of course <code>.2 w</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#fakebold' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0095</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-08'>04/08/2015</time></span> </footer></article> <article id='jumping' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Underline omitting the descenders</h3> <a href='#jumping'><i class='fas fa-link'></i></a></div></header><section><p>Using previous OPmac trick, we create the macro <code>\underlinee{text}</code> which creates underlined text but the rule respects descenders. Test: <code>\underlinee{jumping quickly}</code> prints </p><p><img src='img/jumping-ukazka.png' alt='jumping quickly' title='jumping quickly' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The <code>\underlinee</code> macro designed for Computer modern at <code>10pt</code> can look like </p><pre class='pr-3'><code>\def\underlinee#1{% 
   \leavevmode\vbox to0pt{\vss 
      \hrule height.3pt 
      \vskip-\baselineskip \kern2.5pt 
      \localcolor 
      \hbox{\strut\rlap{\White\pdfliteral{2 Tr 1.1 w}#1\pdfliteral{0 Tr 0 w}}#1} 
}} 
</code></pre><p>If another font is used then you can set the constants <code>.3pt</code>, <code>2.5pt</code> and <code>1.1</code> indiviually in order to reach the best result. </p><p>The <code>\underline{text}</code> macro creates a&nbsp;box, so the text isn't breakable into more lines inside the paragraph. If you need automatically broken underlined text then you can be inspired by <a href='http://petr.olsak.net/opmac-tricks-e.html#soul' title='OPmac trick 0063'>OPmac trick 0063</a>. Analogical problem is solved at <a href='http://tex.stackexchange.com/questions/249850/' title='tex.sx.com'>tex.sx.com</a> </p></section><footer class='text-right'><a href='opmac-tricks.html#jumping' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0112</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-06-19'>06/19/2015</time></span> </footer></article>
                            </section>  <section id="barvy" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Colors</h2>
                                    <a href="#barvy"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='coluser' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Color switchers like font switchers</h3> <a href='#coluser'><i class='fas fa-link'></i></a></div></header><section><p>This OPmac trick has its reason for until version Nov. 2014. New version Dec. 2014 provides the command <code>\localcolor</code> at the beginning of your document. You needn't do nothing more. The colors are set locally after such declaration inside groups. But you need to take care in following cases: </p><pre class='pr-3'><code>\setbox0=\hbox{text \Red text}   % Doesn't work, because the re-setting 
                                 % to the original color is done after 
                                 % \setbox0, i.e. outside the box. 
\setbox0=\hbox{{text \Red text}} % Works, the re-setting is done 
                                 % inside the box. 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#coluser' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0026</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-03'>09/03/2013</time></span> </footer></article> <article id='collatex' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Color switchers like in LaTeX</h3> <a href='#collatex'><i class='fas fa-link'></i></a></div></header><section><p>The LaTeX color package provides the macro <code>\color</code>, which sets the color locally by its argument. This macro can be defined by: </p><pre class='pr-3'><code>\def\color#1{\localcolor\colorA#1\relax} 
\def\colorA#1#2\relax{\uppercase{\csname#1}#2\endcsname\ignorespaces} 
 
Text {\color{red} red text} and {\color{blue} blue text} and normal. 
</code></pre><p>This macro ensures <code>\localcolor</code> and runs the control sequence given by the parameter, but first letter is capitalized. </p></section><footer class='text-right'><a href='opmac-tricks.html#collatex' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0034</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-11-29'>11/29/2013</time></span> </footer></article> <article id='colmnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Colors in margin notes</h3> <a href='#colmnote'><i class='fas fa-link'></i></a></div></header><section><p>If you set colors of text inside the paragraph and you are using <code>\mnote</code> simultaneously then you can be surprised. The <code>\mnote</code> text is inserted after the current line (like special virtual line), so it is colorized by the color used at the end of the current line (no at the moment when macro <code>\mnote</code> were used). If you need to have the color of the mnotes unchanged, you can write at beginning of the document: </p><pre class='pr-3'><code>\def\mnotehook{\noindent\localcolor\Blue} 
</code></pre><p>The <code>\noindent</code> command is needed because the color-set mark have to be inserted in horizontal mode else <code>\mnote</code> will not be vertically aligned. </p><p>Why OPmac doesn't define <code>\Black</code> in <code>\mnotehook</code> by default? Because the implicit behavior supposes that the <code>\mnotes</code> will inherit their color from the color of the relevant paragraph. This color can be set for more pages, for example. </p><p>You can use nested colors in nested groups in the <code>\mnote</code> parameter. </p></section><footer class='text-right'><a href='opmac-tricks.html#colmnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0037</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-03-22'>03/22/2014</time></span> </footer></article> <article id='colmath' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Math nucleus colorization without subscript or superscript</h3> <a href='#colmath'><i class='fas fa-link'></i></a></div></header><section><p>The task is to colorize only nucleus of the formula without subscript and superscript. When we write <code>$\colormath\Red Y_i^2$</code> then the letter <code>Y</code> will be red, but subscript and superscript is colorized by the outside color. The simple solution <code>${\localcolor\Red Y}_i^j$</code> doesn't work right because the command for returning back to the outside color is inserted after nucleus and this breaks the right kerning between nucleus and subscript. The solution saves the outside color to the <code>\tmpc</code> and uses it in the subscript and superscript. </p><pre class='pr-3'><code>\def\colormath#1#2{% #1=color #2=colored text 
   \bgroup \let\tmpc=\currentcolor % saving current color 
   \localcolor#1#2% 
   \isnextchar_{\colormathA}{% 
      \ifcat\next.\insertmukern{#2}\next\fi 
      \ifcat\next x\insertmukern{#2}\next\fi 
      \egroup}% 
} 
\def\colormathA_#1{_{\setcmykcolor\tmpc#1}\isnextchar^{\colormathB}{\egroup}} 
\def\colormathB^#1{^{\setcmykcolor\tmpc#1}\egroup} 
 
\def\ignorefracpart#1.#2\relax{#1} 
\newmuskip\tmpmudim 
\def\insertmukern #1#2{\setbox0=\hbox{$#1#2$}\setbox1=\hbox{$#1\null#2$}% 
   \tmpdim=\wd0 \advance\tmpdim by-\wd1 
   \tmpmudim=\expandafter\ignorept\the\tmpdim mu \tmpmudim=288\tmpmudim 
   \tmpdim=16em \divide\tmpmudim by\expandafter\ignorefracpart\the\tmpdim\relax 
   \mkern\tmpmudim 
} 
</code></pre><p>The macro solves additional problem: between the “Y” letter and the comma is negative kern in CM font but this kern cannot be used if the single “Y” is colorized and followed by comma. We calculate such kern and insert it by the <code>\insertmukern</code> macro. The macro measures the kern by comparing the width of two boxes in <code>\textstyle</code>. The result is in <code>pt</code> units, but the macro recalculate this to mu units in order to the result depends on the <code>\textstyle/\scriptsyle/\scripscriptstyle</code> context. The formula for recalculation is: <code>mu = (288 / 16em) pt = 18/\quad pt</code>. The <code>16em</code> is used because of minimization the rounding errors when dividing integer by integer. </p></section><footer class='text-right'><a href='opmac-tricks.html#colmath' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0066</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-12'>06/12/2014</time></span> </footer></article> <article id='colaccent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Only math accent colorized</h3> <a href='#colaccent'><i class='fas fa-link'></i></a></div></header><section><p>This is similar problem like the problem solved in the previous OPmac trick 0066. We can set the color for the accent but the base have to be in outside color and this breaks the right kerning. We can test: </p><pre class='pr-3'><code>$\widetilde{E}\ \widetilde{\pdfliteral{}E}\ \coloredaccent\Red\widetilde{E}$ 
</code></pre><p>and we get: </p><p><img src='img/coloredaccent.png' alt='Colored accent' title='Colored accent' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>Note that the middle <code>E~</code> is bad because the <code>\pdfliteral</code> command was inserted between the accent and the base. This breaks the <code>\skewchar</code> calculation of the accent position. It is irrelevant if <code>\pdfliteral</code> is empty (as in the example) or it includes the color command. The last example of <code>E~</code> is typeset right because the <code>\coloredaccent</code> macro is used. This macro is defined here: </p><pre class='pr-3'><code>\newmuskip\tmpmudim 
 
\def\coloredaccent#1#2#3{% #1=color, #2=accent, #3=base 
   {\ifnum\skewchar\textfont1&lt;0 \tmpmudim=0mu \else \calculatemukern {#3}{\char\skewchar\textfont1}\fi 
    \let\tmpc=\currentcolor % saving current color 
    \localcolor #1\mkern2\tmpmudim #2{\setcmykcolor\tmpc \mkern-2\tmpmudim#3} 
   } 
} 
\def\calculatemukern #1#2{\setbox0=\hbox{\the\textfont1 #1#2}\setbox1=\hbox{\the\textfont1 #1\null#2}% 
   \tmpdim=\wd0 \advance\tmpdim by-\wd1 
   \tmpmudim=\expandafter\ignorept\the\tmpdim mu \tmpmudim=288\tmpmudim 
   \tmpdim=16em \divide\tmpmudim by\expandafter\ignorefracpart\the\tmpdim\relax 
} 
\def\ignorefracpart#1.#2\relax{#1} 
</code></pre><p>The macro <code>\coloredaccent</code> measures the kerning pair when <code>\skewchar</code> is set. The conversion to the <code>mu</code> units is done similar as in previous trick 0066. The accent is mover right by the calculated result and the base is set back to left. </p></section><footer class='text-right'><a href='opmac-tricks.html#colaccent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0074</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-24'>06/24/2014</time></span> </footer></article> <article id='setrgbcolor' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Colors given in RGB</h3> <a href='#setrgbcolor'><i class='fas fa-link'></i></a></div></header><section><p>OPmac works internally in CMYK color space. How to change this internal commands to RGB is described in the following <a href='#rgb' title='OPmac trick 0090'>OPmac trick 0090</a>. Now, we have another aim: to give the possibility to the user to set colors in RGB coordinates, but keep the CMYK color space internal. For example </p><pre class='pr-3'><code>\def\Pink{\setRGBcolor{213 30 101}} 
or 
\def\Pink{\setrgbcolor{.835 .118 .396}} 
or 
\def\Pink{\setHEXcolor{D51E65}} 
</code></pre><p>All three cases above defines the same color which is realized internally as <code>\setcmykcolor{0 .859 .526 .165}</code>. </p><pre class='pr-3'><code>\def\setRGBcolor#1{\setRGBcolorA#1 } 
\def\setRGBcolorA#1 #2 #3 {\def\tmpb{}\tmpdim=0pt 
   \ifdim#1pt&gt;\tmpdim \tmpdim=#1pt \fi 
   \ifdim#2pt&gt;\tmpdim \tmpdim=#2pt \fi 
   \ifdim#3pt&gt;\tmpdim \tmpdim=#3pt \fi 
   \tmpnum=\expandafter\onedecimaldigit\the\tmpdim\relax \relax 
   \ifnum\tmpnum=0 \def\tmpb{0 0 0 1}\else 
      \setRGBcolorB{#1}\setRGBcolorB{#2}\setRGBcolorB{#3}% 
      \tmpdim=2550pt \advance\tmpdim by-\tmpnum pt \divide\tmpdim by2550 
      \edef\tmpb{\tmpb\expandafter\ignorept\the\tmpdim}\fi 
   \setcmykcolor\tmpb 
} 
\def\setRGBcolorB#1{\tmpdim=#1pt 
   \tmpdim=-\expandafter\onedecimaldigit\the\tmpdim\relax pt 
   \advance\tmpdim by\tmpnum pt \divide\tmpdim by\tmpnum 
   \edef\tmpb{\tmpb\expandafter\ignorept\the\tmpdim\space}% 
} 
\def\onedecimaldigit#1.#2#3\relax{#1#2} 
\def\setHEXcolor#1{\setHEXcolorA#1} 
\def\setHEXcolorA #1#2#3#4#5#6{\setRGBcolorA "#1#2 "#3#4 "#5#6 } 
\def\setrgbcolor#1{\setrgbcolorA#1 } 
\def\setrgbcolorA#1 #2 #3 {\def\tmpb{}\dimen0=255pt 
   \setrgbcolorB{#1}\setrgbcolorB{#2}\setrgbcolorB{#3}% 
   \expandafter\setRGBcolorA\tmpb 
} 
\def\setrgbcolorB#1{\tmpdim=#1\dimen0 
   \edef\tmpb{\tmpb\expandafter\ignorept\the\tmpdim \space}} 
\addprotect\setRGBcolor  \addprotect\setrgbcolor  \addprotect\setHEXcolor 
</code></pre><p>The <code>\setRGBcolor</code> macro does conversion from RGB to CMYK by the simple equations (i.e without ICC profiles): </p><p><code>K'=max(R,G,B),  C=(K'-R)/K', M=(K'-G)/K', Y=(K'-B)/K', K=(255-K')/255</code>. </p><p>The macro accepts first decimal digit in the <code>R, G, B</code> data. This is reason why the <code>\onedecimaldigit</code> macro is used and why the nominator in the calculation isn't 255 but 2550. </p><p>The <code>\setrgbcolor</code> macro multiplies the parameters by 255 and uses <code>\setRGBcolor</code>. The macro <code>\setHEXcolor</code> uses <code>"</code> character before parameters and uses <code>\setRGBcolor</code> too. </p></section><footer class='text-right'><a href='opmac-tricks.html#setrgbcolor' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0089</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-25'>01/25/2015</time></span> </footer></article> <article id='rgb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>RGB as internal color space</h3> <a href='#rgb'><i class='fas fa-link'></i></a></div></header><section><p>OPmac works internally in CMYK color space. The conversion from RGB to CMYK can be done by the previous <a href='#setrgbcolor' title='OPmac trick 0089'>OPmac trick 0089</a>. But sometimes arises the need to use RGB directly. For example because the document is intended only for computer monitors (i.e. RGB device) and this color space provides better gamut with dense colors. Another reason can be the fact that Inkscape exports the images in RGB only (unfortunately) and we need to harmonize the colors of these images with the colors of the text. </p><p>The colors can be defined by <code>\def\Pink{\setrgbcolor{.835 .118 .396}}</code>. </p><p>OPmac version Jul. 2019 defines <code>\setrgbcolor</code> already. The following code redefines <code>\setcmykcolor</code> in order to it converts CMYK to RGB internally used: </p><pre class='pr-3'><code>\def\setcmykcolor#1{\expandafter\setcmykcolorA#1 } 
\def\setcmykcolorA #1 #2 #3 #4 {\def\tmpb{}% 
   \tmpdim=1pt \advance\tmpdim by-#4pt 
   \edef\tmpa{\expandafter\ignorept\the\tmpdim}% 
   \setcmykcolorB{#1}\addto\tmpb{ }\setcmykcolorB{#2}\addto\tmpb{ }\setcmykcolorB{#3}% 
   \setrgbcolor\tmpb 
} 
\def\setcmykcolorB#1{\tmpdim=1pt \advance\tmpdim by-#1pt 
\tmpdim=\tmpa\tmpdim 
   \edef\tmpb{\tmpb\expandafter\ignorept\the\tmpdim}% 
} 
\def\setRGBcolor#1{\setRGBcolorA#1 } 
\def\setRGBcolorA#1 #2 #3 {\def\tmpb{}\setRGBcolorB{#1}\setRGBcolorB{#2}\setRGBcolorB{#3}% 
   \setrgbcolor\tmpb 
} 
\def\setRGBcolorB#1{\tmpdim=#1pt \divide\tmpdim by255 
   \edef\tmpb{\tmpb\expandafter\ignorept\the\tmpdim\space}% 
} 
</code></pre><p>The original <code>\setcmykcolor</code> macro is redefined in order to convert its arguments into RGB and to use the <code>\setrgbcolor</code>. The following equations are used: </p><p><code>R = (1-C)*(1-K),  G = (1-M)*(1-K), B = (1-Y)*(1-K)</code>. </p><p>Finally, the macro <code>\setRGBcolor</code> is defined. It divides its arguments by 255 and uses <code>\setrgbcolor</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#rgb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0090</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-25'>01/25/2015</time></span> </footer></article> <article id='cmixdef' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Color mixing like at painter's palette</h3> <a href='#cmixdef'><i class='fas fa-link'></i></a></div></header><section><p>The macro <code>\cmixdef\NewColor{linear combination of colors}</code> defines new color as linear combination of given colors. The name of the macro means "color mix define". Example: </p><pre class='pr-3'><code>\cmixdef\myCyan {.3\Green + .5\Blue}  % mix 30 % of green, 50 % of blue, the rest is white 
\cmixdef\myColor {.1\Blue + .4\Brown + .5\Yellow} 
\cmixdef\LightBlue {.6\Blue} % Light blue: 60 % of blue, the rest is white 
\cmixdef\DarkBlue {\Blue + .4\Black} % Blue mixed with 40 % of black 
</code></pre><p>The color mixing is processed at the addition color space CMYK. If the result has a&nbsp;component greater than 1&nbsp;then finally all components are multiplied by a&nbsp;coefficient in order to maximal componet is eqal to 1. If you need to emulate the painter's activity then the convex kombination is recommended, as in the second line of the example: one piece of blue, four pieces of brown and five pieces of yellow. But there isn't necessery to use convex combination: </p><pre class='pr-3'><code>\cmixdef\Blue{\Cyan + \Magenta} % really, the basic colors are from CMYK, but: 
\cmixdef\myBlue{.5\Cyan + .5\Magenta} is equal to \cmixdef\myBlue{.5\Blue}. 
</code></pre><p>You can use minus intead plus in the linear combination. The given color is substracted in such case and the negative components are rounded to zero immediately. For example </p><pre class='pr-3'><code>\cmixdef\Color{\Brown-\Black} 
</code></pre><p>can be used for removing black component from the color. Finally, you can use <code>^</code> immediately preceeded before macro name of the color. Then the complementary color is used here. </p><pre class='pr-3'><code>\cmixdef\mycolor{\Grey + .6^\Blue} the same as \cmixdef\mycolor{\Grey+.6\Yellow} 
</code></pre><p>The implementation: </p><pre class='pr-3'><code>\def\cmixdef#1#2{\bgroup 
   \let\setcmykcolor=\relax \edef\tmpb{+#2}% 
   \replacestrings{ }{}\replacestrings{+}{\addcolor}\replacestrings{-}{\addcolor-}% 
   \replacestrings{^\setcmykcolor}{\setcmykcolor^}% 
   \replacestrings{-\setcmykcolor}{-1\setcmykcolor}% 
   \def\C{0}\def\M{0}\def\Y{0}\def\K{0}% 
   \tmpb \checkcmyk 
   \xdef#1{\setcmykcolor{\C\space \M\space \Y\space \K}}% 
   \egroup 
} 
\def\addcolor#1\setcmykcolor#2{\def\tmp{}% 
   \tmpdim=\ifx$#1$1\else#1\fi pt 
   \ifx^#2\expandafter \addcolorC 
   \else \addcolorA#2 \fi 
} 
\def\addcolorA #1 #2 #3 #4 {% 
   \addcolorB\C{#1}n\addcolorB\M{#2}n\addcolorB\Y{#3}n\addcolorB\K{#4}k% 
} 
\def\addcolorB#1#2#3{\dimen0=#2\tmpdim 
   \ifx\tmp\empty\else 
      \ifx#3n\advance\dimen0 by\K\tmpdim \dimen0=-\dimen0 \advance\dimen0 by\tmpdim 
      \else \dimen0=0pt 
   \fi\fi 
   \advance\dimen0 by#1pt 
   \ifdim\dimen0&lt;0pt \def#1{0}\else \edef#1{\expandafter\ignorept\the\dimen0}\fi 
} 
\def\addcolorC#1{\def\tmp{^}\addcolorA#1 } 
 
\def\checkcmyk{\tmpdim=\C pt 
   \ifdim\M pt&gt;\tmpdim \tmpdim=\M pt \fi 
   \ifdim\Y pt&gt;\tmpdim \tmpdim=\Y pt \fi 
   \ifdim\K pt&gt;\tmpdim \tmpdim=\K pt \fi 
   \ifdim\tmpdim&gt;1pt %\tmpdim=1/\tmpdim: 
      \tmpnum=1073741824 \divide\tmpnum by\tmpdim \multiply\tmpnum by4 \tmpdim=\tmpnum sp 
      \checkcmykA\C \checkcmykA\M \checkcmykA\Y \checkcmykA\K 
   \fi 
} 
\def\checkcmykA#1{\dimen0=#1\tmpdim 
   \ifdim\dimen0&gt;1pt \def#1{1}\else \edef#1{\expandafter\ignorept\the\dimen0}\fi 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#cmixdef' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0105</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-24'>04/24/2015</time></span> </footer></article> <article id='normalcmyk' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>CMYK normalization</h3> <a href='#normalcmyk'><i class='fas fa-link'></i></a></div></header><section><p>The basic colors of CMYK should realize grey result if the same coefficent is used for <code>C</code>, <code>M</code> and <code>Y</code>. Especially full <code>C+M+Y</code> should be Black. (Of course we suppose ideal tonners, the reality is very dark brown.) The concequence is that if the <code>min(C,M,Y)</code> isn't zero then we can subtract this minimum from <code>C</code>, <code>M</code>, and <code>Y</code> and replace this by appropriate amount of K. The normalized CMYK includes coordinates where the above activity is done, so there is at least one <code>C, M, Y</code> component equal zero. The normalized CMYK saves the expensive color tonners and uses black tonner if this is possible. </p><p>The color mixing by <code>\cmixdef</code> from <a href='#cmixdef' title='previous OPmac trick'>previous OPmac trick</a> gives the un-normalized CMYK very often. We can normalize it by macro <code>\normalcmyk\Color</code>. For example: </p><pre class='pr-3'><code>\cmixdef\myColor{linear combination of colors} \normalcmyk\myColor 
</code></pre><p>The macro <code>\normalcmyk</code> replaces the <code>min(C,M,Y)</code> by <code>K</code>. This is done via the formulas for conversion to RGB (<a href='#rgb' title='OPmac trick 0090'>OPmac trick 0090</a>) and back using formulas for conversion from RGB to new normalized CMYK (<a href='#setrgbcolor' title='OPmac trick 0089'>OPmac trick 0089</a>). The implementation follows: </p><pre class='pr-3'><code>\def\normalcmyk#1{\bgroup \let\setcmykcolor=\relax 
   \edef\tmp{#1}\def\tmpa{#1}\expandafter\normalcmykA\tmp 
} 
\def\normalcmykA#1#2{\normalcmykB #2 } 
\def\normalcmykB#1 #2 #3 #4 {\tmpdim=#1pt 
   \ifdim#2pt&lt;\tmpdim \tmpdim=#2pt \fi  \ifdim#3pt&lt;\tmpdim \tmpdim=#3pt \fi 
   \ifdim\tmpdim=0pt \else 
      \ifdim\tmpdim&lt;1pt 
         \dimen2=\tmpdim % \dimen2=min(C,M,Y) 
         \tmpdim=-\tmpdim \advance\tmpdim by1pt \dimen1=\tmpdim % \dimen1 = 1-min 
         \tmpnum=1073741824 \divide\tmpnum by\tmpdim \multiply\tmpnum by4 \tmpdim=\tmpnum sp 
         \edef\tmp{\expandafter\ignorept\the\tmpdim}% \tmp = 1 / (1-min) 
         \normalcmykC\C{#1}\normalcmykC\M{#2}\normalcmykC\Y{#3}% 
         \dimen0=-#4\dimen2 \advance\dimen0 by\dimen2 \advance\dimen0 by#4pt 
         \edef\K{\expandafter\ignorept\the\dimen0}% K_new = 1 - (1-min)*(1-K_old) 
         \expandafter\xdef\tmpa{\setcmykcolor{\C\space\M\space\Y\space\K}}% 
      \else \expandafter\xdef\tmpa{0 0 0 1}% 
   \fi\fi \egroup 
} 
\def\normalcmykC#1#2{\ifdim\dimen2=#2pt \def#1{0}\else 
      \dimen0=\dimen1 % C_new = ((1-min) - (1-C_old)) / (1-min) 
      \advance\dimen0 by#2pt \advance\dimen0 by-1pt 
      \dimen0=\tmp\dimen0 \ifdim\dimen0&gt;1pt \dimen0=1pt \fi 
      \edef#1{\expandafter\ignorept\the\dimen0}% 
   \fi 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#normalcmyk' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0106</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-24'>04/24/2015</time></span> </footer></article> <article id='x11rgb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The declaration of color set from X11</h3> <a href='#x11rgb'><i class='fas fa-link'></i></a></div></header><section><p>The file <code>rgb.txt</code> from X11 includes the color names and their RGB declarations used in X&nbsp;window system. This set of color names and declarations are rewritten in LaTeX file <code>x11nam.def</code>. If we are able to read this file then about three hunderds color names from this file will be available like <code>\DeepPink</code>, <code>\Azure</code>, <code>\CadetBlue</code> etc. These names are in four variants in the file: varinat one is pure color, varaints 2, 3&nbsp;and 4&nbsp;are the color mixed with a&nbsp;grey. </p><p>We read the file <code>x11nam.def</code> in order to the colors with variant one have the direct name (i.e. instead <code>\Chocolate1</code> only <code>\Chocolate</code>) and the variant 2&nbsp;has the name with <code>B</code> added, variant 3&nbsp;with <code>C</code> added and variant 4&nbsp;with <code>D</code> added. For example: </p><pre class='pr-3'><code>\def\trycolor#1{{#1\vrule height10pt depth5pt width20pt}\kern2pt} 
\trycolor\DeepPink \trycolor\DeepPinkB \trycolor\DeepPinkC \trycolor\DeepPinkD 
</code></pre><p>creates the set of four ping rectangles, first with direct pink and next rectangles with pink mixed with grey. Note that <code>\DeepPinkA</code> color doesn't exist. </p><p>We can read the file <code>x11nam.def</code> by: </p><pre class='pr-3'><code>\long\def\tmp#1\preparecolorset#2#3#4#5{\tmpa #5;,,,;} 
\def\tmpa#1,#2,#3,#4;{\ifx,#1,\else 
   \def\tmpb{#1}\replacestrings{1}{}\replacestrings{2}{B}% 
   \replacestrings{3}{C}\replacestrings{4}{D}% 
   \expandafter\def\csname\tmpb\endcsname{\setrgbcolor{#2 #3 #4}}% 
   \expandafter\tmpa\fi 
} 
\expandafter\tmp\input x11nam.def 
</code></pre><p>Next, we must use OPmac trick <a href='#rgb' title='0090'>0090</a> for direct usage of RGB color space or OPmac trick <a href='#setrgbcolor' title='0089'>0089</a> for conversion from RGB to CMYK. </p></section><footer class='text-right'><a href='opmac-tricks.html#x11rgb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0108</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-05-01'>05/01/2015</time></span> </footer></article>
                            </section>  <section id="transformace" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Transformations</h2>
                                    <a href="#transformace"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='transformbox' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Transformed box with new bounding box calculated</h3> <a href='#transformbox'><i class='fas fa-link'></i></a></div></header><section><p>We create the macro <code>\transformbox{transformation}{contents of box}</code> which puts the linear-transformed <code>\hbox</code> into outer box. The dimensions of the outer box are correctly calculated. The origin of the transformation stays on the baseline of the new outer box. For example: </p><p><img src='img/cmelak-ukazka.png' alt='Sample bumble-bee' title='Sample bumble-bee' class='img-fluid rounded mx-auto my-2 d-block'> </p><pre class='pr-3'><code>\picw=5cm \transformbox{\pdfrotate{45}}{\inspic bumblebee.jpg } 
</code></pre><p>prints the picture rotated by 45 degrees. If (for example) the picture is square then the outer box will have height plus width equal to <code>5cm * sqrt(2)</code> and the depth is <code>0 cm</code>. </p><p>The lines are invisible in the real output, of course. Another example: </p><pre class='pr-3'><code>\transformbox{\pdfscale{2}{1.2}\pdfrotate{-30}}{Box} 
</code></pre><p>creates a&nbsp;box of width, height and depth as in the following sketch: </p><p><img src='img/box-ukazka.png' alt='Box example' title='Box example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>It is possible to define rotating of box like <code>\rotbox{angle}{contents}</code> simply by the following code: </p><pre class='pr-3'><code>\def\rotbox#1#2{\transformbox{\pdfrotate{#1}}{#2}} 
</code></pre><p>The macro <code>\transformbox</code> id defined: </p><pre class='pr-3'><code>\newdimen\vvalX \newdimen\vvalY 
\newdimen\newHt \newdimen\newDp \newdimen\newLt \newdimen\newRt 
\let\oripdfsetmatrix=\pdfsetmatrix 
 
\def\multiplyMxV #1 #2 #3 #4 {% matrix * (vvalX, vvalY) 
   \tmpdim = #1\vvalX \advance\tmpdim by #3\vvalY 
   \vvalY  = #4\vvalY \advance\vvalY  by #2\vvalX 
   \vvalX = \tmpdim 
} 
\def\multiplyMxM #1 #2 #3 #4 {% currmatrix := currmatrix * matrix 
   \vvalX=#1pt \vvalY=#2pt \expandafter\multiplyMxV \currmatrix 
   \edef\tmpb{\expandafter\ignorept\the\vvalX\space \expandafter\ignorept\the\vvalY}% 
   \vvalX=#3pt \vvalY=#4pt \expandafter\multiplyMxV \currmatrix 
   \edef\currmatrix{\tmpb\space 
      \expandafter\ignorept\the\vvalX\space \expandafter\ignorept\the\vvalY\space}% 
} 
\def\transformbox#1#2{\hbox{\setbox0=\hbox{#2}\preptransform{#1}% 
   \kern-\newLt \vrule height\newHt depth\newDp width0pt 
   \setbox0=\hbox{\box0}\ht0=0pt \dp0=0pt \pdfsave#1\rlap{\box0}\pdfrestore \kern\newRt}% 
} 
\def\preptransform #1{\def\currmatrix{1 0 0 1 }% 
   \def\pdfsetmatrix##1{\edef\tmpb{##1 }\expandafter\multiplyMxM \tmpb\unskip}#1% 
   \setnewHtDp 0pt  \ht0  \setnewHtDp 0pt  -\dp0 
   \setnewHtDp \wd0 \ht0  \setnewHtDp \wd0 -\dp0 
   \let\pdfsetmatrix=\oripdfsetmatrix 
} 
\def\setnewHtDp #1 #2 {% 
   \vvalX=#1\relax \vvalY=#2\relax \expandafter\multiplyMxV \currmatrix 
   \ifdim\vvalX&lt;\newLt \newLt=\vvalX \fi \ifdim\vvalX&gt;\newRt \newRt=\vvalX \fi 
   \ifdim\vvalY&gt;\newHt \newHt=\vvalY \fi \ifdim-\vvalY&gt;\newDp \newDp=-\vvalY \fi 
} 
</code></pre><p>The matrix arithmetic is implemented here and it is applied on currentmatrix. The <code>\pdfsetmatrix</code> is redefined while <code>\pretransform</code> processing: the currentmatrix is not set but only calculated. The calculated matrix is multiplied by four points -- vertices of the box before transformation. The results are four vertices of the transformed box. We use them for the calculation of the new dimensions of the outer box <code>\newHt</code>, <code>\newDp</code> and the left side <code>\newLt</code> and right side <code>\newRt</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#transformbox' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0046</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-07'>04/07/2014</time></span> </footer></article> <article id='rotsimple' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Rotated box by 90 degrees</h3> <a href='#rotsimple'><i class='fas fa-link'></i></a></div></header><section><p>The need of rotating the typesetting material to 90 or -90 degrees is very common and usually we needn't nothing more. If we needn't to specify another angle then we needn't to use complicated macro <code>\rotbox</code> from <a href='#transformbox' title='previous OPmac trick'>previous OPmac trick</a> and a&nbsp;simple macro <code>\rotsimple</code> is sufficient. Usage: </p><pre class='pr-3'><code>\rotsimple{90}\hbox{contents of the rotated box} 
or 
\rotsimple{-90}\vbox to\hsize{...} 
</code></pre><p>The implementation: </p><pre class='pr-3'><code>\def\rotsimple#1{\hbox\bgroup\def\tmpb{#1}\afterassignment\rotsimpleA \setbox0=}% 
\def\rotsimpleA{\aftergroup\rotsimpleB} 
\def\rotsimpleB{\setbox0=\hbox{\box0}% 
   \ifnum\tmpb&gt;0 \kern\ht0 \tmpdim=\dp0 \else \kern\dp0 \tmpdim=\ht0 \fi 
   \vbox to\wd0{\ifnum\tmpb&gt;0 \vfill\fi 
                \wd0=0pt \dp0=0pt \ht0=0pt 
                \pdfsave\pdfrotate{\tmpb}\box0 \pdfrestore 
                \vfil}% 
   \kern\tmpdim 
   \egroup} 
</code></pre><p>Note that this macro puts the whole width of the rotated box to the height of the new box without reference to the parameter 90 or -90 degrees. This is a&nbsp;difference with regard to the <code>\rotbox</code> macro from <a href='#transformbox' title='previous OPmac trick'>previous OPmac trick</a> where the box contents is put to the depth of the new box if rotating is done by negative angle. </p><p>If you need to rotate around the center of the box, you can use </p><pre class='pr-3'><code>\rotsimple{90}\hbox to0pt{\hss contents of the rotated box\hss} 
</code></pre><p>Of course, the rotated text is overlapped upwards and downwards, but this doesn't matter in typical applications. </p></section><footer class='text-right'><a href='opmac-tricks.html#rotsimple' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0101</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-18'>04/18/2015</time></span> </footer></article> <article id='shbox' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Scaling box to desired size</h3> <a href='#shbox'><i class='fas fa-link'></i></a></div></header><section><p>We create macros </p><pre class='pr-3'><code>\shbox to dimen{text} 
\svbox to dimen{text} 
</code></pre><p>which behaves similar as <code>\hbox</code> to <code>dimen{text}</code> and <code>\vbox</code> to <code>dimen{text}</code>, but there is a&nbsp;difference: the box is composed without stretching or shrinking inside with only base size. Finally the linear scaling of whole box to the desired size (to the with for <code>\hbox</code> or to the height for <code>\vbox</code>) is processed. </p><p>The implementation can be: </p><pre class='pr-3'><code>\def\shbox to#1#{\sboxA\hbox\wd{#1}} 
\def\svbox to#1#{\sboxA\vbox\ht{#1}} 
\def\sboxA#1#2#3#4{#1to#3{% 
   \setbox0=#1{#4}\tmpdim=#3\relax \tmpnum=#20 
   \divide\tmpnum by256 \divide\tmpdim by\tmpnum \multiply\tmpdim by256 
   \edef\tmp{\expandafter\ignorept\the\tmpdim}% 
   \ifx#1\hbox \vrule height\tmp\ht0 depth\tmp\dp0 width0pt 
   \else \hrule width\tmp\wd0 height0pt \tmpdim=\dp0 \fi 
   \ht0=0pt \dp0=0pt \wd0=0pt \pdfsave\pdfscale{\tmp}{\tmp}\box0\pdfrestore 
   \ifx#1\hbox\hfil 
   \else \vfil \hrule height0pt width0pt depth\tmp\tmpdim \fi}% 
} 
</code></pre><p>First, the box0 is created and the ratio desired:real size is calculated and saved to the <code>\tmp</code>. Then the <code>\pdfscale</code> is used and the box is put to the outer box with dimensions created by invisible <code>\hrule</code>, <code>\vrule</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#shbox' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0104</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-23'>04/23/2015</time></span> </footer></article> <article id='sipky' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Curved arrows</h3> <a href='#sipky'><i class='fas fa-link'></i></a></div></header><section><p>We prepare the macro </p><pre class='pr-3'><code>\arrowcc x0 y0 {cx0 cy0 cx1 cy1} x1 y1 (dx1 dy1) {Text} 
</code></pre><p>which draw the curve from <code>x0 y0</code> to <code>x1 y1</code> ended by arrow spike. The part <code>{cx0 cy0 cx1 cy1}</code> can be empty, i. e. <code>{}</code>. The line is drawn in such case. The numbers <code>{cx0 cy0 cx1 cy1}</code> gives the control points of a&nbsp;Bézier curve. At the end of the arrow is printed the "Text" shifted by <code>xd1 dy1</code>. The numbers <code>cx0 cy0 cx1 cy1 x1 y1</code> are relative to the origin <code>x0 y0</code>. This origin is relative to the current typesetting point. All numbers are in <code>bp</code> units by default. The macro <code>\arrowccparams</code> can include the additional settings (color, line width, etc.). The macro <code>\arrowccspike</code> includes the drawing of the arrow spike and you can redefine it. </p><pre class='pr-3'><code>\vglue5cm 
\def\arrowccparams{1 0 0 rg 1 0 0 RG}  % red color is initialized 
 
Pokus \arrowcc 0 10 {-30 20 -30 50} 20 50 (3 -3) {Text 1} 
dále \arrowcc 0 -3 {} 40 -30 (3 -3) {Text 2} 
a ještě \arrowcc 0 2 {10 20 20 30} 40 40 (3 -2) {Text 3}. 
</code></pre><p>creates: </p><p><img src='img/sipky-ukazka.png' alt='Arrows example' title='Arrows example' class='img-fluid rounded mx-auto my-2 d-block'> </p><pre class='pr-3'><code>\def\arrowccspike{2 0 m -5 2 l -5 -2 l h f} 
\def\arrowcc #1 #2 #3 #4 #5 (#6)#7{% 
   % x0 y0 {cx1 cy1 cx2 cy2} x1 y1 (dx1 dy1) {Text} 
   \pdfsave\rlap{\pdfliteral{% 
   .7 w \arrowccparams\space 1 0 0 1 #1 #2 cm 0 0 m 
   \if ^#3^#4 #5 l \else #3 #4 #5 c \fi S 1 0 0 1 #4 #5 cm}% 
   \if^#3^\calculateargofvector(0 0) (#4 #5)\else \preparedirection #3 (#4 #5)\fi 
   \pdfsave\pdfrotate{\argofvector}\pdfliteral{\arrowccspike}\pdfrestore 
   \if^#7^\else\pdfliteral{1 0 0 1 #6 cm}\hbox{#7}\fi}\pdfrestore 
} 
\def\preparedirection #1 #2 #3 #4 {\calculateargofvector(#3 #4) } 
\def\arrowccparams{} 
</code></pre><p>The macro uses low level PDF commands for graphics and the calculation of the direction from <a href='#argofvector' title='OPmac trick 0061'>OPmac trick 0061</a>. </p></section><footer class='text-right'><a href='opmac-tricks.html#sipky' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0062</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-24'>05/24/2014</time></span> </footer></article> <article id='cancel' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Canceled text</h3> <a href='#cancel'><i class='fas fa-link'></i></a></div></header><section><p>The macro <code>\cancel type {text}</code> prints text and the line over the text. If the type is <code>/</code> then the line is slanted from bottom left to top right. If the type is <code>\\</code> then the line is drawn from top left to bottom right. If the type is <code>X</code> or <code>x</code> then both lines are drawn. For example </p><pre class='pr-3'><code>\cancel /{Tady je text} 
\cancel X {U} 
</code></pre><p>creates first two lines of the following result: </p><p><img src='img/cancel-ukazka.png' alt='Cancel example' title='Cancel example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The <code>\cancel</code> macro is implemented by the code: </p><pre class='pr-3'><code>\def\cancel#1#2{\setbox0=\hbox{#2}% 
   \dimen0=.9963\wd0  \dimen1=.9963\ht0 \advance\dimen1 by.9963\dp0 
   \hbox{\rlap{#2}\vbox to0pt{\kern\dp0 \csname cancel:\string#1\endcsname \vss}\kern\wd0}% 
} 
\def\cancelB#1{\expandafter\ignorept\the\dimen#1 } 
\sdef{cancel:x}{\pdfliteral{q 0.4 w 1 J \cancelcolor\space 0 0 m \cancelB0 \cancelB1 l 
                            0 \cancelB1 m \cancelB0 0 l S Q}} 
\expandafter\let\csname cancel:X\expandafter\endcsname \csname cancel:x\endcsname 
\sdef{cancel:/}{\pdfliteral{q 0.4 w 1 J \cancelcolor\space 0 0 m \cancelB0 \cancelB1 l S Q}} 
\sdef{cancel:\string\\}{\pdfliteral{q 0.4 w 1 J \cancelcolor\space 0 \cancelB1 m \cancelB0 0 l S Q}} 
\def\cancelcolor{1 0 0 RG} 
</code></pre><p>If we want to cancel by arrow (see the last line in the example) then we can use the <code>\cancel</code> macro with the type <code>^</code> (slanted up) or <code>_</code> (slanted down). The last line in the example was created by <code>\cancel_{Slanted down}</code>. </p><p>The macro <code>\arrowcc</code> from previous <a href='#sipky' title='OPmac trick 0062'>OPmac trick 0062</a> is used here. </p><pre class='pr-3'><code>\sdef{cancel:^}{\arrowcc 0 0 {} \cancelB0 \cancelB1 (0 0) {}} 
\sdef{cancel:_}{\arrowcc 0 \cancelB1 {} \cancelB0 -\cancelB1 (0 0) {}} 
\def\arrowccparams{1 0 0 rg 1 0 0 RG .4 w 1 J}  % red arrow 
\def\arrowccspike{4 0 m -.3 1 l -.3 -1 l h f} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#cancel' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0082</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-12-19'>12/19/2014</time></span> </footer></article> <article id='circletext' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Text around a circle</h3> <a href='#circletext'><i class='fas fa-link'></i></a></div></header><section><p>We create a&nbsp;macro <code>\circletext {radius}{angle}{TEXT}{correction}</code> which prints TEXT around a&nbsp;circle with given <code>radius</code>. First letter of the TEXT starts at given angle. The fourth parameter declares a&nbsp;corrections between letter pairs because the standard kerning table is deactivated when printing around circle. The TEXT runs clockwise when the <code>radius</code> is positive (the center of the circle is below the letters). When the <code>radius</code> parameter is negative then TEXT runs anticlockwise and the center of the circle is above the letters. The macro creates a&nbsp;typesetting material with zero dimensions, the center of the circle is at the actual typesetting point. For example </p><p><img src='img/uni-ukazka.png' alt='Circle example' title='Circle example' class='img-fluid rounded mx-auto my-2 d-block'> </p><pre class='pr-3'><code>\hbox{% 
\circletext {1.7cm} {212}  {{$\bullet$} UNIVERSITAS CAROLINA PRAGENSIS {$\bullet$}} 
                           {\spaceskip=.5em \kpcirc TA{-.1}\kpcirc NA{-.05}} 
\circletext {-1.7cm} {237} {Facultas MFF} 
                           {\kpcirc Fa{-.1}} 
} 
</code></pre><p>The fourth parameter <code>correction</code> can include the declaration of word space (using <code>\spaceskip=...</code>) and the space corrections between declared pairs of letters using <code>\kpcirc AB{num}</code>: the <code>\kern num</code> (in <code>em</code> units) is inserted between each pair of letters AB. Note that the example includes the "composed object" <code>$\bullet$</code>. Such object must be enclosed by braces. </p><p>The letterspacing can be set by <code>\def\circletextS{\kern value}</code>. The zero letterspacing is set by default. </p><p>The <code>\circletext</code> macro can be defined by: </p><pre class='pr-3'><code>\newdimen\tmpdimA 
\def\circletext#1#2#3#4{\hbox\bgroup 
    \tmpdim=14668pt \tmpdimA=#1 \divide\tmpdimA by256 \divide\tmpdim by\tmpdimA 
    \edef\tmpC{\expandafter\ignorept\the\tmpdim}% \tmpC=(180/pi)/R 
    \setbox0=\hbox{\ifdim#1&lt;0pt X\fi}% lap letters by X height if R&lt;0 
    \tmpdimA=0pt \baselineskip=#1 \advance\baselineskip by-\ht0 \lineskiplimit=-\maxdimen 
    \tmpdim=#2pt \advance\tmpdim by-\ifdim#1&lt;0pt-\fi 90pt 
    \def\tmpb{{}#3}\replacestrings{ }{{ }}#4% spaces =&gt; {spaces} 
    \pdfsave \pdfrotate{\expandafter\ignorept\the\tmpdim}% 
    \expandafter\circletextA\tmpb\relax 
} 
\def\circletextA#1{\ifx#1\relax\pdfrestore\egroup\ignorespaces\else 
    \ifx^#1^\else \setbox0=\hbox{#1\circletextS}% 
       \ifdim\tmpdimA=0pt \else 
          \advance\tmpdimA by.5\wd0 \dimen0=\tmpC\tmpdimA 
          \pdfrotate{-\expandafter\ignorept\the\dimen0}% 
       \fi 
       \tmpdimA=.5\wd0 
       \vbox to0pt{\vss\hbox to0pt{\hss#1\hss}\null}% 
    \fi 
    \expandafter\circletextA\fi 
} 
\def\kpcirc#1#2#3{\replacestrings{#1#2}{#1{\kern#3em}#2}} 
\def\circletextS{} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#circletext' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0109</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-06-01'>06/01/2015</time></span> </footer></article> <article id='nopt' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Modification of \ignorept macro and new \nopt macro</h3> <a href='#nopt'><i class='fas fa-link'></i></a></div></header><section><p>We need to use \ignorept macro very often when \pdfliteral is used. We can minimize the output code (in PDF) when <code>ignorept</code> is re-defined: </p><pre class='pr-3'><code>\begingroup \lccode`\?=`\p \lccode`\!=`\t \lowercase{\endgroup 
   \def\ignorept #1.#2?!{% Print minimized point value 
       \ifnum#2=0 #1\else \ifnum#1=0 \expandafter\remzero\fi #1.#2\fi} 
} 
\def\remzero #10{#1}% Remove zero and leave minus if present 
</code></pre><p>All work is done at expand processor level and numbers are in reduced form. </p><p>We can define <code>\nopt[param]</code> macro which keeps the space after usage of such macro and enables to use calculations in parameter, for example <code>\nopt[1.65\hoffset + 1in]</code> generates appropriate number in the <code>\pdfliteral</code> argument. </p><pre class='pr-3'><code>\def\nopt[#1]{\expandafter\ignorept\the\dimexpr #1\relax} 
</code></pre><p>For example, the code in <a href='#podklad' title='OPmac trick 0021'>OPmac trick 0021</a> can look like: </p><pre class='pr-3'><code>\def\prepghook{\dimen0=.996264truein  
  \pdfliteral{q \bgcolor\space k -0.996264 0 0 0.996264 -\nopt[\dimen0] \nopt[\dimen0] cm  
  \nopt[\hoffset] \nopt[\voffset] -\nopt[\pdfpagewidth] -\nopt[\pdfpageheight] re f Q}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#nopt' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0169</span> <span class='badge badge-info'>Author: Petr Krajník</span> <span class='badge badge-info'>Published <time datetime='2019-06-23'>06/23/2019</time></span> </footer></article>
                            </section>  <section id="stranka" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Page</h2>
                                    <a href="#stranka"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='headline' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Running heads</h3> <a href='#headline'><i class='fas fa-link'></i></a></div></header><section><p>OPmac doesn't implement the running heads because this is a&nbsp;part of design of the document and OPmac doesn't solve design. Additional macros have to be used. But the <code>\mark</code> primitive with the title of section is used by <code>\sec</code> macro, so we can use this in running head by <code>\firstmark</code> or something similar. For example the following code adds titles of chapters to the head of even pages and titles of sections to the head of odd pages. We needn't second type of <code>\mark</code> because chapters starts the new page every time. The page where a&nbsp;chapter begins has empty head. </p><pre class='pr-3'><code>\edef\oriheadline{\the\headline} 
\def\printchap#1{\vfil\break 
   \headline={\oriheadline\hfil\global\headline={\oriheadline\printheadline}} 
   \xdef\headchap{\ifnonum\else\thechapnum. \fi}\global\addto\headchap{#1} 
   {\chapfont \noindent \mtext{chap} \dotocnum{\thetocnum}\par 
    \nobreak\smallskip\noindent #1\nbpar}\mark{}% 
   \nobreak \remskip\bigskipamount \firstnoindent 
} 
\def\printheadline{\lower4pt\null\vadjust{\hrule}\tenit\thefontsize[10] 
   \ifodd\pageno \hfill\firstmark \else \headchap\hfill \fi} 
</code></pre><p>This code keeps original <code>\headline</code> in <code>\oriheadline</code> (it is used by OPmac for DRAFT marks when <code>\draft</code> mode is activated). The macro <code>\printchap</code> is rewritten here and the second and third line of code is added. The head preparation is done here. The title of the chapter is saved to <code>\headchap</code> (the expanded number but unexpanded title text). The head is printed by <code>\printhead</code> macro. </p></section><footer class='text-right'><a href='opmac-tricks.html#headline' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0020</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-30'>08/30/2013</time></span> </footer></article> <article id='podklad' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Background image on each page</h3> <a href='#podklad'><i class='fas fa-link'></i></a></div></header><section><p>This trick is possible to use for every document types but the slides can use it probably very frequent. We can prepare the background image (by an external graphics editor) and save it to the background.pdf file. This image can be inserted to every page by the following code: </p><pre class='pr-3'><code>\def\prepghook{\vbox to0pt{\kern-\voffset\kern-1in 
   \hbox to0pt{\kern-\hoffset\kern-1in\background\hss}\vss}% 
   \nointerlineskip 
} 
\pdfximage width\pdfpagewidth height\pdfpageheight {background.pdf} 
\mathchardef\picbackground=\pdflastximage 
\def\background{\pdfrefximage\picbackground} 
</code></pre><p>The <code>\background</code> is placed exactly to the left up corner of the paper using <code>\prepghook</code> macro (available from OPmac May 2015). </p><p>The image is loaded by <code>\pdfximage</code> and the right dimensions are set. The image is referenced by <code>\picbackground</code> constant and the image is placed to the page by this reference. This doesn't add new data with the image at every page and the PDF file size is minimized. </p><p>If you need to set only solid background color to each page then you needn't to create a&nbsp;background image. The usage of <code>\pdfliteral</code> is sufficient: </p><pre class='pr-3'><code>\def\prepghook{\pdfliteral{q \bgcolor\space k -0.996264 0 0 0.996264 -72 72 cm 
  \nopt{\hoffset} \nopt{\voffset} -\nopt{\pdfpagewidth} -\nopt{\pdfpageheight} re f Q}} 
\def\nopt#1{\expandafter\ignorept\the#1} 
 
\def\setbasecolor#1{#1\expandafter\setbasecolorA#1\pdfblackcolor} 
\def\setbgcolor#1{\expandafter\setbasecolorA#1\bgcolor} 
\def\setbasecolorA#1#2#3{\def#3{#2}} 
 
\setbasecolor\Yellow 
\setbgcolor\Blue 
 
Hello. Here is yellow text on blue background. 
</code></pre><p>If you plan to use <code>\magnification</code> or <code>\magscale</code> in your document then you must to replace the numbers <code>-72 72</code> by re-calculated values of one inch: </p><pre class='pr-3'><code>\def\prepghook{\dimen0=.996264truein 
  \pdfliteral{q \bgcolor\space k -0.996264 0 0 0.996264 -\nopt{\dimen0 } \nopt{\dimen0 } cm 
  \nopt{\hoffset} \nopt{\voffset} -\nopt{\pdfpagewidth} -\nopt{\pdfpageheight} re f Q}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#podklad' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0021</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-30'>08/30/2013</time></span> </footer></article> <article id='maybebreak' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The page/line break only if there is small space to the end of page/line</h3> <a href='#maybebreak'><i class='fas fa-link'></i></a></div></header><section><p>PlainTeX provides <code>\vfil\break</code> for page breaks. If the authors use this in order to “improve” their documents and the document contents is changed late then bad page breaks occur, for example almost empty pages can be printed. The macro <code>\maybebreak dimen</code> can be used instead of <code>\vfil\break</code> (for example <code>\maybebreak2cm</code>). The page is broken here if the space to the bottom is approximately less than dimen. If there is more space then the macro does nothing. </p><p>The macro <code>\maybebreak</code> processes the line breaks in horizontal mode and page breaks in the vertical mode. If you need to be sure that page break is processed then type: </p><pre class='pr-3'><code>\par\maybebreak 3.5cm 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#maybebreak' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0058</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-12'>05/12/2014</time></span> </footer></article> <article id='sloupce' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Columns like in news paper</h3> <a href='#sloupce'><i class='fas fa-link'></i></a></div></header><section><p>The typesetter can load the articles into boxes by: </p><pre class='pr-3'><code>\setbox\articleA=\vbox{\hsize=column width \penalty0 \input articleA.tex } 
\setbox\articleB=\vbox{\hsize=column width \penalty0 \input articleB.tex } 
... 
</code></pre><p>He can split these articles to the columns and inserts them to the pages by the given page design by <code>\vsplit</code> and by <code>\hbox/\vbox/\vtop</code> arithmetic. This idea is described in TBN, page 275 and it is reinvented here in order to keep the line grid. For example three columns typesetting including image across more columns (<a href='sloupce.pdf' title='see the example here'>see the example here</a>) can be programmed by the code: </p><pre class='pr-3'><code>\ulamuj\articleA 
\hbox{\ulom[18]\kern\colsep 
      \vtop{\hbox {\ulom[3]\kern\colsep \ulom[3]} 
      \vynech[13] \placepic[0pt,\twocols,\picw=9cm]{sheep1.jpg} 
      \hbox {\ulom[2]\kern\colsep \ulom[2]} 
      }} 
</code></pre><p>The macro <code>\ulom</code> means “split” and <code>\vynech</code> means “skip”. These macros read their parameter [the number of lines] in the square brackets. The reader read all text above the image (in the second and third column) and then he/she continues reading below the image. If we need another reading schema (all text in the column regardless of the existence of the image) then the programme for the columns structure can look like: </p><pre class='pr-3'><code>\hbox{\ulom[21]\kern\colsep 
      \vtop{\ulom[3]% 
            \vynech[14] \placepic[0pt,\twocols,\picw=10.5cm]{sheep2.jpg} 
            \ulom[4]}\kern\colsep 
      \vtop{\ulom[3]\vynech[14]\ulom[4]}% 
     } 
</code></pre><p>The macro <code>\ulamuj</code> (do splitting) prepares the article for splitting. The <code>\ulom</code> splits the lines by <code>\vsplit</code> primitive and calculates the depth of the last line by <code>\lastbox</code> trick (see TBN page 450). This depth is saved ti <code>\lastdepth</code>. If the <code>\ulom</code> is used in horizontal mode, for example <code>\hbox{\ulom[9]\ulom[9]\ulom[9]}</code>, then the <code>\lastdepth</code> includes the maximal depth of all columns here. The <code>\vynech</code> macro (skip) uses the <code>\lastdepth</code> parameter. </p><pre class='pr-3'><code>\tmpdim=\baselineskip  \splittopskip=\tmpdim plus.1pt minus.1pt 
\def\ulom[#1]{\setbox0=\vsplit\wholebox to #1\baselineskip 
   \vtop{\kern-.3\baselineskip \unvbox0 
         \nointerlineskip\lastbox \global\lastdepth=\prevdepth}% 
   \ifhmode \ifdim\lastdepth&lt;\maxhdepth \global\lastdepth=\maxhdepth \fi 
            \maxhdepth=\lastdepth \fi 
} 
\def\ulamuj#1{\let\wholebox=#1\setbox0=\vsplit\wholebox to0pt} 
\def\vynech[#1]{\vskip-.7\baselineskip\vskip#1\baselineskip \prevdepth=\lastdepth} 
</code></pre><p>The complete code including the declaration part and including the definition of the macro </p><pre class='pr-3'><code>\placepic[vertical shift, box width, before \inspic] {imagefile.extension} 
</code></pre><p>which inserts the picture without inserting space is available in the <a href='sloupce.tex' title='separate file'>separate file</a>. </p></section><footer class='text-right'><a href='opmac-tricks.html#sloupce' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0076</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-07-28'>07/28/2014</time></span> </footer></article> <article id='crop' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Crop marks</h3> <a href='#crop'><i class='fas fa-link'></i></a></div></header><section><p>We prepare the macro <code>\cropmark</code> which adds crop mark to the page and cooperates with the <code>\margins</code> macro. For example </p><pre class='pr-3'><code>\sdef{pgs:spec}{(150,170)mm} 
\margins/1 spec (7,7,7,7)mm \cropmarks 
</code></pre><p>This example declares the page dimension <code>150x170mm</code> with the margins <code>7mm</code>. The <code>\cropmarks</code> sequence enlarges the page at all four sides by <code>10mm</code> and prints the crop marks in this new margins. It is possible use the declaration above followed by </p><pre class='pr-3'><code>\margins/1 a4 (,,,)mm \cropcenter 
</code></pre><p>which keeps the crop marks on their place but all is centered in the A4 page. </p><p>The implementation: </p><pre class='pr-3'><code>\newdimen\cropw \cropw=10mm 
\def\ltcrop{\vbox{\hbox to\cropw{\hfil\vrule height\cropw depth-.2\cropw} 
                  \hbox to\cropw{\vrule height.4pt width.8\cropw \hfil}}} 
\def\rtcrop{\vbox{\hbox to\cropw{\vrule height\cropw depth-.2\cropw\hfil} 
                  \hbox to\cropw{\hfil\vrule height.4pt width.8\cropw}}} 
\def\lbcrop{\vbox{\hbox to\cropw{\vrule height.4pt width.8\cropw \hfil} 
                  \kern.2\cropw \hbox to\cropw{\hfil\vrule height.8\cropw}}} 
\def\rbcrop{\vbox{\hbox to\cropw{\hfil\vrule height.4pt width.8\cropw} 
                  \kern.2\cropw \hbox to\cropw{\vrule height.8\cropw\hfil}}} 
 
\newdimen\lmar \newdimen\tmar \tmar=1truein \lmar=1truein 
\def\cropmarks{% 
   \ifx\cropwidth\undefined 
      \advance\lmar by\hoffset \advance\tmar by\voffset 
      \hoffset=-1truein \voffset=-1truein 
      \advance\pdfpagewidth by2\cropw \advance\pdfpageheight by2\cropw 
      \dimen0=\pgwidth \advance\dimen0 by2\cropw \edef\cropwidth{\the\dimen0}% 
      \edef\cropheight{\the\pgheight} 
      \let\shipoutori=\shipout 
      \def\shipout##1 {\shipoutori % \opmacoutput uses \shipout\box0 
         \vbox{\let\vrule=\orivrule \let\hrule=\orihrule 
               \offinterlineskip \kern.2pt 
               \hbox to\cropwidth{\kern.2pt\ltcrop\hfil\rtcrop\kern.2pt}% 
               \kern-.2pt 
               \vbox to\cropheight{\kern\tmar\hbox{\kern\cropw\kern\lmar\box0}\vss} 
               \kern-.2pt 
               \hbox to\cropwidth{\kern.2pt\lbcrop\hfil\rbcrop\kern2.pt}}}% 
   \else\errmessage{\noexpand\cropmarks can't by used twice}\fi 
} 
\def\cropcenter{\advance\hoffset by-\lmar \advance\hoffset by-\cropw 
                \advance\voffset by-\tmar \advance\voffset by-\cropw} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#crop' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0081</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-12-16'>12/16/2014</time></span> </footer></article> <article id='nopageno' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>No page numbers in one-page documents</h3> <a href='#nopageno'><i class='fas fa-link'></i></a></div></header><section><p>The page number on the one-page document is pointless. But we often do not know wether a&nbsp;short document will have one or more pages. The following macro prints page numbers to the document if and only if the document contains more than one page. </p><pre class='pr-3'><code>\openref\ifnum\lastpage=1\footline{\hss}\fi 
</code></pre><p>We must run TeX two times. </p><p>I&nbsp;use this trick when I&nbsp;write one/two pages of peer review. </p></section><footer class='text-right'><a href='opmac-tricks.html#nopageno' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0133</span> <span class='badge badge-info'>Author: Jan Šustek</span> <span class='badge badge-info'>Published <time datetime='2015-12-19'>12/19/2015</time></span> </footer></article> <article id='outbox' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Little pages with sizes given by box</h3> <a href='#outbox'><i class='fas fa-link'></i></a></div></header><section><p>We create a&nbsp;macro <code>\outbox</code> which creates a&nbsp;page with following box in the PDF output immediately. Sizes of the page (medium sizes) will be the same as sizes of given box (plus margins). The margins can be declared by <code>\outboxmargins(left,right,top,bottom)unit</code> macro. default values of margins are 1pt for all sides. For example: </p><pre class='pr-3'><code>\outboxmargins(1,1,2,2)pt 
 
\outbox\hbox{text}      % creates a little page with "text" 
                        % and with given margins. 
\outbox\vbox{paragraph} % creates a page with given paragraph. 
</code></pre><p>The implementation follows </p><pre class='pr-3'><code>\def\outbox{\afterassignment\outboxA \setbox0=} 
\def\outboxA{\aftergroup\outboxC} 
\def\outboxC{\setbox0=\outboxB 
   \begingroup 
      \hoffset=-1in \voffset=-1in 
      \pdfpagewidth=\wd0 \pdfpageheight=\ht0 
      \shipout\box0 
   \endgroup 
} 
\def\outboxmargins (#1,#2,#3,#4)#5 {\def\outboxB{% 
   \vbox{\kern#3#5\hbox{\kern#1#5\box0 \kern#2#5}\kern#4#5}}% 
} 
\outboxmargins (1,1,1,1)pt 
</code></pre><p>The <code>\outbox</code> macro sets box0 and runs <code>\outboxC</code>. This is done via itermediate <code>\outboxB</code>, see TBN page 338 for reasons. The <code>\outboxC</code> macro re-boxes the box0: adds the margins using <code>\outboxB</code> macro which is defined by <code>\outboxmargins</code>. Then the media size <code>\pdfpagewidth</code> and <code>\pdfpageheight</code> are set to sizes of the box and box is put to the page using <code>\shipout</code>. This circumvents the <code>\output</code> routine. </p></section><footer class='text-right'><a href='opmac-tricks.html#outbox' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0147</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-05-16'>05/16/2017</time></span> </footer></article>
                            </section>  <section id="verbatim-prostredi" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Verbatim</h2>
                                    <a href="#verbatim-prostredi"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='loctt' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Local tthook</h3> <a href='#loctt'><i class='fas fa-link'></i></a></div></header><section><p>When we type <code>\def\tthook{code}</code> then such definition is global and changes all following <code>\begtt...\endtt</code> environments. But we need to type the codes which affects only the following <code>\begtt...\endtt</code>. </p><p>The solution uses two registers of toks type: <code>\gtthook</code> (includes global code) and \ltthook (code only for the following verbatim environment). The user can type, for example: </p><pre class='pr-3'><code>\gtthook {\typosize[9/11]}    % all verbatim in 9pt size 
\ltthook {\adef!#1.{{\it#1}}} % active ! only for the following environment 
\begtt 
... !aha. ... 
\endtt 
</code></pre><p>The macro code: </p><pre class='pr-3'><code>\newtoks\gtthook  \newtoks\ltthook 
\def\tthook{\the\gtthook \the\ltthook \global\ltthook{}} 
</code></pre><p>We can define the <code>\addtoks</code> macro </p><pre class='pr-3'><code>\def\addtoks#1#2{#1\expandafter{\the#1#2}} 
</code></pre><p>and use it, for example: </p><pre class='pr-3'><code>\bgroup \addtoks\gtthook{code} ... \egroup 
</code></pre><p>the code affect to all verbatim environments in the <code>\bgroup...\egroup</code> scope. </p><p>We needn't to double the hash marks in the <code>\gtthook</code> and <code>\ltthook</code> declaration. </p><p>Analogically we can use other <code>\foohook</code> macros from OPmac. </p></section><footer class='text-right'><a href='opmac-tricks.html#loctt' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0002</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='code' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Robust verbatim in titles of sections</h3> <a href='#code'><i class='fas fa-link'></i></a></div></header><section><p>The verbatim environment (surrounded by <code>\activettchar</code> character) cannot be used in macro parameters, especially in section titles, because cactode changing isn't robust operation. We declare the macro <code>\code{text}</code> here, which prints the text like verbatim (with exceptinos described below) but it is robust: it can be used in parameters of other macros and if it is used in sections then the text is printed without changes in TOC, in headlines and in PDF outlines. But the parameter text of the <code>\code</code> cannot be prepared absolutely “verbatim”. User must respect the following rules: </p><p>* Write <code>\\</code> instead <code>\</code>, write <code>\#</code> instead <code>#</code> and write <code>\%</code> instead <code>%</code>. <br>* All other characters are printed verbatim. <br>* You can escape other TeX-special characters: <code>{</code>, <code>}</code>, <code>$</code>, <code>&</code>, <code>^</code>, <code>_</code>,   <code>␣</code> (space), <code>~</code> by backslash. This backslash isn't printed. <br>* The <code>{parameter text}</code> must be balanced with respect to braces <code>{}</code>. If you   need to insert non-balancing brace, write <code>\{</code>. <br>* The double-caret followed by a&nbsp;code (like <code>^^ab</code>) is replaced by specified   character. If you don't need this then write <code>^\^ab</code>. <br>* More subsequent spaces are replaced by one space. If you don't need this   then write control space: <code>\␣\␣</code>. </p><p>Examples: </p><pre class='pr-3'><code>\code{ah_a uff{} &amp;$^}         % prints: ah_a uff{} &amp;$^ 
\code{\\def\\foo\#1{foo=\#1}} % prints: \def\foo#1{foo=#1} 
\code{a\%b\ \ \ c\%d}         % prints: a%b   c%d 
</code></pre><p>Implementation: </p><pre class='pr-3'><code>\def\code#1{\def\tmpb{#1}\edef\tmpb{\expandafter\stripm\meaning\tmpb\relax}% 
   \expandafter\replacestrings\expandafter{\string\\}{\bslash}% 
   \expandafter\replacestrings\bslash{}% 
   \codeP{\leavevmode\hbox{\tt\tmpb}}} 
\def\codeP#1{#1} 
\def\stripm#1-&gt;#2\relax{#2} 
\addprotect\code \addprotect\\ \addprotect\{ \addprotect\} 
\addprotect\^ \addprotect\_ \addprotect\~ 
\setcnvcodesA 
\addto\cnvhook{\let\code=\codeP} 
</code></pre><p>The macro <code>\code</code> detokenizes its parameter by <code>\meaning</code> and does <code>\replacestrings</code> in order to replace <code>\\</code> to \ and other <code>\</code> to nothing. When "\write to REF file" is processed then <code>\code</code> does nothing (as <code>\relax</code>) and the <code>\\</code>, <code>\{</code>, <code>\}</code>, <code>\$</code> etc. are not expanded because they are protected. The same principles are used when normal PDF outlines are created (only difference is that <code>\code#1</code> expands to #1). The PDF viewer removes backslashes automaticaly. Finally, PDF outlines with <code>pdfuni.tex</code> macro are more complicated: we need to detokenize the <code>\code</code> parameters from outline parameter before it is processed by <code>\pdfunidef</code>. This is done by <code>\precode</code> macro: </p><pre class='pr-3'><code>\ifx\pdfunidef\undefined\else  \def\cnvhook #1#2{#2\precode \pdfunidef\tmp\tmp}\fi 
\def\precode{\def\codeP##1{}\let\bslash=\Bslash 
   \edef\tmp{\expandafter}\expandafter\precodeA\tmp\code{}} 
\def\precodeA#1\code#2{\addto\tmp{#1}% 
   \ifx\end#2\end \else 
      \codeA{#2}% 
      \expandafter\addto\expandafter\tmp\expandafter{\tmpb}% 
      \expandafter\precodeA \fi 
} 
\let\codeA=\code 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#code' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0102</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-22'>04/22/2015</time></span> </footer></article> <article id='ttpenalty' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>\clubpenalties and \widowpenalties between lines in code listing</h3> <a href='#ttpenalty'><i class='fas fa-link'></i></a></div></header><section><p>The LaTeX fancyvrb package allows to insert <code>\clubpenalty</code> after first line of listing and <code>\widowpenalty</code> before the last. So, we are able to avoid single line of the listing after page breaking. The implementation in fancyvrb is somewhat clumpy. We do the same more elegant and, moreover we allow to insert the penalties declared by eTeX primitives <code>\clubpenalties</code> and <code>\widowpenalties</code>, so we can avoid more than only one single line after breaking. The fancyvrb is unable to do this. </p><pre class='pr-3'><code>\def\tthook{% 
   \clubpenalties   3 10000 10000 25 
   \widowpenalties  3 10000 10000 25 
   \setbox0=\vbox\bgroup \aftergroup\tthookA} 
\def\tthookA{\setbox2=\hbox{}\setbox0=\vbox\bgroup\unvbox0 \tthookB} 
\def\tthookB{\unskip\unskip\unpenalty \setbox0=\lastbox 
   \ifvoid0 \egroup \noindent\unhbox2 \par \egroup 
   \else \global\setbox2=\hbox{\box0\penalty0\unhbox2}% 
      \expandafter\tthookB 
   \fi} 
</code></pre><p>Next listing is breakable only between third and fourth line: </p><pre class='pr-3'><code>\begtt 
  first 
  second 
  third 
  fourth 
  fifth 
  sixth 
\endtt 
</code></pre><p>The whole listing is packed to box0 by <code>\tthook</code>. Then this box is unpacked in <code>\tthookA</code> and repacked to the sinle line hbox2 (original lines are side by side seperated by <code>\penalty0</code> here). Finally, we do <code>\noindent\unhbox2\par</code>, so the normal paragraph is started and this process inserts the appropriate penalties between lines, of course. </p></section><footer class='text-right'><a href='opmac-tricks.html#ttpenalty' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0123</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-09-11'>09/11/2015</time></span> </footer></article> <article id='hisyntax' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Automatic syntax highlighting</h3> <a href='#hisyntax'><i class='fas fa-link'></i></a></div></header><section><p>We can active a&nbsp;syntax highlighting between <code>\begtt...\endtt</code> by <code>\hisyntax{language}</code> immediately before <code>\begtt</code> or before <code>\verbinput</code>. For example: </p><p><img src='img/hisyntax-ukazka.png' alt='hisyntax example' title='hisyntax example' class='img-fluid rounded mx-auto my-2 d-block'> </p><pre class='pr-3'><code>\hisyntax{C} 
\begtt 
#include &lt;stdio.h&gt; 
int main(int argc, char **argv) 
{ 
   printf("Hello World!\n"); // Prints the message 
   return 0; 
} 
\endtt 
</code></pre><p>The macro <code>\hisyntax</code> locally redefines the string post-processing between <code>\begtt...\endtt</code> using <code>\ptthook</code> (from OPmac Oct. 2015). The macro <code>\ghisyntax</code> activates coloring of all listings in the document. Specially, the <code>\hisyntax{C}</code> (or <code>\ghisyntax{C}</code>) uses an internal macro <code>\hisyntaxC</code> and you can define analogical macro for another programming languages. The <code>\hisyntaxC</code> looks like: </p><pre class='pr-3'><code>\def\hisyntax#1{\bgroup\def\ptthook{\csname hisyntax#1\endcsname}} 
\def\ghisyntax#1{\def\ptthook{\bgroup\csname hisyntax#1\endcsname}} 
 
\def\hisyntaxC#1\egroup{\let\n=\relax \let\NLh=\relax \let\U=\relax 
   \let\TABchar=\relax % used in OPmac trick 0151 
   \adef{ }{\n\ \n}\adef\^^M{\n\NLh\n}\edef\tmpb{#1\egroup}% 
   \replacestrings{\n\egroup}{\egroup}% 
   \replacestrings{/*}{\tmp}\def\tmp##1*/{\U{commentC}{##1}}\edef\tmpb{\tmpb}% 
   \replacestrings{//}{\tmp}\def\tmp##1\NLh{\U{commentCpp}{##1}}\edef\tmpb{\tmpb}% 
   \edef\tmp{\noexpand\replacestrings{\string\"}{\n{\string\"}}}\tmp 
   \replacestrings{"}{\tmp}\def\tmp##1\tmp{\U{stringC}{##1}}\edef\tmpb{\tmpb}% 
   \doreplace{##1}{\n{\chCcolor##1}\n}\charsC{}% 
   \doreplace{\n##1\n}{\kwC{##1}}\keywordsC{}% 
   \edef\tmp{\noexpand\replacestrings{\NLh\n\string##}{\NLh\noexpand\preprocC}}\tmp 
   \doreplace{\n##1}{\numberC##1}0123456789{}% 
   \let\NLh=\par \def\n{}\def\U##1{\csname##1\endcsname}% 
   \tentt\localcolor\tmpb\egroup} 
\def\doreplace#1#2{\def\do##1{\ifx^##1^\else \replacestrings{#1}{#2}\expandafter\do\fi}% 
   \expandafter\do} 
\def\printttline{\llap{\sevenrm\Black\the\ttline\kern.9em}} % \Black added 
 
\def\commentC#1{{\Green/*#1*/}} 
\def\commentCpp#1{{\Green//#1}\NLh} 
\def\stringC#1{{\def\ {\char32 }\Magenta"#1"}} 
\def\numberC#1\n{{\Cyan#1}} 
\def\preprocC#1\n{{\Blue\##1}} 
\edef\keywordsC{{auto}{break}{case}{char}{continue}{default}{do}{double}% 
   {else}{entry}{enum}{extern}{float}{for}{goto}{if}{int}{long}{register}% 
   {return}{short}{sizeof}{static}{struct}{switch}{typedef}{union} 
   {unsigned}{void}{while}} % all keywords of C language are here 
\def\kwC#1{{\Red#1}} 
\edef\charsC{()\string{\string}+-*/=[]&lt;&gt;,:;\percent\string&amp;\string^|!?} 
\let\chCcolor=\Blue 
</code></pre><p>The input string is expanded to <code>\tmpb</code> first and then the <code>\replacestrings</code> is applied to <code>\tmpb</code> repeatedly. The spaces are replaced by <code>\n\ \n</code> and end-lines by <code>\n\NLh\n</code> during the first expansion. The symbol <code>\n</code> in invisible mark which will occur at word boundaries. So, we will be able to manage the keyword "if" as replacing <code>\n if\n</code> by <code>\kwC{if}</code> and this process will not replace the part of the variable identifier "diff" (for example). Next we do the replacing: </p><pre class='pr-3'><code>/* foo-text */           --&gt;   \U{commentC}{ foo-text } 
// foo-text (end-line)   --&gt;   \U{commentCpp}{ foo-text } 
\"                       --&gt;   \n{\"} 
"foo-text"               --&gt;   \U{stringC}{foo-text} 
</code></pre><p>Note, that the “foo-text” is enclosed by <code>{}</code> after replacing, so such text is resistant to next replacing process. Finally, all characters of the type <code>(){}+-...</code> are replaced by <code>\n{\chCcolor char}\n</code>, next all keywords and preprocessor words are replaced. The non-replaced rest is printed in black and this is only identifiers (of variables, functions etc.). The <code>\n number</code> is replaced by <code>\numC number</code> in order to do the colorization of numeric constants (no numbers which are part of identifiers). </p></section><footer class='text-right'><a href='opmac-tricks.html#hisyntax' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0124</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-09-27'>09/27/2015</time></span> </footer></article> <article id='hisyntaxhtml' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>HTML syntax highlighting</h3> <a href='#hisyntaxhtml'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/html-ukazka.png' alt='HTML example' title='HTML example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>As an example of a&nbsp;modification of the previous OPmac trick, we show how to do the syntax highlighting of HTML or XML code. Write </p><pre class='pr-3'><code>\hisyntax{HTML} 
\begtt 
&lt;div class="navis"&gt; 
&lt;nav id="site"&gt; 
... 
&lt;/nav&gt; 
&lt;/div&gt; 
\endtt 
</code></pre><p>and you get the result as shown in the right margin here. The implementation: </p><pre class='pr-3'><code>\def\hisyntax#1{\bgroup\def\ptthook{\csname hisyntax#1\endcsname}} 
\def\ghisyntax#1{\def\ptthook{\bgroup\csname hisyntax#1\endcsname}} 
 
\def\hisyntaxHTML#1\egroup{\let\n=\relax \let\NLh=\relax \let\U=\relax 
   \let\TABchar=\relax % used in OPmac trick 0151 
   \adef{ }{\n\ }\adef\^^M{\n\NLh}\edef\tmpb{#1\egroup}% 
   \replacestrings{&lt;!--}{\tmp}\def\tmp##1--&gt;{\U{commentH}{##1}}\edef\tmpb{\tmp 
   \replacestrings{&lt;}{\tmp}\def\tmp##1&gt;{\U{tagH}{##1}}\edef\tpb{\tmpb}% 
   \expandafter\replacestrings\expandafter{\string&amp;}{\entityH}% 
   \let\NLh=\par \def\n{}\def\U##1{\csname##1\endcsname}% 
   \tentt\localcolor\tmpb\egroup} 
 
\def\commentH#1{{\Green&lt;!--#1--&gt;}} 
\def\tagH#1{\tagHa#1\n^} 
\def\tagHa#1\n#2^{\def\tmpb{#2}\replacestrings{"}{\stringH}% 
   {\Cyan&lt;}{\Red#1}{\Cyan\tmpb&gt;}} 
\def\stringH#1\stringH{{\def\ {\char32 }\Magenta"#1"}} 
\def\entityH#1;{{\Blue\&amp;#1;}} 
 
\let\hisyntaxXML=\hisyntaxHTML 
</code></pre><p>The macro <code>\hisyntaxHTML</code> converts the spaces to <code>\n\␣</code> and end-lines to <code>\n\NLh</code> first. Then the comments <code><!--foo--></code> are converted to <code>\U{commentH}{foo}</code> and tags <code><foo></code> to <code>\U{tagH}{foo}</code>. The macro <code>\tagH</code> separates the tag name and parameters and does the conversion of strings in the parameters. </p></section><footer class='text-right'><a href='opmac-tricks.html#hisyntaxhtml' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0125</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-10-03'>10/03/2015</time></span> </footer></article> <article id='hisyntaxpy' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Python syntax highlighting</h3> <a href='#hisyntaxpy'><i class='fas fa-link'></i></a></div></header><section><p>There is a&nbsp;term work <a href='https://gitlab.fit.cvut.cz/krajnpet/PySyntax' title='Python syntax highlighting'>Python syntax highlighting</a> given in the course BI-TeX (it has been held at FIT CTU in Prague). This result was strongly inspired by previous two OPmac tricks but it is more complicated task. Student Petr Krajnik made good job. </p></section><footer class='text-right'><a href='opmac-tricks.html#hisyntaxpy' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0152</span> <span class='badge badge-info'>Author: Petr Krajník</span> <span class='badge badge-info'>Published <time datetime='2016-06-03'>06/03/2016</time></span> </footer></article> <article id='hisyntaxcss' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>C# syntax highlighting</h3> <a href='#hisyntaxcss'><i class='fas fa-link'></i></a></div></header><section><p>There is a&nbsp;term work <a href='https://gitlab.fit.cvut.cz/francmi4/cssyntax' title='C# syntax highlighting'>C# syntax highlighting</a> given in the course BI-TeX (it has been held at FIT CTU in Prague). This result was strongly inspired by previous two OPmac tricks. </p></section><footer class='text-right'><a href='opmac-tricks.html#hisyntaxcss' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0168</span> <span class='badge badge-info'>Author: Michal Franc</span> <span class='badge badge-info'>Published <time datetime='2019-06-21'>06/21/2019</time></span> </footer></article> <article id='ttram' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Listings in frames</h3> <a href='#ttram'><i class='fas fa-link'></i></a></div></header><section><p>We need to print each listing produced by <code>\begtt...\endtt</code> or by <code>\verbinput</code> in a&nbsp;frame. The frame must be beakable when listing continues at new page. </p><p>This task is solvable without re-definition of <code>\begtt</code> and <code>\doverbinput</code> macros since OPmac version Ost. 2015. We can add the <code>\everypar</code> setting in the <code>\tthook</code> here. And we print the frame parts at the left and right side of each line by the <code>\everypar</code>. The rest of the code defines <code>\ttskip</code> as <code>\ttskipA</code> for the top rule of the frame and as <code>\ttskipB</code> for the bottom rule of the frame. </p><pre class='pr-3'><code>\def\srule{\line{\vrule height 3pt \hfil\vrule}} 
\def\ttskipA{\bigskip\hrule\srule \global\let\ttskip=\ttskipB} 
\def\ttskipB{\nointerlineskip\srule\hrule\bigskip \global\let\ttskip=\ttskipA} 
\let\ttskip=\ttskipA 
\def\tthook{\offinterlineskip \everypar={\rlap{\kern-\ttindent\line{\vrule\strut\hss\vrule}}}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#ttram' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0126</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-10-07'>10/07/2015</time></span> </footer></article> <article id='verbbreak' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Long line breaking in listings</h3> <a href='#verbbreak'><i class='fas fa-link'></i></a></div></header><section><p>OPmac doesn't solve the automatic long line breaking in listings by default. The line is broken but overfull <code>\hbox</code> occurs. The reason: it is much better to prepare the whole code under user control. But we show in the following example, how to activate the following behavior: The lines are breakable in spaces without Overfull <code>\hbox</code> messages, the breakpoints are marked by given mark (the <code>$\setminus$</code> in our example) and the continuing lines are indented by the same number of spaces as the first line. This mean that: </p><pre class='pr-3'><code>\begtt 
if i=0 
   Oops, the very long line of code is here, it does not fit into the line width unfortunately. 
fi 
\endtt 
</code></pre><p>The continuing line will be start exactly under the word “Oops”. </p><pre class='pr-3'><code>\def\tthook{\rightskip=0pt plus1fil 
   \def\ {\discretionary{\hbox{$\;\setminus$}}{}{\kern.5em}}% 
   \everypar={\countspaces}} 
\def\countspaces#1\fi{#1\fi\hangindent=\ttindent \countspacesA} 
\def\countspacesA{\futurelet\next\countspacesB} 
\def\countspacesB{\ifx\next\spacemacro \expandafter\countspacesC\fi} 
\def\countspacesC#1{\advance\hangindent by.5em\ \countspacesA} 
\def\spacemacro{\ } 
</code></pre><p>The macro <code>\countspaces</code> is invoked by <code>\everypar</code>. It finishes the special verbatim <code>\par</code> (until <code>\fi</code>) and then it counts the spaces at the start of the line. Each space enlarges the <code>\hangindent</code> by space width. </p><p>This solution is incompatible with frames around listings by the previous OPmac trick. The frame have gaps at it sides if continuous line occurs. If we need to solve this then we must to insert <code>\offinterlineskip\everypar={\makeframe}</code> into <code>\tthook</code> and to define: </p><pre class='pr-3'><code>{\catcode`\^^M=13 
\gdef\makeframe#1^^M{\endgraf\hbox{\vrule\vbox{% 
   \normalbaselines\everypar={}\strut\countspaces#1\strut}\vrule}^^M}% 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#verbbreak' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0127</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-10-11'>10/11/2015</time></span> </footer></article> <article id='verbtab' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>TABs in verbatim listings</h3> <a href='#verbtab'><i class='fas fa-link'></i></a></div></header><section><p>Plain TeX sets the meaning of TAB character <code>^^I</code> (ASCII 9) to one space. This is not useful when you are using these characters in verbatim listings processed by <code>\begtt...\endtt</code> or <code>\verbinput</code>. If you need to print more spaces instead each TAB then you can define </p><pre class='pr-3'><code>\def\tthook{\adef\^^I{\space\space\space}} % TAB = 3 spaces 
</code></pre><p>The TAB character is usually more intelligent in text files: it creates the space of variable length in order to the next text begins immediately after next “tab stop”. The positions of “tabs stops” are fixed in each line. Usually, they are positioned per 8&nbsp;characters, i. e. after 8, 16, 24, etc. positions. We can do this in TeX using OPmac, as follows: </p><pre class='pr-3'><code>{\obeylines\gdef\everyttline#1^^M{\setbox0=\hbox\bgroup#1\egroup \box0 ^^M}}% 
\def\tthook{\everypar={\everyttline}\adef\^^I{\TABchar}} 
 
\def\TABchar{\egroup 
   \tmpdim=\TABskip \advance\tmpdim by-.1em 
   \loop \ifdim\tmpdim&lt;\wd0 \advance\tmpdim by\TABskip\relax \repeat 
   \advance\tmpdim by-\wd0 \advance\tmpdim by.1em 
   \box0 \kern\tmpdim 
   \setbox0=\hbox\bgroup 
} 
\def\TABskip{4em} % 4em = 8 chars, because each character has .5em width 
</code></pre><p>The code mentioned here is activated using <code>\everypar</code> in verbatim listings. It processes each line by <code>\setbox0=\hbox{text of line}\box0</code>. The TAB character is active. It executes the <code>\TABchar</code> macro which closes the <code>\setbox</code> immediately, measures the <code>\box0</code>, puts the appropriate <code>\kern</code> and starts the <code>\setbox0=\hbox\bgroup</code> again. </p><p>If you need to control the indentation of lines of the code, then the following OPmac trick 0151 is recommended. </p></section><footer class='text-right'><a href='opmac-tricks.html#verbtab' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0150</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-02'>06/02/2016</time></span> </footer></article> <article id='verbindent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Smart indentation of code lines in verbatim</h3> <a href='#verbindent'><i class='fas fa-link'></i></a></div></header><section><p>There exist conventions, how many spaces to use for indentation of various levels of code lines. For example, if you use the schema 0, 4, 8, 12 etc. in your verbatim input then you can set <code>\verbindentIN</code> to 4. When the code is printed using <code>\begtt...\endtt</code> or <code>\verbinput</code> then different indentation can be used. For example, if you need 0, 2, 4, 6, etc. in the output then you can set <code>\verbindentOUT</code> to 2. All indentations will have half size than in the input. </p><pre class='pr-3'><code>\def\tthook{\everypar={\everyttline}\adef\^^I{\TABchar}} 
\def\everyttline#1\fi{\fi \def\TABchar{{\ }}% 
   \ifx\NLh\undefined \def\spaceGEN{\ }\def\spaceTAB{\TABchar}\else 
      \let\spaceGEN=\ \let\spaceTAB=\TABchar\fi 
   \tmpnum=0 \def\everyttlineC##1{\everyttlineA}\everyttlineA} 
\def\everyttlineA{\futurelet\next\everyttlineB} 
\def\everyttlineB{\ifx\next\n \else 
   \ifx\next\spaceGEN \advance\tmpnum by1 \else 
   \ifx\next\spaceTAB \divide\tmpnum by\TABskipIN % TAB position 
      \advance\tmpnum by1 \multiply\tmpnum by\TABskipIN \relax \else 
   \def\everyttlineC{\everyttlineD\everyttlineE}\fi\fi\fi 
   \everyttlineC 
} 
\def\everyttlineD{% maybe line numbers: 
   \ifnum\ttline&lt;0 \else 
      \ifx\glob\undefined \global \else \glob\fi \advance\ttline by1 \printttline\fi 
} 
\def\everyttlineE{% recalculation of indentation: 
   \tmpdim=.5em \tmpdim=\the\tmpnum\tmpdim \tmpdim=\verbindentOUT\tmpdim 
   \divide\tmpdim by\verbindentIN \kern\tmpdim 
} 
\def\TABskipIN{8}     % the distance between two TAB stops in input 
\def\verbindentIN{4}  % the indentation in input 
\def\verbindentOUT{2} % the indentation in output 
</code></pre><p>The macro measures the indentation width of each line using <code>\everypar</code>. This width is multiplied by <code>\verbindentOUT</code> and divided by <code>\verbindentIN</code>. The corrected width is used in the output. When the input indentation is calculated then each space is calculated as one and each TAB behaves like normal TAB character: it shifts the next text to the next TAB stop. The distance of TAB stops is set in <code>\TABskipIN</code>. The default value 8&nbsp;means that (for example) <code>space space tab tab space</code> generates the indentation of 17 characters in the input. </p><p>The spaces between words are unchanged. The TABs between words behave like one space. The macro cooperates with automatic highlighting mentioned in OPmac tricks 0124 and 0125. </p></section><footer class='text-right'><a href='opmac-tricks.html#verbindent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0151</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-02'>06/02/2016</time></span> </footer></article>
                            </section>  <section id="poznamky" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Notes</h2>
                                    <a href="#poznamky"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='footcat' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Catcode changes in the footnotes</h3> <a href='#footcat'><i class='fas fa-link'></i></a></div></header><section><p>For example, the text <code>\fnote{here is "\foo"}</code> will not work if <code>\activettchar"</code> is declared, because the <code>\fnote</code> reads its parameter without catcode changes. The problem is explained in detail in TBN, page 26. On the other hand, we can redefine <code>\fnote</code> in order to catcode changes work: </p><pre class='pr-3'><code>\expandafter\def\expandafter\afnote\expandafter{\fnote{\unhbox0}} 
\def\fnote{\setbox0=\hbox\bgroup\typobase\typoscale[800/800]\aftergroup\afnote\let\next} 
</code></pre><p>The redefined <code>\fnote</code> does not have the parameter, but it reads the following text as a&nbsp;part of <code>\setbox0=\hbox</code> code. After the <code>\hbox</code> is finished, the original <code>\fnote</code> from OPmac is processed with the parameter <code>\unhbox0</code>. Note that the fontsize have to be set when the text is read into <code>\hbox</code> because the font parameters is irrelevant when <code>\unhbox0</code> is processed. </p><p>You can redefine <code>\mnote</code> and similar macros by similar way as <code>\fnote</code> here: </p><pre class='pr-3'><code>\expandafter\def\expandafter\amnote\expandafter{\mnote{\unhbox0}} 
\def\mnote{\setbox0=\hbox\bgroup\aftergroup\amnote\let\next} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#footcat' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0030</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-27'>09/27/2013</time></span> </footer></article> <article id='thefnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Different formatting of the mark in text and footnote</h3> <a href='#thefnote'><i class='fas fa-link'></i></a></div></header><section><p>It is possible that we need to print the footnote number by another way in text and in the footnote itself. We can use <code>\fnotehook</code> for this purpose and we can redefine <code>\thefnote</code> locally. </p><p>The example below prints a&nbsp;downarrow followed by a&nbsp;number in the text where footnote is referenced, but the footnote itself repeats the same number without the downarrow. </p><pre class='pr-3'><code>\def\thefnote{$\,\downarrow^{\locfnum}$} 
\def\fnotehook{\def\thefnote{\locfnum}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#thefnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0044</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-02'>04/02/2014</time></span> </footer></article> <article id='hyperlinkfnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The footnote mark connected to footnote by hyperlink</h3> <a href='#hyperlinkfnote'><i class='fas fa-link'></i></a></div></header><section><p>The task is to connect footnote mark in text to relevant footnote and backward the footnote to its footnote mark in the text. This could be done by: </p><pre class='pr-3'><code>\hyperlinks\Green\Green 
 
\let\fnmarkboth=\fnmarkx 
 
\def\fnmarkx{\link[fnx:\the\fnotenum]{\localcolor\Red} {\fnmarkboth}% 
             \dest[fny:\the\fnotenum]} 
\def\fnmarky{\link[fny:\the\fnotenum]{\localcolor\Blue}{\fnmarkboth}% 
             \dest[fnx:\the\fnotenum]} 
 
\def\fnote{\fnoteG\fnmarky} 
\def\fnotemark#1{{\advance\fnotenum by#1\relax \fnmarky}} 
 
\def\fnxborder{1 0 0} 
\def\fnyborder{0 0 1} 
</code></pre><p>The <code>\Red</code> and <code>\Bue</code> colors are used here for activated hyperlinks  and the frame around active hyperlink is declared by <code>\fnxborder</code> and <code>\fnyborder</code>. You need not to declare frames. </p></section><footer class='text-right'><a href='opmac-tricks.html#hyperlinkfnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0044</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2020-03-19'>03/19/2020</time></span> </footer></article> <article id='fnoteshape' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Paragraph shape in the footnote</h3> <a href='#fnoteshape'><i class='fas fa-link'></i></a></div></header><section><p>OPmac prints the footnote paragraph in the same shape as main paragraphs, i.e. with the <code>\parindent</code> used only in the first line. The footnote mark is placed into <code>\parindent</code>. If you need to indent second and more lines by <code>\parindent</code> too (i.e. the whole paragraph is left/right aligned and indented by <code>\parindent</code>, only footnote mark is placed into this left “margin”) then you can do the following trick: </p><pre class='pr-3'><code>\addto\footstrut{\hang} 
</code></pre><p>This trick extends the plain TeX's macro <code>\footstrut</code> by <code>\hangindent=\parindent</code> setting. Of course, the <code>\footstrut</code> macro isn't designed for this purpose, but it is used in plain TeX's <code>\vfootnote</code> and it is used at only one place where such settings can be realized. If you try to set this in <code>\fnotehook</code> then nothing happens because <code>\vfootnote</code> (processed after <code>\fnotehook</code>) opens <code>\insert</code> and the <code>\hangindent</code> is reset during this opening (like in <code>\par</code>). Moreover, <code>\leftskip</code>, <code>\rigtskip</code> registers are reset in <code>\vfootnote</code> too, so the setting such registers in <code>\fnotehook</code> is irrelevant, but you can do such setting in <code>\footstrut</code> macro, if you need. If you plan general changes of footnotes parshape then you can redefine the whole <code>\vfootnote</code>. </p><p>The distance between footnote mark and the first character of the text is set in plain TeX's macro <code>\texindent</code> to <code>\enspace</code>. You can re-define the <code>\textindent</code> but you must know that this macro is used in plain TeX's <code>\item</code> and <code>\itemitem</code>. If these macros are not used in your document then your re-definition influences only footnote mark formating, because <code>\begitems...\enditems</code> environment from OPmac does not use <code>\item</code>, <code>\itemitem</code> nor <code>\texindent</code>. You can do, for example: </p><pre class='pr-3'><code>\def\texindent#1{\indent\llap{#1\kern3pt}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#fnoteshape' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0107</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-30'>04/30/2015</time></span> </footer></article> <article id='fnotebroken' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Broken footnotes with colors</h3> <a href='#fnotebroken'><i class='fas fa-link'></i></a></div></header><section><p>There is bad concept with colors in TeX: color switchers are used and they works in PDF rasteriser only: TeX has no idea about colors used in middle of the typesetting material when this material is broken to more pages. This problem is partially solved in pdfTeX using colorstack mechanism, but it does not work well when long footnotes with colored text are broken to more pages. Opmac uses colorstack, so the text created by <code>{\localcolor\Red text...text}</code> works well in main block of typesetting material even if the text is broken to more pages. But you must type <code>{\fnotecolor\Red text...text}</code> inside a&nbsp;long footnote when this footnote can be broken. The <code>\fnotecolor</code> macro can be defined as follows: </p><pre class='pr-3'><code>\def\fnotecolor#1{\expandafter\definecolor#1% 
   \expandafter\fnoteRedA\expandafter{\iffalse}\fi} 
\def\definecolor#1#2{\def\everyColor{#2 k}} 
\long\def\fnoteRedA#1{\everyspacecolor#1 {} \egroup\pdfliteral{0 g}} 
\long\def\everyspacecolor#1 {\ifx\end#1\end \unskip \else  
   \pdfliteral{\everyColor}#1 \expandafter\everyspacecolor\fi 
} 
 
</code></pre><p>The macro adds the color switcher (with the same color) before each word in the colorized text in footnote. Only first switcher does a&nbsp;visible action. But if the long footnote is broken to next page then the color switcher loctated at the front of the first word at the new page (in the footnote area) causes the appropriate color switching. Because the colors used by <code>\fnotecolor</code> don't use colorstack, there is no interferrence with colorstack used in main text. </p><p>We hope that the words in colorized footnote will be not hyphenated (when footnote is broken to more pages) and there are no complicated macro construction inside colorized text because <code>\fnotecolor</code> needs to  decompose the text to words. </p></section><footer class='text-right'><a href='opmac-tricks.html#fnotebroken' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0167</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2019-02-12'>02/12/2019</time></span> </footer></article> <article id='tnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Local notes for tables</h3> <a href='#tnote'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes we need to print special notes for table cells not as footnotes but as notes under the table. The user can write, for example: </p><pre class='pr-3'><code>\table{lll}{ 
  aha\tnote{small understanding}  &amp; bha &amp; ha \cr 
  uha\tnote{wondering}            &amp; eha &amp; ha \cr 
  xha\tnote{extra understanding}  &amp; fha &amp; nha \cr 
} 
\nobreak\medskip\tnotes 
</code></pre><p>The cells aha, uha, xha will take exponents 1, 2, 3&nbsp;and the same exponents including the note texts will be printed in the place of the <code>\tnotes</code> under the table. You can use the following macro: </p><pre class='pr-3'><code>\newcount\tnotenum  \newbox\tnotebox 
\def\tnote#1{\global\advance\tnotenum by1 
   \hbox{\thetnote}% 
   \global\setbox\tnotebox=\vbox{\unvbox\tnotebox 
      \typobase\typoscale[800/800] \noindent\enspace\llap{\thetnote\ }#1\strut}} 
\def\tnotes{\global\tnotenum=0 \box\tnotebox} 
\def\thetnote{$^{\the\tnotenum}$} 
</code></pre><p>If you need to use letters instead numbers in the exponents, you can write </p><pre class='pr-3'><code>\def\thetnote{$^{\rm\athe{\the\tnotenum}}$} 
</code></pre><p>The notes are accumulated into box <code>\tnotebox</code> and this box is printed under the table by <code>\tnotes</code> sequence. The box has the width <code>\hsize</code>, so you can write for centering short notes: </p><pre class='pr-3'><code>\centerline{\vbox{\table{...}{...}\medskip\rlap{\tnotes}}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#tnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0033</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-10-07'>10/07/2013</time></span> </footer></article> <article id='rotmnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Rotated marginal notes</h3> <a href='#rotmnote'><i class='fas fa-link'></i></a></div></header><section><p>If you need to rotate the marginal notes by 45 or 90 degrees then you can write: </p><pre class='pr-3'><code>\fixmnotes\right 
\def\mnotehook#1\endgraf{\noindent\pdfsave\pdfrotate{45}\rlap{#1}\pdfrestore} 
</code></pre><p>The rotation origin is the left point of the first line at the baseline of the note text. Maybe you will need to correct the default dimensions of <code>\mnoteindent</code> and <code>\mnotesize</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#rotmnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0071</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-18'>06/18/2014</time></span> </footer></article> <article id='nmnote' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Numbered marginal notes</h3> <a href='#nmnote'><i class='fas fa-link'></i></a></div></header><section><p>We solve the task to do numbered marginal notes similarly like footnotes. I. e. the number is printed in the text and the same number is used at the beginning of the marginal note. Such solution is used <a href='https://dl.dropboxusercontent.com/u/502901/naurtf.pdf' title='here, for example'>here, for example</a>. </p><p>We create the \note{text} macro which prints the numbered marginal note. The implementation follows: </p><pre class='pr-3'><code>\margins/1 a4 (2,6,2,2)cm 
\mnotesize=4.5cm 
 
\newcount\notenum 
\fixmnotes\right 
\def\note#1{\global\advance\notenum by 1 
   $^{\the\notenum}$% 
   \mnote{\typoscale[800/800]$^{\the\notenum}$\kern.3em #1}% 
} 
</code></pre><p>The right margin is enlarged by <code>\margins</code>, because the marginal notes will be printed here. The <code>\notenum</code> register is incremented by one for each <code>\note</code> call and this number is printed in the text and in the note. </p><p>The code doesn't solve the problems with marginal notes overlapping each other and leaving notes from the page boundary at the bottom, because simple <code>\mnote</code> macro is used here. I&nbsp;recommend to ignore such problems during document preparating but to correct the positions of <code>\mnote</code>s&nbsp;when final proofreading is performed and the final page breaking is definitely done. Then user can use <code>\mnoteskip</code> register for manual correction of <code>\mnote</code> positions by hand. </p></section><footer class='text-right'><a href='opmac-tricks.html#nmnote' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0122</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-08-25'>08/25/2015</time></span> </footer></article>
                            </section>  <section id="odrazky" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Lists</h2>
                                    <a href="#odrazky"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='vnoreni' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Nested \begitems...\enditems with given item marks</h3> <a href='#vnoreni'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\begitems...\enditems</code> environment works with default item mark (if no <code>\style</code> is used). It is possible that the default item mark depends on the level of the list. You can use the code: </p><pre class='pr-3'><code>\def\slet#1#2{\expandafter\let\csname#1\expandafter\endcsname\csname#2\endcsname} 
\addto\begitems{\slet{normalitem}{item:o}} 
</code></pre><p>The big bullet is set as default item mark. If you use the code above then the item mark for first level of items is big bullet and the item mark for second level is small bullet. If you need the different item marks for third level, then you can type: </p><pre class='pr-3'><code>\addto\begitems{\slet{normalitem}{item:o}\addto\begitems{\slet{normalitem}{item:-}}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#vnoreni' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0003</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='vnoreniB' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Another solution for nested \begitems...\enditems</h3> <a href='#vnoreniB'><i class='fas fa-link'></i></a></div></header><section><p>In order to avoid the usage of <code>\style</code> sequence in <code>\begitems...\enditems</code> environment we can define the default style. This ensures the visual compatibility of the item marks in the whole document. The default <code>\style</code> can be declared for nested lists too. </p><pre class='pr-3'><code>\addto\begitems{\style a 
   \addto\begitems{\style n 
      \addto\begitems{\style i }}} 
</code></pre><p>The syntax <code>\begitems\style x</code> works too and this redefines the declared default behavior. </p></section><footer class='text-right'><a href='opmac-tricks.html#vnoreniB' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0031</span> <span class='badge badge-info'>Author: Jan Šustek</span> <span class='badge badge-info'>Published <time datetime='2013-09-28'>09/28/2013</time></span> </footer></article> <article id='vertii' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Vertical spacing in \begitems...\enditems</h3> <a href='#vertii'><i class='fas fa-link'></i></a></div></header><section><p>The vertical space from <code>\iiskip</code> macro is added above and below each item list. OPmac sets <code>\iiskik</code> to <code>\medskip</code> (one half of baselineskip). These spaces can be added for nested lists and this doesn't look well. You can cancel this space by: </p><pre class='pr-3'><code>\def\iiskip{} 
</code></pre><p>If you need to cancel this space only in nested lists, you can write: </p><pre class='pr-3'><code>\addto\begitems{\def\iiskip{}} 
</code></pre><p>If you need the vertical space between each item record in the list and the same space around the item list, you can do: </p><pre class='pr-3'><code>\newdimen\iiskipamount  \iiskipamount=3pt 
\def\iiskip{\vskip\iiskipamount} 
\addto\begitems{\removelastskip\parskip=\iiskipamount \def\iiskip{}} 
</code></pre><p>This code cancels the vertical spaces around nested lists and adds the space between each paragraph by <code>\parskip</code>. We need to remove the space by <code>\removelastskip</code> before first item in the first level of the list. But we need this space from <code>\iiskip</code> at the end of the list because the space from <code>\parskip</code> isn't here. </p><p>If we needn't the spaces between paragraphs inside one multi paragraph item record but we need the spaces between item records then we can redefine the macro <code>\startitem</code> which is used by OPmac at the start of each item: </p><pre class='pr-3'><code>\newdimen\iiskipamount  \iiskipamount=3pt 
\def\addbefore#1#2{\toks1=\expandafter{#1}\toks2={#2}\edef#1{\the\toks2 \the\toks1}} 
 
\def\iiskip{\vskip\iiskipamount} 
\addto\begitems{\removelastskip \def\iiskip{}} 
\addbefore\startitem{\vskip\iiskipamount\relax} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#vertii' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0004</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='noindent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>No indent after list of items</h3> <a href='#noindent'><i class='fas fa-link'></i></a></div></header><section><p>There exists the typographical rule that the first paragraph after item list isn't indented because the item records are indented in the list above and this can be the source of confusion. If you need to follow this rule then you can write at the beginning of your document: </p><pre class='pr-3'><code>\addto\enditems{\afternoindent} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#noindent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0019</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-27'>08/27/2013</time></span> </footer></article> <article id='gitemnum' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Global numbering of items</h3> <a href='#gitemnum'><i class='fas fa-link'></i></a></div></header><section><p>We need sometimes to start the numbering of items in the list with next number not used before. We can create global counter <code>\gitemnum</code> where the last item number is saved. Then this value is used at the start of the next items list. </p><pre class='pr-3'><code>\newcount\gitemnum 
\addto\begitems{\itemnum\gitemnum} 
\addbefore\enditems{\global\gitemnum\itemnum} 
</code></pre><p>The <code>\addbefore</code> macro from OPmac trick 0004 is used here. This trick works only for not nested lists. </p></section><footer class='text-right'><a href='opmac-tricks.html#gitemnum' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0134</span> <span class='badge badge-info'>Author: Jan Šustek</span> <span class='badge badge-info'>Published <time datetime='2015-12-19'>12/19/2015</time></span> </footer></article>
                            </section>  <section id="draft" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Draft</h2>
                                    <a href="#draft"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='draftlabels' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Printing labels in draft mode</h3> <a href='#draftlabels'><i class='fas fa-link'></i></a></div></header><section><p>When <code>\draft</code> is active (i.e. proofreading text is prepared), then it is usable to print the internal labels used in the document source in the place of the destination of the references of <code>\ref</code> and <code>\cite</code>. The author needn't to remember the label names when they are used in new parts of the document because they are visible in proofreading text. </p><pre class='pr-3'><code>\addto\draft{\let\destbox=\draftdestbox} 
\def\draftdestbox[#1#2:#3]{\vbox to0pt{\kern-\destheight 
   \ifx\pdfdest\undefined\special{pdf:dest (#1#2:#3) [@thispage /XYZ @xpos @ypos null]}% 
   \else\pdfdest name{#1#2:#3} xyz\relax\fi 
   \if#1r\llap{\localcolor\Red\tt\thefontsize[10][\detokenize\expandafter{#3}]}\vss 
   \else \if#1c\vss\llap{\localcolor\Red\tt[\detokenize\expandafter{\tmpb}] }\kern-\prevdepth 
   \else \vss \fi\fi}} 
</code></pre><p>This macro redefines <code>\destbox</code> form OPmac. The main reason of the <code>\destbox</code> is to place the destination of the link in the height <code>\destheight</code> above baseline. If the type of the link is <code>ref</code> (<code>#1=r</code>) then <code>\llap</code> followed by <code>\vss</code> is added. If the type is <code>cite</code> (<code>#1=c</code>) then the added <code>\llap</code> is on the baselineskip and it is printed in list of bibliography. The label is printed in green color. If <code>\draft</code> mode is deactivated, the labels disappear without any changes of the typesetting. </p><p>The <code>\detokenize</code> command (from e-TeX) is used in the code in order to enable printing the labels where the characters <code>_</code> is used. If the eTeX isn't available then <code>\expandafter\string\csname...\endcsname</code> can be used for printing such labels. </p><p>When <code>\draftmode</code> is on then we can print the date of document processing in the footline, for example: </p><pre class='pr-3'><code>\addto\draft{\def\drafttext{\llap{\the\day. \the\month. \the\year\Black}}} 
\def\drafttext{} 
\footline={\hss\rm\thefontsize[10]\the\pageno\hss\drafttext} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#draftlabels' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0005</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='rfc' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Request for correction in draft mode</h3> <a href='#rfc'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes is usable to write individual notes of type “attention, I&nbsp;have to add a&nbsp;picture here” into the document. These notes are printed only in <code>\draft</code> mode. You can use this by macros <code>\rfc</code> (request for correction) and <code>\makerfc</code>. The first one inserts into the text the numbered destination of the hyperlink (without changing of the typesetting of normal text) and the second one prints the list of all notes. They are hyperlinks. When <code>\draft</code> mode is off then no destinations and no list of notes is printed. The usage of the macro looks like: </p><pre class='pr-3'><code>There is normal text here.\rfc{check if here isn't fallacy!} 
Next text.\rfc{trace the measured results again!} 
... 
% at the end of the document: 
\makerfc 
</code></pre><p>If <code>\draft</code> mode is on, then the last page of the document prints: </p><p>[rfc-1]  check if here isn't fallacy! <br>[rfc-2]  trace the measured results again! </p><p>and when <code>\hyperlinks</code> mode is on then the texts [rfc-1] and [rfc-2] are active hyperlinks with destination in the place of the document where the problem is. </p><p>The implementation: </p><pre class='pr-3'><code>\newcount\rfcnum 
 
\def\rfclist{} 
\def\rfcactive#1{\global\advance\rfcnum by1 
   \dest[rfc:rfc-\the\rfcnum]\global\addto\rfclist{\rfcitem #1}} 
\def\rfc#1{} 
\def\rfcitem{\advance\rfcnum by1 
   \medskip\noindent\llap{\link[rfc:rfc-\the\rfcnum]{\localcolor\Red}{[rfc-\the\rfcnum] }}} 
 
\addto\draft{\let\rfc=\rfcactive} 
 
\def\makerfc{\ifx\rfc\rfcactive 
   \vfil\break {\secfont \noindent Requests for correction}\par 
   \bgroup\rfcnum=0 \rfclist\egroup\fi} 
</code></pre><p>The macro <code>\rfc</code> is empty by default but <code>\draft</code> adds <code>\let\rfc=\rfcactive</code>, i.e. the macro is activated. It adds the text of the note into <code>\rfclist</code>. The text of each note is started by the <code>\rfcitem</code> sequence. The <code>\makerfc</code> runs simply <code>\rfclist</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#rfc' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0056</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article>
                            </section>  <section id="cislovani-odkazy" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Numbering, references</h2>
                                    <a href="#cislovani-odkazy"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='cislovani' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Systematic declaration of numbers</h3> <a href='#cislovani'><i class='fas fa-link'></i></a></div></header><section><p>OPmac uses the <code>\tnum</code> for table numbers, the <code>\fnum</code> for figure numbers and the <code>\dnum</code> for display equation numbers. The <code>\chapnum</code> is the number of the chapter, the <code>\secnum</code> is the number of the section and the <code>\seccnum</code> is the number for the subsection. The <code>\tnum</code>, <code>\fnum</code> and <code>\dnum</code> are reset to one in each section and the default printing format is chapnum.secnum.tnum or chapnum.secnum.fnum or (dnum). User can change the printing format by redefining of <code>\thetnum</code>, <code>\thefnum</code> and <code>\thednum</code>. The resetting strategy of these numbers can be changed too using <code>\chaphook</code>, <code>\sechook</code> and <code>\secchook</code>. These hooks are used in the <code>\chap</code>, <code>\sec</code>, <code>\secc</code> macros followed by default resetting followed by <code>\relax</code>. We can remove default resetting by: </p><pre class='pr-3'><code>\def\chaphook#1\relax{\dochaphook}  \def\dochaphook{} 
\def\sechook#1\relax{\dosechook}    \def\dosechook{} 
\def\secchook#1\relax{\dosecchook}  \def\dosecchook{} 
 
\def\chapreset#1{\addto\dochaphook{\global#1=0 }} 
\def\secreset#1{\addto\dosechook{\global#1=0 }\chapreset#1} 
\def\seccreset#1{\addto\dosecchook{\global#1=0 }\secreset#1} 
 
\chapreset\secnum   \secreset\seccnum 
</code></pre><p>The <code>\chapreset\counter</code> declares that the <code>\counter</code> will be reset at each chapter. The <code>\secreset\num</code> declares resetting of the <code>\num</code> in each chapters and sections. Finally, the <code>\seccreset\foo</code> declares that <code>\foo</code> is reset in chapters, sections and subsections. </p><p>For example, we need to reset numbers of tables, figures and equations only in each chapter and we want to print them in the format <code>chapnum.num</code>. The equation will be referred by (<code>chapnum.num</code>). Then we can write: </p><pre class='pr-3'><code>\chapreset\tnum   \def\thetnum{\the\chapnum.\the\tnum} 
\chapreset\fnum   \def\thefnum{\the\chapnum.\the\fnum} 
\chapreset\dnum   \def\thednum{(\the\chapnum.\the\dnum)} 
</code></pre><p>For next example, we suppose the numbering of propositions. The number will be reset in each subsection and printed in the format <code>chapnum.secnum.seccnum.propnum</code>. </p><pre class='pr-3'><code>\newcount\propnum  \seccreset\propnum 
\def\thepropnum{\the\chapnum.\the\secnum.\the\seccnum.\the\propnum} 
 
\def\proposition{\global\advance\propnum by 1 
   \noindent\wlabel{\thepropnum}{\bf Proposition \thepropnum.}\space} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#cislovani' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0007</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-15'>08/15/2013</time></span> </footer></article> <article id='pictab' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>List of figures and tables</h3> <a href='#pictab'><i class='fas fa-link'></i></a></div></header><section><p>OPmac generates the contents of chapters, sections and subsections by <code>\maketoc</code> macro. When we need to print the list of figures or tables then we need to do it, for example by the code: </p><pre class='pr-3'><code>\def\totlist{} \def\toflist{} 
\def\Xtab#1#2#3{\addto\totlist{\totline{#1}{#2}{#3}}} 
\def\Xfig#1#2#3{\addto\toflist{\tofline{#1}{#2}{#3}}} 
 
\input opmac 
 
\def\tofline#1#2#3{{\leftskip=\iindent \rightskip=\iindent plus1em 
   \noindent\llap{\bf\ref[#1].\enspace}% 
   {#3\unskip}\nobreak\tocdotfill\pgref[#1]\nobreak\hskip-\iindent\null\par}} 
\let\totline=\tofline 
 
\def\captionhook#1{\typosize[10/12]% 
   \ifx\clabeltext\undefined \else 
      \ifx#1t{\protectlist\immediate\wref\Xtab{{\lastlabel}{\thetnum}{\clabeltext}}}% 
      \else  {\protectlist\immediate\wref\Xfig{{\lastlabel}{\thefnum}{\clabeltext}}}% 
   \fi\fi 
   \global\let\clabeltext=\undefined 
} 
\def\clabel[#1]#2{\gdef\clabeltext{#2}\label[#1]} 
</code></pre><p>The REF file managed by OPmac is used here. New items will be write into this file in the form <code>\Xtab{label}{number}{text}</code> a&nbsp;<code>\Xfig{label}{number}{text}</code>. The items are written immediately because the page number is not used here. The page number is printed by normal <code>\pgref</code> macro. The REF file is read during <code>\input opmac</code>, so we need to define <code>\Xtab</code> and <code>\Xref</code> before <code>\input opmac</code>. The macros save the information into the <code>\totlist</code> and <code>\toflist</code> macros in the form <code>\totline{label}{number}{text}</code> or <code>\tofline{label}{number}{text}</code>. The definition of <code>\totline</code> and <code>\tofline</code> is inspired by <code>\tocline</code> macro from OPmac. </p><p>The user has to write <code>\clabel[label]{text}</code> followed by the table or figure with the <code>\caption/t</code> or <code>\caption/f</code> macro. The macro <code>\caption</code> sends the information (including declared label) to the REF file using <code>\captionhook</code>. The usage can be: </p><pre class='pr-3'><code>\nonum\notoc\sec List of figures\par\toflist 
\nonum\notoc\sec List of tables\par\totlist 
 
\clabel[tabA]{Table A} 
... Table A\par\nobreak 
\caption/t This is interesting Table A. 
 
\clabel[tabB]{Table B} 
... Table B\par\nobreak 
\caption/t And this is Table B. 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#pictab' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0013</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-17'>08/17/2013</time></span> </footer></article> <article id='caplisting' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Captions for code listings</h3> <a href='#caplisting'><i class='fas fa-link'></i></a></div></header><section><p>OPmac provides two caption types Witt independent numbering: figures by the <code>\caption/f</code> and tables by the <code>\caption/t</code>. We will show how to add a&nbsp;new caption type. For example we introduce the <code>\caption/l</code> for code listings. </p><pre class='pr-3'><code>\newcount\lnum 
\def\thelnum{\thechapnum.\the\lnum} 
\sdef{mt:l:en}{Listing} \sdef{mt:l:cs}{Výpis} \sdef{mt:l:sk}{Výpis} 
\def\chaphook#1\relax{{\globaldefs=1 \chapnums}} 
\def\chapnums{\secnum=0 \seccnum=0 \tnum=0 \fnum=0 \dnum=0 \lnum=0 } 
 
\chap Test 
 
\begtt 
int main() { ... } 
\endtt 
\nobreak \label[main] 
\caption/l This is the main function listing. 
</code></pre><p>The example declares the counter <code>\lnum</code> and defines the printing format <code>\thelnum</code>. The word “Listing” is declared for three language mutations. The <code>\numl</code> counter will be reset in each chapter. </p></section><footer class='text-right'><a href='opmac-tricks.html#caplisting' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0035</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-11-29'>11/29/2013</time></span> </footer></article> <article id='capformat' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Different formatting of the table and figure captions</h3> <a href='#capformat'><i class='fas fa-link'></i></a></div></header><section><p>OPmac prints the caption with the last line of the paragraph centered. The trick from TBN, page 234, is used for this. Maybe, you want another format for captions. For example: if the caption is one line length then it is centered. Else normal paragraph is printed. The solution is here: </p><pre class='pr-3'><code>\def\printcaption#1#2{\leftskip=\iindent \rightskip=\iindent 
   \setbox0=\hbox\bgroup \aftergroup\docaption{\bf#1 #2.}\enspace} 
\def\docaption{\tmpdim=\hsize \advance\tmpdim by-2\iindent 
   \ifdim\wd0&gt;\tmpdim \unhbox0 \else \hfil\hfil\unhbox0 \fi \endgraf \egroup} 
</code></pre><p>The macro measures the length of the caption text saved in <code>\box0</code>. If it fits into one line then <code>\hfil\hfil</code> is preceded (the same value of the glue is used in <code>\parfillskip</code> inside captions by OPmac). The result is: the text is centered. If text doesn't fit into one line, nothing is preceded and normal paragraph is printed. </p><p>IMHO, the trick similar as in “last line of paragraph centered” based on negative fill values is not possible for this task. But I&nbsp;have no proof that this is impossible. If somebody found the solution or the proof of the impossibility, please give me an advice. </p></section><footer class='text-right'><a href='opmac-tricks.html#capformat' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0048</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-26'>04/26/2014</time></span> </footer></article> <article id='urlbreakpoint' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>URL hyphenation</h3> <a href='#urlbreakpoint'><i class='fas fa-link'></i></a></div></header><section><p>OPmac provides <code>\url</code> macro for printing URLs. This macro gives potential line breaks after slashes, dots, questions and equal signs. User can insert the <code>\|</code> sequences into the URL for declaration of additional allowbreaks. This macro expands to <code>\urlspecchar</code> which is defined as <code>\penalty10</code> by default. The linebreak cannot be realized in good place because only small glue stretch/schrinkability is included in URL argument. We can redefine <code>\urlspecchar</code> in order to the right margin is ragged. </p><pre class='pr-3'><code>\def\urlspecchar{\nobreak\hskip0pt plus2em \penalty110 \hskip0pt plus-2em\relax} 
</code></pre><p>This macro gives possibility to break in the <code>\penalty110</code> but the stretchable space is before this break. If the line break isn't realized then the following <code>\hskip</code> removes the values of the previous <code>\hskip</code>, so no space is printed. </p><p>Another solution of problematic URL breaking is to insert little stretchable space between each character in the URL parameter. This can be done by: </p><pre class='pr-3'><code>\addto\urlfont{\replacestrings{}{\nobreak\hskip0pt plus.05em minus.03em\relax}} 
</code></pre><p>If you remove the <code>\nobreak</code> from the code above then the <code>\url</code> parameter is breakable between all pairs of characters. </p></section><footer class='text-right'><a href='opmac-tricks.html#urlbreakpoint' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0050</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-26'>04/26/2014</time></span> </footer></article>
                            </section>  <section id="kapitoly-sekce" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Chapters, sections</h2>
                                    <a href="#kapitoly-sekce"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='seccc' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Subsubsection</h3> <a href='#seccc'><i class='fas fa-link'></i></a></div></header><section><p>There are only three levels of the titles: <code>\chap</code>, <code>\sec</code> and <code>\secc</code> in OPmac. Maybe users want to deal with sub-sub-sections, i.e. <code>\seccc</code>. </p><pre class='pr-3'><code>\newcount\secccnum 
 
\eoldef\seccc#1{% 
   \ifx\prevseccnum\theseccnum \global\advance\secccnum by1 
   \else \global\let\prevseccnum=\theseccnum \global\secccnum=1 
   \fi 
   \edef\thesecccnum{\theseccnum.\the\secccnum}% 
   \printseccc{#1\unskip}% 
} 
\def\printseccc#1{\norempenalty-100 \medskip 
   {\bf \noindent \thesecccnum\quad #1\nbpar}% 
   \nobreak \smallskip \firstnoindent 
} 
</code></pre><p>The macro solves the task most simply: the new counter <code>\secccnum</code> is introduced and the title is printed simply in <code>\bf</code> font (without scaling). The macro above doesn't solve printing the information about such sub-sub-sections in table of contents nor in running heads. If you need this then you can use the macro <code>\wcontents</code> for TOC line printing and the primitive <code>\mark</code> for running heads. </p></section><footer class='text-right'><a href='opmac-tricks.html#seccc' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0055</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article> <article id='notoc' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Different hyphenation of title in text and table of contents</h3> <a href='#notoc'><i class='fas fa-link'></i></a></div></header><section><p>The recommended macro for breaking lines in titles of chapters, sections etc. is <code>\nl</code>. This macro breaks line in the actual text of title but it expands to the space when TOC or running heads are printing. Why to specify the line break in TOC only? We can use: </p><pre class='pr-3'><code>\let\NL=\nl  \addprotect\NL 
</code></pre><p>Now, the <code>\NL</code> breaks line in the actual title and in the TOC. If we need to break in TOC only, we can create the macro <code>\toconly{text}</code> which ignores its parameter in normal title but expands to its parameter in the TOC. We can write, for example: </p><pre class='pr-3'><code>\sec Very\nl long\toconly\NL\ title 
</code></pre><p>and we get “Very long/title” in the TOC and “Very/long title” in the text. We can use the code: </p><pre class='pr-3'><code>\let\NL=\nl  \addprotect\NL 
\def\toconly#1{} \addprotect\toconly 
\let\maketocori=\maketoc \def\maketoc{{\def\toconly##1{##1}\maketocori}} 
</code></pre><p>If you want correct PDFoutlines while using <code>\toconly</code> then you can set <code>\input pdfuni</code> xor you can define <code>\def\cnvhook{\def\toconly##1{}}</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#notoc' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0057</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-12'>05/12/2014</time></span> </footer></article> <article id='part' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>New level of titles (part) in the text and in the TOC</h3> <a href='#part'><i class='fas fa-link'></i></a></div></header><section><p>We create the macro <code>\part</code> which creates a&nbsp;numbered parts of the book. These parts include chapters, sections and subsections. All levels of titles will be printed in the TOC when <code>\maketoc</code> is used. </p><pre class='pr-3'><code>\newcount\partnum 
\def\part#1\par{% 
  \chaphook {\globaldefs=1 \chapnum=0 \secnum=0 \seccnum=0 \tnum=0 \fnum=0 \dnum=0}\relax 
  \edef\thepartnum{\the\partnum}\let\thetocnum=\thepartnum 
  \vfil\break\null 
  \vskip3cm 
  \centerline{\typosize[15/18]\bf Part \uproman\partnum} 
  \wtotoc{-1}\bfshape{#1}\xdef\tocilabel{\thepartnum}% 
  \tit #1\par 
  \vfil\break 
} 
\def\printpart#1{\vfil\break\null 
   \vskip3cm 
   \centerline{\typosize[15/18]\bf Part \uproman\partnum} 
   \tit #1\par 
   \vfil\break 
} 
\def\uproman#1{\uppercase\expandafter{\romannumeral#1}} 
\let\optocline=\tocline % original OPmac \tocline is saved. 
\def\tocline#1{\ifnum#1=-1 \let\next=\ptocline \else \def\next{\optocline{#1}}\fi \next} 
\def\ptocline#1#2#3#4{\medskip 
   \def\tocilabel{#2}% 
   \centerline{#1Part \uproman{#2}}\nobreak 
   \centerline{#1#3\unskip}\nobreak 
} 
\addto\maketoc{\def\tocilabel{}} 
</code></pre><p>The macro <code>\part</code> inserts the TOC information using <code>\wtotoc</code> (supported since OPmac version Mar. 2015) to the REF file. The first parameter of <code>\wtotoc</code> is the level of the title: 0&nbsp;for chapters, 1&nbsp;for sections and 2&nbsp;for subsections. Because <code>\part</code> is above chapters, we have chosen the level -1. The macro <code>\tocline</code> is redefined here in order it runs the original <code>\tocline</code> when the level is 0, 1&nbsp;or 2, but the <code>\ptocline</code> prints two lines in the TOC when the level is -1. The label <code>\tocilabel</code> is defined as number of the part because we need to distinguish the chapter numbers when <code>\hyperlinks</code> are used. The chapter numbers alone are not unique in the whole book, so they are preceeded by <code>\tocilabel</code> when the internal hyperlink-label is created. </p><p>If we want to use <code>\part</code> with <code>\outlines</code> then we must to do more work: </p><pre class='pr-3'><code>\let\outlinesAA=\outlinesA 
\def\outlinesA#1{\ifnum#1=-1 \def\next{}\else \def\next{\outlinesAA{#1}}\fi 
\next} 
\let\outlinesBB=\outlinesB 
\def\outlinesB#1{\ifnum#1=-1 \def\next{\outlinesBp}\else 
\def\next{\outlinesBB{#1}}\fi \n 
\def\outlinesBp#1#2#3#4{\def\tocilabel{#2}% 
   \pdfoutline goto name{toc:part.#2} count 0 {PART: #3}\relax 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#part' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0099</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-15'>04/15/2015</time></span> </footer></article> <article id='notopins' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>How to prevent \topins on chapter page</h3> <a href='#notopins'><i class='fas fa-link'></i></a></div></header><section><p>We need to prevent the printing tables and figures on the top of the first page of chapter, i. e. before the chapter title. This can be done by adding the following code at the beginning of the document. </p><pre class='pr-3'><code>\addto\chaphook{\global\dimen\topins=0pt } 
\addto\endoutput{\global\dimen\topins=\vsize} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#notopins' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0135</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-12-21'>12/21/2015</time></span> </footer></article> <article id='globnonum' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Global \nonum for all chapters and sections</h3> <a href='#globnonum'><i class='fas fa-link'></i></a></div></header><section><p>We need not to write <code>\nonum</code> before each <code>\chap</code>, <code>\sec</code>, <code>\secc</code> but we need to write only one declaration at the beginning of the document. We can write </p><pre class='pr-3'><code>\nonum \def\nonumfalse{\pagedepth=\pagedepth} 
</code></pre><p>The trick is based on the deactivating of <code>\nonumfalse</code> macro which is used inside OPmac macros in order to return the <code>false</code> value to the <code>\ifnonum</code> variable. The <code>\global</code> primitive is prefixed before <code>\nonumfalse</code> macro, so we need to redefine <code>\nonumfalse</code> to another assignment. I&nbsp;chose dummy assignment applied to global register so really nothing happens. </p></section><footer class='text-right'><a href='opmac-tricks.html#globnonum' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0142</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-04-10'>04/10/2016</time></span> </footer></article>
                            </section>  <section id="pracovni-soubor" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">REF file</h2>
                                    <a href="#pracovni-soubor"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='refconsistent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Checks of REF file consistency</h3> <a href='#refconsistent'><i class='fas fa-link'></i></a></div></header><section><p>Suppose this rare case: the changes in the text influence the changes of the REF file. When changed REF file is read in the next TeX run then this influences the changes in the text and this influence changes of the REF file and so on and so on. It is not simple to solve this problem in general but we can at least to report the problem. The user can save two consecutive versions o&nbsp;REF file and he can do diff UNIX command in order to show where the problem is. He can solve such problem manually. </p><p>OPmac doesn't implement such reporting about REF file inconsistency in two consecutive TeX runs. We can add this feature by this: </p><pre class='pr-3'><code>\let\Xend=\relax 
\long\def\readREFcontents #1\Xend{\def\REFcontents{#1}} 
\openin0=\jobname.ref 
\ifeof0 \def\REFcontents{} 
\else \expandafter \readREFcontents \input \jobname.ref 
\fi 
 
\input opmac 
 
\let\endprimitive=\end 
\def\end{% 
   \ifx\wref\wrefrelax \else 
      \vfil\break 
      \immediate\write\reffile{\string\Xend} 
      \immediate\closeout\reffile 
      \let\tmpa=\REFcontents 
      \expandafter \readREFcontents \input \jobname.ref 
      \ifx\tmpa\REFcontents \message{Congratulations, references are consistent} 
      \else                 \opwarning{Inconsistent REF file, TeX me again} 
   \fi\fi 
   \endprimitive 
} 
</code></pre><p>First, the contents of the REF file from previous TeX run is saved to <code>\REFcontents</code>. This is done before <code>\input opmac</code> because OPmac reads and rewrites the REF file. Second, the <code>\end</code> is redefined in order to do more actions: the check of equivalence of the REF file is performed here. The REF file is read by the <code>\readREFcontents</code> macro. The <code>\Xend</code> separator is expected at the end of the REF file. </p></section><footer class='text-right'><a href='opmac-tricks.html#refconsistent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0045</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-05'>04/05/2014</time></span> </footer></article> <article id='qrcode' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Data of QR code in REF file</h3> <a href='#qrcode'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/qrkuk.png' alt='QRcode' title='QRcode' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>You can use <a href='ftp/olsak/makra/qrcode.tex' title='qrcode.tex'>qrcode.tex</a> package for plain TeX when you need to print QR codes. The package is available <a href='http://petr.olsak.net/ftp/olsak/makra/' title='here'>here</a>. The data from QR calculation are saved in <code>\qrdata</code> macro but the data aren't used by default in <code>qrcode.tex</code> package. If we were able to re-use this data (in next run of TeX, for example) then the speed is increased because QR calculation takes time. We use REF file for this purpose. </p><p>The <code>\qrcode</code> macro from <code>qrcode.tex</code> uses “hook” macros <code>\qrbeginhook</code> and <code>\qrendhook</code>. We redefine these macros in order to save to REF file the following information: </p><pre class='pr-3'><code>\Xqrdata{encoded-text}{size}{11111110111110...0010111001} 
</code></pre><p>where <code>size</code> and binary data are items from <code>\qrdata</code> from previous QR calculation. We need to define <code>\Xqrdata</code> in order to define the control sequence <code>\qr:encoded-text</code> as qrdata. Finally, we need to modify the <code>\qrcode</code> macro behavior: if <code>\qr:encoded-text</code> is defined then don't calculate QR code again but use the qrdata only. The implementation: </p><pre class='pr-3'><code>\def\Xqrdata{\bgroup\qrverbatim\XqrdataA} 
\def\XqrdataA#1#2#3{\sxdef{qr:#1}{{#2}{#3}}\egroup} 
\input qrcode 
\input opmac 
 
\openref 
\def\qrendhook{% 
   \qrmessage{&lt;Saving calculated QR code...}% 
      \sxdef{qr:\qretext\expandafter}{\qrdata}% 
      \toks0=\expandafter{\qrtext}% 
      \immediate\wref\Xqrdata{{\the\toks0}\qrdata}% 
   \qrmessage{done&gt;^^J}% 
} 
\def\qrbeginhook#1\qrendhook{% 
   \expandafter \ifx \csname qr:\qretext\endcsname \relax 
      #1%                  %%% do calculation 
   \else 
      \qrmessage{&lt;Restoring QR code from saved \string\qrdata...}% 
         \global\expandafter\let \expandafter\qrdata \csname qr:\qretext\endcsname 
         \qrrestore\qrdata %%% printing QR code from saved data 
      \qrmessage{done&gt;^^J}% 
   \fi 
   \qrendhook 
} 
</code></pre><p>Note that the order is important. First we need to define <code>\Xqrdata</code>, second do <code>\input qrcode</code> before <code>\input opmac</code> and finally we can redefine “hook” macros. Then the normal documment (which uses <code>\qrcode</code> macro) follows. </p></section><footer class='text-right'><a href='opmac-tricks.html#qrcode' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0116</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-02'>07/02/2015</time></span> </footer></article>
                            </section>  <section id="vyznacovani" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Printing selections</h2>
                                    <a href="#vyznacovani"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='soul' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Underlining, overlining, letterspacing</h3> <a href='#soul'><i class='fas fa-link'></i></a></div></header><section><p>We implement the macro <code>\ul{this is text}</code> which creates underlined or overlined text. We add the macro <code>\ltsp{this is text}</code> which creates letterspaced text. The features of the large LaTeX package <code>soul.sty</code> is implemented here on the ten lines of the code. The macro is unable to use hyphenation algorithm for breaking words. User can hint the text by <code>\ul{these se\-qences in\-cluded in the text}</code>. And the following <a href='#hyphprocess' title='OPmac trick 0065'>OPmac trick 0065</a> does this work automatically. </p><pre class='pr-3'><code>\def\ul#1{{\ulRedefine\leavevmode\wordscanA #1 {} }} 
\def\wordscanA#1 {\ifx^#1^\unskip\else \wordscanB#1\-\end \expandafter\wordscanA\fi} 
\def\wordscanB#1\-#2\end{\ifx^#2^\wordprintA{#1}\else 
   \wordprintB{#1}\def\next{\wordscanB#2\end}\expandafter\next\fi} 
\def\wordprintA#1{\setbox0=\hbox{#1}\hbox{\rlap{\copy0}\uline\wd0}\uline\uspace\relax} 
\def\wordprintB#1{\setbox0=\hbox{#1}\hbox{\rlap{\copy0}\uline\wd0}\-} 
\def\uline{\leaders \vrule height-1.9pt depth2.3pt\hskip} 
\def\uspace{\fontdimen2\font plus\fontdimen3\font minus\fontdimen4\font} 
\def\ulRedefine{\def~{\egroup\hbox{\rlap{\copy0}\uline\wd0}\nobreak\uline\uspace\relax 
         \setbox0=\hbox\bgroup}} 
</code></pre><p>The macro repeats the <code>\wordscanA</code> to each word in the parameter and the <code>\wordscanB</code> divides the words marked by <code>\-</code>. The whole word or its last part is printed by the <code>\wordprintA</code> macro while the parts ended by <code>\-</code> are printed by the <code>\wordprintB</code>. The <code>\uline</code> macro sets the height and the thickness of the underline or overline. The value 1.9pt and thickness 0.4pt is used in our example. The macro <code>\uspace</code> defines the size of the underlined/overlined space between words including the glue part. The example reads the same values as normal space from appropriate <code>\fontdimen</code> registers. </p><p>The tie as non-breakable space can be present in the parameter text and this is solved by <code>\ulRedefine</code> macro. We need to keep the stretch/schrinkability of this space because we don't accept the Word's feature of the nonbreakable space (that it is only in fixed size). This feature is totally bad from typographical point of view. </p><p>The macro <code>\ltps{letterspaced text}</code> works in similar way but the macros <code>\prointscanA</code> and <code>\printscanB</code> are defined differently. These macros decompose the words to the letters and add the spaces declared in <code>\ltspA</code>, <code>\ltspB</code> and <code>\ltspC</code>. </p><pre class='pr-3'><code>\def\ltsp#1{\ifhmode\hskip\ltspA \else\leavevmode\fi \wordscanA #1 {} \hskip\ltspA} 
\def\wordscanA#1 {\ifx^#1^\unskip\else \wordscanB#1\-\end \expandafter\wordscanA\fi} 
\def\wordscanB#1\-#2\end{\ifx^#2^\wordprintA{#1}\else 
   \wordprintB{#1}\def\next{\wordscanB#2\end}\expandafter\next\fi} 
\def\wordprintA#1{\letterspaceA #1{}\unskip\unpenalty\hskip\ltspB} 
\def\wordprintB#1{\letterspaceA #1{}\-} 
\def\letterspaceA#1{\if^#1^\else\hbox{#1}\nobreak\hskip\ltspC \expandafter\letterspaceA\fi} 
 
\newskip\ltspA \ltspA=6pt   % the space at beginning of the text 
\newskip\ltspB \ltspB=5pt plus2pt minus1pt  % the space between words 
\newskip\ltspC \ltspC=2pt   % the space between letters in the word 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#soul' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0063</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-06'>06/06/2014</time></span> </footer></article> <article id='hyphprocess' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Hyphenation preprocessing</h3> <a href='#hyphprocess'><i class='fas fa-link'></i></a></div></header><section><p>We create the macro <code>\hyphenprocess{word}</code> which returns its parameter in the <code>\listwparts</code> macro in the form <code>hy\-phen\-ated</code> by the actual <code>\language</code> register and by the preloaded hyphenation patterns. </p><pre class='pr-3'><code>\newdimen\hyphdim 
\let\hyphentt=\tentt  \hyphdim=\fontdimen6\hyphentt \divide\hyphdim by2 
 
\def\hyphenprocess#1{\def\tmp{#1}\let\listwparts=\undefined 
   \setbox0=\vbox\bgroup\hyphenpenalty=-10000 \hsize=0pt \hfuzz=\maxdimen 
      \edef\hychar{\hyphenchar\hyphentt=\the\hyphenchar\hyphentt}\hyphenchar\hyphentt=45 
      \def~{\nobreak\hskip.5em\relax}\tt\noindent\hskip0pt\relax #1\par \hychar 
      \hyphenprocessA 
   \expandafter\let\expandafter\listwparts\expandafter\empty 
      \expandafter\hyphenprocessB\listwparts 
} 
\def\hyphenprocessA{\setbox2=\lastbox 
   \ifvoid2 \egroup \else \unskip \unpenalty 
      \setbox2=\hbox{\unhbox2}% 
      \tmpnum=\wd2 \advance\tmpnum by100 \divide\tmpnum by\hyphdim 
      \ifx\listwparts\undefined \xdef\listwparts{,}% 
      \else \advance\tmpnum by-1 \xdef\listwparts{\the\tmpnum,\listwparts}\fi 
              \expandafter\hyphenprocessA \fi 
} 
\def\hyphenprocessB#1,{\if^#1^\expandafter\hyphenprocessC 
   \else \tmpnum=#1 \expandafter\hyphenprocessD\tmp\end 
   \fi 
} 
\def\hyphenprocessC{\expandafter\addto\expandafter\listwparts\expandafter{\tmp}} 
\def\hyphenprocessD#1#2\end{\addto\listwparts{#1}% 
   \advance\tmpnum by-1 
   \ifnum\tmpnum&gt;0 \def\next{\hyphenprocessD#2\end}% 
   \else 
   \def\tmp{#2}\def\next{\addto\listwparts{\-}\expandafter\hyphenprocessB}\fi 
   \next 
} 
</code></pre><p>The macro processes the word in the temporary <code>\vbox</code> in the font <code>\hyphentta</code> and with <code>\hsize=0pt</code>. The hyphenated word is re-boxed by <code>\hyphenprocessA</code> macro. The dimensions of these boxes are used for calculation of the number of letters in each part of the hyphenated word. These numbers are saved to the <code>\listsparts</code> macro. For example after processing the word “hyphenated” we get 2,4,, in the <code>\listwpars</code>. The last part of the word is not represented here. The macros <code>\hyphenprocessB</code>, <code>C</code> and <code>D</code> read these data and read the appropriate number of letters from the <code>\tmp</code> (where the word is saved) and save these letters into <code>\listwparts</code>. The <code>\-</code> sequence is inserted between the parts of the word. </p><p>We can improve the macro <code>\ul</code> or <code>\ltsp</code> from the previous example 0063 in order to the words are auto hyphenated in the parameters of these macros: </p><pre class='pr-3'><code>\def\wordscanA#1 {\ifx^#1^\unskip\else 
   \hyphenprocess{#1}\expandafter\wordscanB\listwparts\-\end \expandafter\wordscanA\fi} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#hyphprocess' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0065</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-07'>06/07/2014</time></span> </footer></article> <article id='coltext' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Background-colored text</h3> <a href='#coltext'><i class='fas fa-link'></i></a></div></header><section><p>There is an example about background-colored text directly in the OPmac documentation (the <code>\coloron</code> macro). But this macro creates unbreakable box with specified background. The macro <code>\coltext</code> here keeps the text breakable into lines of the paragraph. The usage is </p><pre class='pr-3'><code>\coltext\ColorA\ColorB{text} 
</code></pre><p>where <code>\ColorA</code> is the color of the text and <code>\ColorB</code> is the color of the background. For example: </p><pre class='pr-3'><code>Zde je běžný text odstavce. 
\coltext\Yellow\Blue{Tady je podbarvený textík, který se láme do řádků.} 
A pokračujeme v běžném textu odstavce. 
</code></pre><p>gives: </p><p><img src='img/coltext.png' alt='Colored text example' title='Colored text example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The macro is only a&nbsp;slight modification of the macro <code>\ul</code> from OPmac trick <a href='#soul' title='0063'>0063</a>. It uses the macro <code>\hyphencodes</code> from OPmac trick <a href='#hyphprocess' title='0064'>0064</a>. </p><pre class='pr-3'><code>\def\coltextstrut{height2ex depth.6ex} 
\def\coltext#1#2#3{{\localcolor\let\Tcolor=#1\let\Bcolor=#2\relax 
   \setbox1=\hbox{-\kern.05em}% 
   \setbox1=\hbox{{\Bcolor\vrule\coltextstrut width\wd1}\kern-.05em\llap{\Tcolor -}}% 
   \def\-{\discretionary{\copy1}{}{}}% 
   \def\uline##1{\skip0=##1\advance\skip0 by.05em 
      \Bcolor\leaders \vrule\coltextstrut\hskip\skip0 \hskip-.05em\relax}% 
   \def\uspace{\fontdimen2\font plus\fontdimen3\font minus\fontdimen4\font}% 
   \def~{\egroup\hbox{\uline{\wd0}\llap{\Tcolor\copy0}}\nobreak{\uline\uspace}\relax \setbox0=\hbox\bgroup}% 
   \leavevmode\coltextA #3 {} }} 
\def\coltextA#1 {\ifx^#1^\unskip\unskip\else 
   \hyphenprocess{#1}\expandafter\coltextB\listwparts\-\end 
\expandafter\coltextA\fi} 
\def\coltextB#1\-#2\end{\ifx^#2^\coltextC{#1}\else 
   \coltextD{#1}\def\next{\coltextB#2\end}\expandafter\next\fi} 
\def\coltextC#1{\setbox0=\hbox{#1}\hbox{\uline{\wd0}\hbox{\llap{\Tcolor\copy0}}}\uline\uspace\relax} 
\def\coltextD#1{\setbox0=\hbox{#1}\hbox{\uline{\wd0}\llap{\Tcolor\copy0}}\-} 
</code></pre><p>There is a&nbsp;difference between the <code>\ul</code> and <code>\coltext</code> macro: the order of typesetting is reverted: firstly is typeset the line and secondly the text by <code>\coltext</code> macro. And the “line” is somewhat more wide than the line in the <code>\ul</code> macro. It creates the background. The <code>\box1</code> is prepared as hyphenchar at the beginning of the macro <code>\coltext</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#coltext' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0085</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-05'>01/05/2015</time></span> </footer></article> <article id='specline' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Marginal line around selected text</h3> <a href='#specline'><i class='fas fa-link'></i></a></div></header><section><p>The user encloses the selected text by <code>\beginspec...\endspec</code>. The selected text may start in the middle of the paragraph and the last selected word can be somewhere in next paragraphs, for instance. The macro draws the line in the right margin starting from the vertical position of the first selected word and ending at the vertical position of the last selected word. </p><p>The implementation uses the pdfTeX's primitive <code>\pdfsavepos</code> and the REF file from OPmac for reading the positions of the first and the last selected word. This means that the marginal lines can be created after second run of TeX, after the data from REF file are read. The implementation follows: </p><pre class='pr-3'><code>\def\preparespec#1{\expandafter\ifx \csname spec:#1\endcsname \relax \sdef{spec:#1}{}\fi} 
\def\XspecB#1{\preparespec{\the\lastpage} 
    \expandafter\addto\csname spec:\the\lastpage\endcsname{,\specdraw{#1}}} 
\def\XspecE#1{\preparespec{\the\lastpage} 
    \expandafter\addto\csname spec:\the\lastpage\endcsname{{#1}}} 
 
\input opmac % OPmac input must be done after the \XspecB and \XspecE are defined 
 
\newif\ifspecenv \specenvfalse 
\def\beginspec{\ifspecenv \opwarning{\noexpand\beginspec inside spec environment, ignored}% 
   \else \global\specenvtrue \openref 
      \ifvmode \pdfsavepos \else \vbox to0pt{\vss\pdfsavepos\kern\ht\strutbox}\fi 
      \wref\XspecB{{\the\pdflastypos}}\fi 
} 
\def\endspec{\ifspecenv \global\specenvfalse 
      \ifvmode \pdsavepos \else\vbox to0pt{\kern\dp\strutbox \pdfsavepos\vss}\fi 
      \wref\XspecE{{\the\pdflastypos}}% 
   \else \opwarning{\noexpand\endspec outside spec environment, ignored}\fi 
} 
\def\prepghook{\moveright\hsize\vbox to0pt{\preparespec{\the\pageno} 
   \expandafter\expandafter\expandafter 
   \specdrawB\csname spec:\the\pageno\endcsname \botypos\relax}\nointerlineskip 
} 
\def\specdraw#1#2#3{\moveright 5pt\vbox to0pt{ 
   \tmpnum=\topypos \advance\tmpnum by-#1 \kern\tmpnum sp 
   \tmpnum=-#2 \advance\tmpnum by#1 \hrule height\tmpnum sp width 2pt \vss}\nointerlineskip 
   \ifx#3\relax \global\let\specdrawB=\specdrawBrun \fi 
} 
\def\specdrawB#1{} 
\def\specdrawBrun#1#2{\gdef\specdrawB##1{}\specdraw{\topypos}{#1}{#2}} 
 
\tmpdim=\pdfpageheight \advance\tmpdim by-1in \advance\tmpdim by-\voffset \edef\topypos{\number\tmpdim} 
\advance\tmpdim by-\vsize \advance \tmpdim by-\dp\strutbox \edef\botypos{\number\tmpdim} 
</code></pre><p>The macros <code>\XspecB{from}</code> and <code>\XspecE{to}</code> save the information to the macros <code>\spec:pageno</code> (where pageno is the relevant page number) when REF file is read. The information in the <code>\spec:pageno</code> is in the form: </p><pre class='pr-3'><code>,\specdraw{from}{to},\specdraw{from}{to},\specdraw{from}{to} 
</code></pre><p>The output routine uses such information in <code>\prepghook</code>: The <code>\specdrawB</code> is run followed by expanded <code>\spec:pageno</code> followed by two tokens <code>\botypos\relax</code>. In general, the <code>\specdrawB</code> only ignores the first comma and the <code>\specdraw</code> reads <code>{from}</code> and <code>{to}</code> and following comma or <code>\botypos</code> (which is ignored). The <code>\specdraw</code> draws the marginal line <code>{from}--{to}</code>. </p><p>The interesting situation is the case, when the marginal line isn't closed at the current page. Then the <code>{to}</code> parameter is missing and <code>\specdraw</code> reads <code>\botypos</code> instead <code>{from}</code>. The <code>\botypos</code> includes the bottom position of the page, so the line is normally drawn. The third (ignored) parameter is <code>\relax</code> in this case and this is an indicator for redefining the <code>\specdrawB</code> to <code>\specdrawBrun</code> for the next page. Then the next page begins by the line created by <code>\specdrawBrun</code>. As an exercise, you can think about the empty <code>\spec:pageno</code>. This works in the normal mode (no line is created) and in the interrupted-line mode too: the line is drawn from the top to the bottom. </p><p>Next exercise: modify the macro in order to it creates the colored frames around the text. Suppose the usage of <code>\begspec</code> and <code>\endspec</code> beween paragraphs in vertical mode. </p></section><footer class='text-right'><a href='opmac-tricks.html#specline' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0128</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-11-04'>11/04/2015</time></span> </footer></article>
                            </section>  <section id="makro-premety" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Macro tricks</h2>
                                    <a href="#makro-premety"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='replacestrings' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Usage of \replacestrings</h3> <a href='#replacestrings'><i class='fas fa-link'></i></a></div></header><section><p>OPmac provides the <code>\replacesrings</code> macro which is used for <code>\url</code> parameter processing. The <code>\replacestrings</code> macro replaces the substrings of the string saved in the <code>\tmpb</code> macro. The another usage of <code>\replacestrings</code> is here. I&nbsp;needed to generate the genitive of the faculty name. The faculty is set by the user only as an abbreviation (F1, F2, ..., F8). This is saved to <code>\faculty</code> toks string. The <code>\mtext</code> macro (from OPmac) converts this abbreviation to the full name of the faculty depending on the actual language. It his language id Czech then genitive of this name is different than the nominative. I&nbsp;used the following code: </p><pre class='pr-3'><code>\def\facultygenitiv{\edef\tmpb{\mtext{\the\faculty} }% 
   \replacestrings{ulta }{ulty }% 
   \replacestrings{á }{é }% 
   \tmpb} 
</code></pre><p>When the <code>\faculty={F4}</code> for example and the language is set as Czech then <code>\mtext{\the\faculty}</code> expands to the nominative: “Fakulta jaderná a&nbsp;fyzikálně inženýrská”. If the <code>\facultygenitiv</code> is used, the string above is replaced to “Fakulty jaderné a&nbsp;fyzikálně inženýrské”. The code above solves the genitive of all eight faculties at the CTU in Prague. </p></section><footer class='text-right'><a href='opmac-tricks.html#replacestrings' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0060</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-15'>05/15/2014</time></span> </footer></article> <article id='argofvector' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Calculation of the direction of given vector</h3> <a href='#argofvector'><i class='fas fa-link'></i></a></div></header><section><p>The vector in a&nbsp;plane is given. We need to find the angle between this vector and the axis <code>x</code> in degrees. This is needed when we need to rotate some graphics element (the spike of the arrow, for example) by the given direction. We create the macro </p><pre class='pr-3'><code>\calculateargofvector (X0 Y0) (X Y)  % (X0 Y0) is the origin, (X Y) is the end 
for example 
\calculateargofvector (0 0) (2 3) 
\calculateargofvector (1.1 2.7) (-4.7 6.3) 
</code></pre><p>The result is returned and saved in the macro <code>\argofvector</code>. Because TeX doesn't provide the internal functions <code>sqrt</code>, <code>arccos</code> or <code>arctan</code>, the macro is somewhat more complicated. </p><pre class='pr-3'><code>\newdimen\dimX  \newdimen\dimY 
 
\def\processatan #1 {\tmpdim=\ifx\relax#1\maxdimen \else.#1pt\fi\relax 
   \ifdim\dimY&lt;\tmpdim\expandafter\processatanE 
   \else \advance\tmpnum by1 \def\tmp{#1}\expandafter \processatan \fi} 
\def\processatanE #1\relax{} 
 
\def\calculateargofvector (#1 #2) (#3 #4){\def\tmp{0}\tmpnum=0 
   \dimX=#3pt \advance\dimX by-#1pt \dimY=#4pt \advance\dimY by-#2pt 
   \ifdim\dimX=0pt \ifdim\dimY=0pt \dimX=1pt \dimY=0pt \fi \fi 
   \ifdim\dimY&lt;0pt \dimY=-\dimY \dimX=-\dimX \advance\tmpnum by180 \fi 
   \ifdim\dimX&lt;0pt \tmpdim=\dimX \dimX=\dimY \dimY=-\tmpdim \advance\tmpnum by90 \fi 
   \ifdim\dimY&gt;\dimX \tmpdim=\dimX \advance\tmpdim by\dimY 
                   \advance\dimY by-\dimX \dimX=\tmpdim \advance\tmpnum by45 \fi 
   \ifdim\dimX&lt;63pt \multiply\dimX by256 \multiply\dimY by256 
   \else \ifdim\dimX&lt;1023pt \multiply\dimX by16 \multiply\dimY by16 \fi\fi 
   \divide\dimX by256 \divide\dimY by\dimX \multiply\dimY by256 
   \processatan 017 035 052 07 087 105 123 14 158 176 194 21 23 25 268 287 306 325 344 364 
                384 404 424 445 466 488 51 532 554 577 6 625 649 675 7 727 754 781 81 839 
                869 9 932 966 99999 {\relax} \relax 
   \edef\argofvector{\the\tmpnum}% 
   \ifdim\tmpdim=\maxdimen \tmpnum=0 \else 
      \advance\tmpdim by-.\tmp pt \advance\dimY by-.\tmp pt \multiply\dimY by10 
      \tmpnum=\dimY \divide\tmpnum by\tmpdim 
   \fi 
   \ifnum\tmpnum&gt;0 \edef\argofvector{\argofvector.\the\tmpnum}\fi 
} 
</code></pre><p>The vector is rotated by 180 or 90 degrees first in order to get it to the first quadrant. This rotation (in degrees) is added to the <code>\tmpnum</code>. Second, we rotate the vector to the first half of the first quadrant by (possibly) rotating it by 45 degrees. The vector is resized by this operation but this doesn't matter because next step is the normalization of the vector so that it has the first coordinate equal to one. This means that the Y&nbsp;coordinate of the vector is equal to the tangent of the desired angle. The tangents of the angles 1, 2, 3, ..., 45 degrees are written after <code>\processatan</code> macro. This macro finds the right value and skips the rest to the <code>\relax</code>. Finally, the linear approximation is used for the calculation of the fraction part of the angle value. </p></section><footer class='text-right'><a href='opmac-tricks.html#argofvector' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0061</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-24'>05/24/2014</time></span> </footer></article> <article id='optdef' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Defining a macro with optional parameter</h3> <a href='#optdef'><i class='fas fa-link'></i></a></div></header><section><p>We want to define the <code>\macro</code> with two various syntax of usage: </p><pre class='pr-3'><code>\macro parameters 
or 
\macro [optional] parameters 
</code></pre><p>We define the <code>\optdef</code> macro wit the following feature: </p><pre class='pr-3'><code>\optdef\macro [default] #1 #2 {opt=\opt, 1=#1, 2=#2.} 
 
\macro first second        ... expands to: opt=default, 1=first, 2=second. 
\makro [foo] third fourth  ... expands to: opt=foo, 1=third, 2=fourth. 
</code></pre><p>For example, it is possible to redefine the <code>\chap</code>, <code>\sec</code> and <code>\secc</code> macros in order to the label can be written as optional parameter: </p><pre class='pr-3'><code>\let\chapOri=\chap  \let\secOri=\sec   \let\seccOri=\secc 
\optdef\chap [] {\ifx\opt\empty\else\label[\opt]\fi \chapOri} 
\optdef\sec  [] {\ifx\opt\empty\else\label[\opt]\fi \secOri} 
\optdef\secc [] {\ifx\opt\empty\else\label[\opt]\fi \seccOri} 
</code></pre><p>The <code>\optdef</code> macro can be defined as: </p><pre class='pr-3'><code>\def\optdef#1[#2]{% 
   \def#1{\def\opt{#2}\isnextchar[{\csname oA:\string#1\endcsname}{\csname oB:\string#1\endcsname}}% 
   \sdef{oA:\string#1}[##1]{\def\opt{##1}\csname oB:\string#1\nospaceafter\endcsname}% 
   \sdef{oB:\string#1\nospaceafter}% 
} 
\def\nospaceafter#1{\expandafter#1\romannumeral-`\.} 
</code></pre><p>The <code>\optdef</code> defines <code>\macro</code> as <code>\isnextchar[{\oA:\makro}{\oB:\makro}</code> and defines <code>\oA:\makro[text]</code> as <code>\def\opt{text}\oB:\makro</code> and finally defines <code>\oB:\makro</code> as the real macro declared after <code>\optdef[default]</code>. The space (sometimes presented) after the right bracket in the macro declaration has to be ignored. This is done by the expansion of the <code>\rommannumeral-\.</code> -- this primitive expands to nothing and the possible space is consumed during this expansion. </p></section><footer class='text-right'><a href='opmac-tricks.html#optdef' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0067</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-12'>06/12/2014</time></span> </footer></article> <article id='noendspace' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Removing the last space in the parameter</h3> <a href='#noendspace'><i class='fas fa-link'></i></a></div></header><section><p>For example the parameters of <code>\chap</code>, <code>\sec</code> and <code>\secc</code> includes the unwanted space at the end. But not every time. For example <code>\sec Damned \LaTeX <empty line></code> doesn't generate the space at the end. OPmac solves the removing of this space by <code>\unskip</code> when the parameter is used. This example removes the last space at macro level. It is sufficient to save the parameter to the <code>\tmpb</code> macro by <code>\def\tmpb{#1}</code> and to do: </p><pre class='pr-3'><code>\addto\tmpb\end \replacestrings{ \end}{}\replacestrings{\end}{} 
</code></pre><p>Now, the <code>\tmpb</code> includes the parameter without the last possible space. </p></section><footer class='text-right'><a href='opmac-tricks.html#noendspace' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0068</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-13'>06/13/2014</time></span> </footer></article> <article id='eoldef' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Macro with a parameter to the end of line</h3> <a href='#eoldef'><i class='fas fa-link'></i></a></div></header><section><p>The macro <code>\eoldef</code> gives possibility to define a&nbsp;macro with one parameter separated by the end of current line. For example </p><pre class='pr-3'><code>\eoldef\foo#1{\message{param: "#1"}} 
 
\foo this is parameter 
and this is next text. 
</code></pre><p>We can see that <code>\eoldef</code> has the same syntax as <code>\def</code> for macros with one unseparable parameter, but the declared macro takes its parameter to eol. In the example above, the parameter <code>#1</code> is the text “this is parameter”. </p><p>**Warning**. Since OPmac version Apr. 2016, the <code>\eoldef</code> macro is a&nbsp;part of the OPmac macros and the macros <code>\tit</code>, <code>\chap</code>, <code>\sec</code> and <code>\secc</code> are defined by it. The previous version of these macros were simply separated by <code>\par</code>. This is not 100% backward compatible but I&nbsp;hope that the advantages beat disadvantages. Advantages: The “last-space in the parameter disappears. User can write <code>\sec something</code> as the last line in the file. Disadvantages: if your source file divides the title text to more lines then you must hide the end of each line (but not the last line) by %. If you are using <code>\sec</code> indside your own macro then you cannot write <code>... \sec#1\par ...</code> because the error message occurrs: </p><pre class='pr-3'><code>! Paragraph ended before \eoldefA was complete. 
</code></pre><p>You can use <code>\bracedparam</code> from OPmac trick <a href='#latexchap' title='0036'>0036</a> and write <code>... \bracedparam\sec{#1} ...</code> in your macro. </p><p>If you want to deactivate the EOL separation of parameters of <code>\tit</code>, <code>\chap</code>, <code>\sec</code>, <code>\secc</code> macros and to return to the original behavior (separation by empty line), you can use: </p><pre class='pr-3'><code>\def\eoldefA{\endgroup\eoldefB} 
\def\eoldefB#1#2\par{\csname\string#1:M\endcsname{#2}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#eoldef' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0121</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-08-14'>08/14/2015</time></span> </footer></article> <article id='keyval' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The key=value dictionaries</h3> <a href='#keyval'><i class='fas fa-link'></i></a></div></header><section><p>We want to set the data in the form <code>keyA=valueA</code>, <code>keyB=valueB</code> etc. i.e. the comma separated list of equations. The macro <code>\kv{key}</code> expands to the appropriate value or to <code>\kvunknown</code>, if the key is not set. The list of <code>key=value</code> pairs is read by <code>\kvscan</code> macro and it has to be terminated by comma, comma, equal sign, comma. The macros <code>\kv</code> and <code>\kvscan</code> are usable for macro programmer. For example: </p><pre class='pr-3'><code>\def\mymacrodefault          {color={}, width=0.4pt} 
\optdef\mymacro [] {\bgroup 
   \expandafter \kvscan\mymacrodefault,,=,% default values 
   \expandafter \kvscan\opt,,=,%  valuse given by user 
   \if^\kv{color}^\else \localcolor\kv{color}\fi % color setting 
   \let\vruleprimitive=\vrule 
   \def\vrule{\vruleprimitive width\kv{width}}% wule width setting 
   ... 
   \egroup 
} 
</code></pre><p>The <code>\optdef</code> macro is used here from the trick <a href='#optdef' title='0067'>0067</a>. User can write the <code>\mymacro</code> without parameters or (for example) <code>\mymacro[width=.7pt]</code> or <code>\mymacro[width=.8pt, color=\Red]</code>. </p><p>The macros <code>\kv</code> and <code>\kvscan</code> can be implemented by the code: </p><pre class='pr-3'><code>\def\kv#1{\expandafter\ifx\csname kv:#1\endcsname \relax \expandafter\kvunknown 
   \else \csname kv:#1\expandafter\endcsname\fi 
} 
\def\kvunknown{???} 
\def\kvscan #1#2=#3,{\ifx#1,\else \kvdef{kv:#1#2}{#3}\expandafter\kvscan\fi} 
\let\kvdef=\sdef 
</code></pre><p>The <code>\kvscan</code> macro reads the key in two parameters <code>#1#2</code> in order to give the possibility to ignore the spaces after commas in the comma separated list. But spaces around equal sign are not allowed. If you need to allow them then you can pre-process the list of <code>key=value</code> pairs by the code: </p><pre class='pr-3'><code>... \let\tmpb=\opt \replacestrings{ =}{=}\replacestrings{= }{=}% 
    \expandafter \kvscan\tmpb,,=,% 
</code></pre><p>You can use the following code instead <code>\let\kvdef=\sdef</code> </p><pre class='pr-3'><code>\def\kvdef#1{\expandafter\edef\csname#1\endcsname} 
</code></pre><p>if you wish to expand the values in the time of the setting. If you need to ask if the key is set already, you can use <code>\isdefined{kv:key}\iftrue</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#keyval' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0069</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-16'>06/16/2014</time></span> </footer></article> <article id='flags' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The options in key=value dictionaries</h3> <a href='#flags'><i class='fas fa-link'></i></a></div></header><section><p>We want to mix comma separated key=value items with single options, i. e. single words not followed by the equal sign and a&nbsp;value. For example: </p><pre class='pr-3'><code>\mymacroset {width=0.8pt, draft, silent} 
</code></pre><p>The <code>\replacestrings</code> can help with this task, as in the following example: </p><pre class='pr-3'><code>\def\mymacroset#1{\def\tmpb{#1,}\replacestrings{ =}{=}\replacestrings{= }{=}% 
   \replacestrings{draft,}{my-final=0,}% 
   \replacestrings{final,}{my-final=1,}% 
   \replacestrings{silent,}{my-message=0,}% 
   \replacestrings{verbose,}{my-message=1,}% 
   \expandafter\kvscan\tmpb,=,% 
   \if1\kv{my-message}\let\mymessage=\message \else \def\mymessage##1{}\fi 
   ... 
} 
\mymacroset {width=0.7pt, final, silent} % default values 
</code></pre><p>The single options are transformed internaly to key=value format and then the <code>\kvscan</code> from previous OPmac trick 0069 is used. We can ask to used option by <code>\if1\kv{...}</code> as follows: </p><pre class='pr-3'><code>\if1\kv{my-final}The "final" option was used.\else The "draft" option was used.\fi 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#flags' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0114</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-30'>06/30/2014</time></span> </footer></article> <article id='balanced' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Nested brackets of another type than {}</h3> <a href='#balanced'><i class='fas fa-link'></i></a></div></header><section><p>TeX checks the nested brackets only for one type of brackets: <code>{}</code>. OPmac uses the macros sometimes with the parameters surrounded by <code>[]</code> brackets, but hey cannot be simply nested. If you write (for example) <code>\label[a[b]c]</code> then you get the label <code>a[b</code> and the text <code>c]</code> is printed. You can check the pairs and nesting of another type of brackets than <code>{}</code> by the <code>\ensurebalanced</code> macro: </p><pre class='pr-3'><code>\def\macro[#1]{\ensurebalanced[]\macroA{#1}} 
\def\macroA#1{the parameter "#1" has balanced brackets [].} 
for example: 
\macro[a[b]c] prints: the parameter "a[b]c" has balanced brackets []. 
</code></pre><p>The <code>\label</code> macro can be redefined in order to balanced <code>[]</code> brackets can be nested: </p><pre class='pr-3'><code>\def\tmp{\def\labelA##1} 
\expandafter\tmp\expandafter{\label[#1]} 
\def\label[#1]{\ensurebalanced[]\labelA{#1}} 
</code></pre><p>The <code>\ensurebalanced</code> macro is defined by: </p><pre class='pr-3'><code>\def\ensurebalanced#1#2#3#4{% 
   \isbalanced#1#2{#4}\iftrue #3{#4}% 
   \else 
      \def\ensurebalancedA##1##2#2{% 
         \isbalanced#1#2{##1#2##2}\iftrue #3{##1#2##2}% 
         \else \def\next{\ensurebalancedA{##1#2##2}}\expandafter\next\fi 
      }% 
      \def\next{\ensurebalancedA{#4}}\expandafter\next\fi 
} 
\def\isbalanced#1#2#3\iftrue{\tmpnum=0 \isbalancedA#1#2#3\isbalanced} 
\def\isbalancedA#1#2#3{% 
    \ifx\isbalanced#3\def\next{\csname ifnum\endcsname\tmpnum=0 }% 
    \else \def\next{\isbalancedA#1#2}% 
        \isonetoken#3\iftrue 
           \ifx#3#1\advance\tmpnum by1\fi 
           \ifx#3#2\advance\tmpnum by-1\fi 
     \fi\fi\next 
} 
\def\isonetoken#1#2\iftrue{\ifx\isbalanced#2\isbalanced} 
</code></pre><p>The macro <code>\ensurebalanced</code> checks the balanced text by <code>\isbalanced</code> wit used brackets <code>[=#1</code> and <code>]=#2</code>. If the text is balanced then <code>\macroA</code> is executed, i.e #3 followed by read parameter. Else the <code>\ensurebalancedA</code> macro is executed (maybe recursively). It reads the next part of the parameter. </p></section><footer class='text-right'><a href='opmac-tricks.html#balanced' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0077</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-08-09'>08/09/2014</time></span> </footer></article> <article id='readtoks' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Reading parameter text token per token</h3> <a href='#readtoks'><i class='fas fa-link'></i></a></div></header><section><p>We create a&nbsp;macro <code>\readtoks{parameter}</code> which read its parameter token per token and does arbitrary processing for each token. The default version of the macro simply reads tokens and saves them to the <code>\readtoksO</code> token list. The usage of slight modification of this principle can be found in the next <a href='appendto' title='OPmac trick 0079'>OPmac trick 0079</a>, where <code>\readtoks</code> scans the list of the tokens and doubles the hash token (category 6) and converts the control sequence <code>\internalXpram</code> to one hash token. For example: </p><pre class='pr-3'><code>\readtoks{aha # uff {\internalXparam1 {a}} \line} 
is converted to: 
\toks1={aha ## uff {#1 {a}} \line} 
</code></pre><p>A&nbsp;slight modification of this macro is used <a href='http://tex.stackexchange.com/questions/200452/macro-parameter-delimited-by-more-than-one-delimiter' title='here'>here</a> or <a href='http://tex.stackexchange.com/questions/196776/arguments-possibly-delimited-by-bgroup-and-egroup' title='here'>here</a> at tex.stackexchange.com </p><p>The main problem of the <code>\readtoks</code> macro if the fact, that we cannot simply read token per token by the macro with one unseparated parameter because this processing consumes spaces and behaves bad when braces are occurred in the parameter. These situations need to be managed by futurelet. </p><pre class='pr-3'><code>\newtoks\readtoksT \newif\ifreadtoksG 
\def\readtoks{\begingroup \let\bgroup=\relax \let\egroup=\relax 
   \readtoksT={}\readtoksGfalse \afterassignment\readtoksA \let\next= } 
\def\readtoksA{\futurelet\tmpc\readtoksB} 
\def\readtoksB{\let\next=\readtoksD \csname readtoksX\endcsname 
   \ifcat\space\noexpand\tmpc \let\next=\readtoksC \def\nexxt{\readtoksD{ }}\fi 
   \ifcat{\noexpand\tmpc      \let\next=\readtoksC \let\nexxt=\readtoksE \fi 
   \ifcat}\noexpand\tmpc      \let\next=\readtoksC \let\nexxt=\readtoksF \fi 
   \next 
} 
\def\readtoksC{\afterassignment\nexxt \let\next= } 
\def\readtoksD#1{\readtoksT=\expandafter{\the\readtoksT#1}\readtoksA} 
\def\readtoksE{\begingroup \readtoksGtrue \readtoksT={}\readtoksA} 
\def\readtoksF{\ifreadtoksG 
   \expandafter\endgroup\expandafter\readtoksT\expandafter\expandafter\expandafter 
      {\expandafter\the\expandafter\readtoksT\expandafter{\the\readtoksT}}% 
      \expandafter\readtoksA 
   \else 
      \expandafter\endgroup\expandafter\readtoksO\expandafter{\the\readtoksT}% 
   \fi 
} 
\def\readtoksO{\toks1} 
</code></pre><p>The macro scans single tokens and runs the user defined macro <code>\readtoksX</code> where the processing for each token can be programmed. If this macro isn't defined then the <code>\readtoks</code> only saves the tokens to the output register <code>\readtoksO</code> (which is defined as <code>\toks1</code>) and the result is the same as simple setting <code>\toks1={parameter}</code>. Note how the braces are processed. If there is an open brace then we open new group by <code>\begingroup</code> and start the filling of <code>\readtoksT</code> from empty begin. The tokens between braces are saved to the <code>\readtoksT</code> in such case. When the closing brace is encountered then the actual <code>\readtoksT</code> is expanded and surrounded by braces and put after the contents of <code>\readtoksT</code> from previous processing at previous level of group. And the group is finished, of course. </p></section><footer class='text-right'><a href='opmac-tricks.html#readtoks' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0088</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-20'>01/20/2015</time></span> </footer></article> <article id='etoks' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Expandable reading text token per token</h3> <a href='#etoks'><i class='fas fa-link'></i></a></div></header><section><p>Previous OPmac trick reads the given text token per token at main processor level. Now, we'll do the same at expand processor level. There is a&nbsp;problem with spaces which are ignored by macro with non-separated parameter. So the loop: </p><pre class='pr-3'><code>\def\apply#1{[#1]} 
\def\readtokens#1{\ifx\end#1\else\apply{#1}\expandafter\readtokens\fi} 
\readtokens This is some text.\end 
</code></pre><p>behaves the same as <code>\readtokens Thisissometext.\end</code>. We need to create a&nbsp;macro which respect the spaces and it is full expandable. Moreover, the macro must respect the braces. Braces is second problem of macros with non-separated parameter: <code>{abc}</code> is read as one parameter and braces are removed. Both these problems are solved by the <code>\etoks{tokens}</code> macro which is full expandable, executes <code>\eapply</code> to each token of its parameter and respects spaces and braces. For example: </p><pre class='pr-3'><code>\def\eapply#1{[#1]} % what to do for each token 
\message{... \etoks{ab c{ aa bc {bb}}cb}} 
</code></pre><p>prints <code>... [a][b][ ][c]{[ ][a][a][ ][b][c][ ]{[b][b]}}[c][b]</code>. </p><p>The implementation: </p><pre class='pr-3'><code>\def\etoks#1{\etoksA #1{\end}} 
\def\etoksA#1#{\etoksB#1 {\end} } 
\def\etoksB#1 #2 {\etoksC#1\end 
    \ifx\end#2\empty\expandafter\etoksD\else\eapply{ }\fihere{\etoksB#2 }\fi} 
\def\etoksC#1{\ifx\end#1\else\eapply{#1}\expandafter\etoksC\fi} 
\def\etoksD#1{\ifx\end#1\empty\else\fihere{{\etoks{#1}}\etoksA}\fi} 
\def\fihere#1\fi{\fi#1} 
</code></pre><p>The code is based on the construction <code>\def\x#1#{...}</code> where <code>#1</code> is separated by open brace. The <code>\etoksB</code> reads a&nbsp;“words” separated by a&nbsp;space and <code>\etoksC</code> reads tokens of each such “word”. When all words are read then open brace follows and it is processed by <code>\etoksD</code>. The contents of the braces is processed by <code>\etoks</code> recursively here. </p></section><footer class='text-right'><a href='opmac-tricks.html#etoks' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0153</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-06'>06/06/2016</time></span> </footer></article> <article id='appendto' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>An improved \addto for macros with parameters</h3> <a href='#appendto'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\addto</code> macro form OPmac adds it parameter to the body of the given macro, but given macro have to be parameterless and without hash token of category 6. This trick suggests more general macros <code>\appendto</code> and <code>\prependto</code>. They append or prepend the parameter to the given macro and the macro can be defined with parameters. Examples of usage: </p><pre class='pr-3'><code>\def\a#1==#2{#1 is equal #2} 
\appendto\a{ and this means that #1=#2.} 
% \a is macro: #1==#2 -&gt; #1 is equal #2 and this means that #1=#2. 
\prependto\a{We have (#1) and (#2). The } 
% \a is macro: #1==#2 -&gt; We have (#1) and (#2). 
%                        The #1 is equal #2 and this means that #1=#2. 
</code></pre><p>You can set <code>\let\appendprefix=\long</code> or <code>\let\appendprefix=\global</code> in order to declare the new macro with the prefix \long or define it globally. Tip: </p><pre class='pr-3'><code>\def\appendtoprefix{\protected\long}\appendto\makro{} 
</code></pre><p>re-declares the type of the defined <code>\macro</code>. </p><pre class='pr-3'><code>\let\appendtoprefix=\relax 
\def\appendto#1#2{\appendtoA#1% 
   \appendtoprefix\expandafter\def\expandafter#1\the\toks0\expandafter 
      {\the\toks1 #2}} 
\def\prependto#1#2{\appendtoA#1\toks2={#2}% 
   \appendtoprefix\expandafter\def\expandafter#1\the\toks0\expandafter 
      {\the\toks2\expandafter\space\the\toks1}} 
\def\appendtoA#1{\edef\tmpb{\expandafter\appendtoB\meaning#1\end}% 
   \scantokens\expandafter{\expandafter\toks\expandafter0\expandafter{\tmpb}}% 
   \expandafter\replacestrings\expandafter{\string##}{\#}% 
   {\def\###1{{\noexpand\internalXparam##1}}\xdef\tmpa{\toks1={\tmpb}}}\tmpa 
   \scantokens\expandafter{\expandafter\toks\expandafter1\expandafter{\the\toks1}}% 
   \toks1=\expandafter\expandafter\expandafter{\expandafter#1\the\toks1}% 
   \expandafter\readtoks\expandafter{\the\toks1}% 
} 
\def\appendtoB#1:#2-&gt;#3\end{#2} 
\def\readtoksX{% 
   \ifcat##\noexpand\tmpc   \let\next=\readtoksC \def\nexxt{\readtoksD{########}}\fi 
   \ifx\internalXparam\tmpc \let\next=\readtoksC \def\nexxt{\readtoksD{####}}\fi 
} 
\def\internalXparam{\internalXparam} 
 
</code></pre><p>The macros <code>\appendto</code> and <code>\prependto</code> first prepare the parameter mask into <code>\toks0</code> and the macro body into <code>\toks1</code> by calling of <code>\appanedtoA</code>. The parameter mask is read from detokenized <code>\meaning</code> and it is retokenized by <code>\scantokens</code>. But the macro body is processed by slightly different way because we needn't to detokenize and tokenize it because this is error prone. We prepare an alternative of the parameter mask where each <code>#number</code> is replaced by <code>{\internalXparam number}</code> and this is temporary saved to <code>\toks1</code>. For example the parameter mask <code>#1x#2::#3</code> is converted to the <code>{\internalXparam1}x{\internalXparam2}::{\internalXpram3}</code>. This is done by <code>\replacestrings #->\#</code> and by local definition of <code>\#</code> as a&nbsp;macro which creates <code>{\internalXparam number}</code>. This special parameter mask is used after calling of the original macro during expansion of this macro. This means that <code>#1</code> is saved as <code>\internalXparam1</code>, <code>#2</code> as <code>\intenralXparam2</code> etc. The result of this expansion is processed by the <code>\readtoks</code> macro from the previous <a href='#readtoks' title='OPmac trick 0088'>OPmac trick 0088</a>. The output in <code>\toks1</code> is now the token list ready to use as the macro body in a&nbsp;new definition of the original macro. Note, that LaTeX package <code>etoolbox.sty</code> does not keep all catcodes in the macro body as our macros. Our macros are more robust. </p></section><footer class='text-right'><a href='opmac-tricks.html#appendto' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0079</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-17'>01/17/2015</time></span> </footer></article> <article id='patchto' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The \patchto macro can modify another macro</h3> <a href='#patchto'><i class='fas fa-link'></i></a></div></header><section><p>We need to implement the <code>\patchto</code> macro which replaces the text by another text in the given macro wit the syntax: </p><pre class='pr-3'><code>\patchto\macro {original text}{replaced text} 
</code></pre><p>We can use previous <a href='#appendto' title='OPmac trick 0079'>OPmac trick 0079</a> but for more simplicity we do detokenization of the macro body before replacement. The replacement is done by <code>\replacestrings</code> and the macro body is tokenized by <code>\scantokens</code>. This means that this is analogical as in LaTeX command <code>\patchcmd</code> from LaTeX's etoolbox. </p><pre class='pr-3'><code>\def\patchto#1#2#3{\appendtoA#1% 
   \edef\tmpb{\detokenize\expandafter{\the\toks1}}% 
   \edef\tmpa{\noexpand\replacestrings{\detokenize{#2}}{\detokenize{#3}}}\tmpa 
   \edef\tmpa{\noexpand\replacestrings{\string##\string##}{\string##}}\tmpa 
   \scantokens\expandafter{\expandafter\toks\expandafter1\expandafter{\tmpb}}% 
   \appendtoprefix\expandafter\def\expandafter#1\the\toks0\expandafter{\the\toks1 }} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#patchto' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0087</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-18'>01/18/2015</time></span> </footer></article> <article id='for' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The for-loop</h3> <a href='#for'><i class='fas fa-link'></i></a></div></header><section><p>We create the macro <code>\for \i=X to Y by Z {loop body}</code> which allocates the loop variable (<code>\i</code> in this example), sets it to <code>X</code> and repeats the loop body until loop variable exceedes the <code>Y</code>. The loop variable is increased by <code>Z</code> after each loop body processing. For example </p><pre class='pr-3'><code>\for \i=1 to 10 by 1 {\for \j=1 to 10 by 1 {\message{a[\the\i,\the\j]}}} 
</code></pre><p>prints <code>a[1,1] a[1,2] ... a[1,10] a[2,1] a[2,2] ... a[10,9] a[10,10]</code>. </p><p>The whole loop is hidden in the group and it begins by allocation of loop variable (first parameter). User needn't to allocate this variable explicitly. This global allocation is typically undesirable because control sequences <code>\i</code>, <code>\j</code> have another meaning defined by plainTeX. When the for-loop ends then the group is closed and the <code>\i</code>, <code>\j</code> have their original meaning. </p><p>The <code>\for</code> macro can be defined for example: </p><pre class='pr-3'><code>\def\for#1=#2to#3by#4#{\forA{#1}{#2}{#3}{#4}} 
\long\def\forA#1#2#3#4#5{\begingroup 
   {\escapechar=`\\ % allocation of #1 as counter: 
      \expandafter \ifx\csname for:\string#1\endcsname \relax 
         \csname newcount\expandafter\endcsname \csname for:\string#1\endcsname\fi 
    \expandafter}\expandafter\let\expandafter#1\csname for:\string#1\endcsname 
   #1=#2% 
   \def\forB{#5\advance#1by#4\relax \expandafter\forC}% 
   \ifnum#4&gt;0 \def\forC{\ifnum#1&gt;#3\relax\else\forB\fi}% 
   \else      \def\forC{\ifnum#1&lt;#3\relax\else\forB\fi}% 
   \fi 
   \ifnum#4=0 \let\forC=\relax \fi 
   \forC \endgroup 
} 
</code></pre><p>First, we scan parameters and we callocate (globally) the <code>\for:\i</code> variable (if <code>#1=\i</code>) or <code>\for:\j</code> varibale (if <code>#1=\j</code>) etc. This allocation is done only if the same variable were not allocated before. This means that second usage of <code>\for\i=...</code> doesn't allocate the same variable twice. Then the declared loop variable is set locally to the allocated variable (i.e. <code>\let\i=\for:\i</code>). </p><p>The second part of the macro sets the loop variable to <code>X</code>. The loop is processed by repeatedly calling of <code>\forC</code> macro. This macro does: if <code>\i</code> doesn't exeed the <code>Y</code> then do <code>\forB</code>. And \forB processes the loop body <code>#5</code>, increases loop variable by <code>Z</code> and repeats <code>\forC</code> recursively. There are two types of conditional: it depends on the fact that the <code>Z</code> is positive or negative. And if <code>Z</code> is zero then no loop is processed. </p></section><footer class='text-right'><a href='opmac-tricks.html#for' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0115</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-01'>07/01/2015</time></span> </footer></article> <article id='rep' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The loop at expand processor only</h3> <a href='#rep'><i class='fas fa-link'></i></a></div></header><section><p>While loop processing, we need to increment the loop variable and this needs setting new value. This is impossible to do it at expand processor. We show two solutions how to overcome it. The first solution uses <code>\romannumeral</code> primitive and works in classical TeX. The second solution uses <code>\numexpr</code> primitive from eTeX. It works at expand processor level. </p><p>We create the macro <code>\rep{how-many}{what}</code>. It repeats the <code>what</code> parameter <code>how-many</code> times. For example <code>\rep{5}{uf}</code> expands to <code>ufufufufuf</code>. </p><p>The <code>\rep</code> macro in classical TeX looks like: </p><pre class='pr-3'><code>\def\rep#1#2{\expandafter\repA\romannumeral#1000.{#2}} 
\def\repA#1.#2{\repB{#2}#1.} 
\def\repB#1#2{\ifx.#2\expandafter\repC\else#1\expandafter\repB\fi{#1}} 
\def\repC#1{} 
</code></pre><p>First, the <code>\rep{5}{uf}</code> expands to <code>\repA mmmmm.{uf}</code> (5-times <code>m</code>) and the parameters are reordered by <code>\repA</code> to <code>\repB {uf}mmmmm</code>. The <code>\repB</code> does the loop: it gets one <code>m</code> in each loop step and ends when period is found. </p><p>Using eTeX we can iplement the <code>\rep</code> macro as this: </p><pre class='pr-3'><code>\def\rep#1#2{\repA 0{#1}{#2}} 
\def\repA#1#2#3{\ifnum#2&gt;#1 #3\expandafter\repB\else\expandafter\repC\fi{#1}{#2}{#3}} 
\def\repB#1{\expandafter\repA\expandafter{\the\numexpr#1+1}} 
\def\repC#1#2#3{} 
</code></pre><p>In this case, the <code>\repA</code> macro does the loop with parameters <code>{how-many-pre}{how-many}{what}</code>. This macro inserts <code>what</code> to the output if <code>how-many-pre < how-many</code>. Then the macro <code>\repB</code> increments <code>how-many-pre</code> by one using <code>\numexpr</code> and repeats <code>\repA</code>. </p><p>The second solution allows to use registers or constants in <code>how-many</code> parameter, for example <code>\chardef\x=10 \rep\x{hello}</code>. The first solution needs such parameter to be prefixed by <code>\the</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#rep' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0120</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-25'>07/25/2015</time></span> </footer></article> <article id='newcommand' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>\newcommand like in LaTeX</h3> <a href='#newcommand'><i class='fas fa-link'></i></a></div></header><section><p>Maybe we need to read the LaTeX-like code where <code>\newcommand</code> is used. This macro has somewhat obscure syntax: the square bracket can follow after <code>\newcommand\macro</code> where the number of unseparated parameters are given. If second square brackets follows than the first parameter is set as optional with default value given in this second pair of square brackets. After this, the normal macro body in the braces follows. If the optional parameter is declared, then usage of the <code>\macro</code> is <code>\macro parameters</code> or <code>\macro[first-param] parameters</code>. The <code>#1</code> is given as default or by the contents in the square brackets. The normal unseparated parameters are <code>#2</code>, <code>#3</code> etc in such case. Uff. </p><p>When we needn't the checking if the macro is defined already and without starred version of the <code>\newcommand</code> then we can define: </p><pre class='pr-3'><code>\def\newcommand#1{\isnextchar[{\newcommandA#1}{\newcommandA#1[0]}} 
\def\newcommandA#1[#2]{\edef\tmpp{\ifcase#2% 
   \or1\or12\or123\or1234\or12345\or123456\or1234567\or12345678\or123456789\fi}% 
   \edef\tmpp{\expandafter\addhashs\tmpp.}% 
   \isnextchar[{\newcommandB#1}{\long\expandafter\def\expandafter#1\tmpp}% 
} 
\def\newcommandB#1[#2]{% 
   \def#1{\isnextchar[{\runcommand#1}{\runcommand#1[#2]}}% 
   \long\expandafter\def\csname\string#1X\expandafter\endcsname\tmpp 
} 
\def\addhashs#1{\ifx.#1\else #####1\expandafter\addhashs\fi} 
\long\def\runcommand#1[#2]{\csname\string#1X\endcsname{#2}} 
</code></pre><p>For illustration, suppose <code>\newcommand\macro[4]{foo}</code>. The macro <code>\newcommandA</code> reads the number of the parameters in <code>#2</code> and this number is converted to <code>#1#2#3#4</code> into <code>\tmpp</code> macro. Because the optional parameter isn't declared the <code>\macro</code> (i.e <code>#1</code>) is defined directly. If the optional parameter is declared then the control sequence <code>\\macroX</code> is defined as the real macro. And the <code>\macro</code> is defined as <code>\isnextchar[...</code> </p></section><footer class='text-right'><a href='opmac-tricks.html#newcommand' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0086</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-09'>01/09/2015</time></span> </footer></article> <article id='lipsum' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Testing text Lorem ipsum dolor sit</h3> <a href='#lipsum'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes we need to put a&nbsp;text with no extra meaning to the typesetting area just for testing. Such texts can be generated by the macro <code>\lipsum[number]</code> or <code>\lipsum[from-to]</code>. For example: </p><pre class='pr-3'><code>\lipsum[13] 
\lipsum[3-27] 
</code></pre><p>The parameter is the number (numbers) from the range 1&nbsp;to 150 because there are 150 prepared paragraphs in the file <code>lipsum.sty</code>. The chosen paragraph (paragraphs) is (are) printed. </p><pre class='pr-3'><code>{\long\def\lipsumskip#1\newcommand\lipsum@i{\newcommand\lipsum@i} 
 \def\lips@par{\lipsumpar}\let\lipsumpar=\relax 
 \def\newcommand#1#{\advance\tmpnum by1 \sxdef{lips:\the\tmpnum}} 
 \tmpnum=0 
 \expandafter\lipsumskip\input lipsum.sty } 
\def\lipsum[#1]{\lipsumA #1\empty-\empty\end} 
\def\lipsumA #1-#2\empty#3\end{\tmpnum=#1 \edef\tmp{\ifx^#2^#1\else#2\fi}% 
   \loop \csname lips:\the\tmpnum\endcsname 
         \ifnum\tmpnum&lt;\tmp \advance\tmpnum by1 \repeat 
} 
\let\lorem=\lipsum 
\let\lipsumpar=\par 
</code></pre><p>The macro reads an existing file <code>lipsum.sty</code> from LaTeX distribution. The file includes the desired texts. The macro skips the unusual macros from the file first and then the texts are read by the redefined <code>\newcommand</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#lipsum' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0100</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-15'>04/15/2015</time></span> </footer></article> <article id='showif' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Hidden text from unprivileged readers</h3> <a href='#showif'><i class='fas fa-link'></i></a></div></header><section><p>We need to print some text only if the mentioned reader is allowed to print it. We can select a&nbsp;reader <code>who</code> as allowed reader by the macro <code>\showallow{who}</code>. We can select another allowed readers (if needed) by more <code>\showallow</code> commands. Then the command </p><pre class='pr-3'><code>\showif {admin,students} {text} 
</code></pre><p>prints the <code>text</code> only if at least one of the mentioned readers (in the comma separated list) is allowed by previous <code>\showallow</code>. The macro works at expansion level only. It means that it expands to <code>{text}</code> if the condition above is passed else it expands to nothing. </p><pre class='pr-3'><code>\showifbegin {admin,students,others} 
text 
\showifend 
</code></pre><p>This construction expands to the pure text (not <code>{text}</code>) under the same circumstances: only if at least one mentioned reader is allowed. The verbatim constructions in the text parameter are possible. </p><p>I&nbsp;did do this implementation during the talk by Boris Veytsman “TeX and controlled access to information” at <a href='https://tug.org/tug2015/program.html' title='TUG 2015'>TUG 2015</a> because I&nbsp;was inspired by his idea. </p><pre class='pr-3'><code>\def\showif#1{\showifA#1,s:!,} 
\def\showifbegin#1{\showifA#1,l:!,} 
\def\showifA#1#2,{\expandafter\ifx\csname s:#1#2\endcsname\relax 
   \expandafter\showifA \else \csname s:#1#2\expandafter\endcsname \fi} 
\long\def\showifT#1:!,{\romannumeral-`\.} 
\long\expandafter\def\csname s:s:!\endcsname#1{} 
\long\expandafter\def\csname s:l:!\endcsname#1\showifend{} 
\def\showifend{} 
 
\def\showallow#1{\expandafter\let\csname s:#1\endcsname=\showifT} 
\def\showdeny#1{\expandafter\let\csname s:#1\endcsname=\relax} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#showif' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0117</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-22'>07/22/2015</time></span> </footer></article> <article id='plists' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Linked lists</h3> <a href='#plists'><i class='fas fa-link'></i></a></div></header><section><p>We implement (as an exercise) the linked lists structure in TeX. The macro <code>\addtolist{name}{data}</code> adds new node with the <code>data</code> to the end of the list <code>name</code> (if the list <code>name</code> is empty then the first node is created). Each node points to the previous and next nodes in the list. The macro <code>\printlist{name}</code> expands to the list of data separated by <code>\seplist</code> in the order from first to the last node of the list <code>name</code>. The macro <code>\printlistrev{name}</code> does the same but expands in reverse order from the last node to the first. These macros work at expand processor level. </p><pre class='pr-3'><code>\newcount\listnum 
 
\def\addtolist#1#2{\advance\listnum by1 
   \expandafter\ifx\csname l:#1:1\endcsname \relax 
      \setlistnode \relax \relax {#2}{\the\listnum}% 
      \expandafter\edef\csname l:#1:0\endcsname{\the\listnum}% 
   \else 
      \edef\lastnodenum{\csname l:#1:1\endcsname}% 
      \expandafter\resetlistnode \csname l:\the\listnum\endcsname 2\lastnodenum 
      \expandafter\setlistnode \csname l:\lastnodenum\endcsname \relax {#2}{\the\listnum}% 
   \fi 
   \expandafter \edef\csname l:#1:1\endcsname{\the\listnum}% 
} 
\def\setlistnode #1#2#3#4{\expandafter\def\csname l:#4\endcsname{#1#2{#3}}} 
\def\resetlistnode #1#2#3{\def\tmp{\expandafter\def\csname l:#3\endcsname}% 
   \expandafter\expandafter\expandafter\resetlistnumA \csname l:#3\endcsname #2#1} 
\def\resetlistnumA #1#2#3#4#5{\ifcase #4\or\tmp{#5#2{#3}}\or\tmp{#1#5{#3}}\or\tmp{#1#2{#5}}\fi} 
 
\def\printlist#1{\expandafter\ifx\csname l:#1:0\endcsname \relax \else 
   \expandafter\expandafter\expandafter\printlistA 
      \csname l:\csname l:#1:0\endcsname\expandafter\endcsname \fi} 
\def\printlistA#1#2#3{#3\ifx#2\relax \else \listsep 
   \expandafter\expandafter\expandafter\printlistA\expandafter#2\fi} 
 
\def\printlistrev#1{\expandafter\ifx\csname l:#1:1\endcsname \relax \else 
   \expandafter\expandafter\expandafter\printlistAr 
      \csname l:\csname l:#1:1\endcsname\expandafter\endcsname \fi} 
\def\printlistAr#1#2#3{#3\ifx#1\relax \else \listsep 
   \expandafter\expandafter\expandafter\printlistAr\expandafter#1\fi} 
 
\def\listsep{;} 
</code></pre><p>The list <code>name</code> is implemented as a&nbsp;couple of two macros <code>\l:name:0</code> (includes the number of the first node) and <code>\l:name:1</code> (includes the number of the last node). Each node is the macro with name <code>\l:number</code> and with the contents <code>{\prev \next {data}}</code>. The number is unique for each node and the <code>\prev</code> and <code>\next</code> items are another control sequences of the type <code>\l:number</code> and they are the previous and next node in the list or <code>\relax</code>, if there is no previous or next node. </p><p>The temporary macro <code>\setlistnode\prev\next{data}{number}</code> creates the next node <code>\l:number</code> with given contents. The temporary macro <code>\resetlistnode{what}{how}{number}</code> replaces only one item in the <code>\l:number</code> node by <code>what</code>. Which item it is depends on the <code>how</code> which is the nuber from 1&nbsp;to 3. For example <code>\resetlistnode{data}3{number}</code> sets new data to the node <code>number</code> and keeps the pointers <code>\prev</code> and <code>\next</code> untouched. </p></section><footer class='text-right'><a href='opmac-tricks.html#plists' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0118</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-22'>07/22/2015</time></span> </footer></article> <article id='revlist' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The list expanded in revesed order</h3> <a href='#revlist'><i class='fas fa-link'></i></a></div></header><section><p>If we need to expand a&nbsp;list of items in reversed order then we needn't to create the linked list from <a href='#plists' title='previous OPmac trick'>previous OPmac trick</a>. The linked list was mentioned only as an academical problem. We can write, for example </p><pre class='pr-3'><code>\revlist{aa,bb,ccc,dddd} 
</code></pre><p>and we get the output <code>dddd,ccc,bb,aa</code> at expansion level, if the <code>\revlist</code> is implemented by: </p><pre class='pr-3'><code>\def\revlist#1{\revlistA{}#1,,} 
\def\revlistA#1#2,{\ifx,#2,\expandafter\revlistB\else \expandafter\revlistA\fi {#2,#1}} 
\def\revlistB#1{\revlistC #1,} 
\def\revlistC,#1,,{#1} 
</code></pre><p>Let <code>n</code> denotes the number of items to be reversed. The <code>\revlist</code> macro has its complexity <code>n^2</code> but linked list can be read in reversed order in linear complexity. On the other hand we need to allocate <code>n</code> control sequences in linked list but only four control sequences when <code>\revist</code> macro is used. This is usual dilemma between speed and memory demands. </p></section><footer class='text-right'><a href='opmac-tricks.html#revlist' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0119</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-07-22'>07/22/2015</time></span> </footer></article> <article id='sb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Normal underscore outside the math mode</h3> <a href='#sb'><i class='fas fa-link'></i></a></div></header><section><p>The catcode of the <code>_</code> (underscore) is set to 8&nbsp;in plain TeX, so it can be used as a&nbsp;constructor of subscripts in math mode. But the usage of such character outside math mode gives an error. It is less known that you can set normal catcode to underscore (for example 12) but this character works as subscripts constructor in math mode constantly. You can try: </p><pre class='pr-3'><code>\catcode`_=13 \let_=\sb \catcode`_=12 
 
% test: 
Here is {\tt foo_bar}. And math mode still works: $a_i^2$. 
</code></pre><p>The main idea is that mathcode of underscore is set to <code>"8000</code> by plain TeX, so this character behaves as an active character in math mode and only in math mode. Plain TeX sets catcode of the <code>_</code> to 8, so the mathcode <code>"8000</code> of this character isn't used (it works only for characters of catcode 11 or 12). The “active behavior” of undescore is declared as <code>\sb</code> and <code>\sb</code> is an alternative to the character of catcode 8, i.e. math subscripts constructor. The result: underscore works as math subscripts constructor only in math mode. </p><p>The simple line of code mentioned above gives freedom to the undercore character outside the math mode, but it cannot work porperly if a&nbsp;font with Knuth's obscure encoding is used. This is typical for default fonts CM with one exception: the <code>\tt</code> font respects ASCII encoding. Knuth decided (unfortunately) that ASCII slot for undercore is used for dot accent in other CM fonts. You can leave such curiously encoded fonts for example when you load OTF font in Unicode (in XeTeX) or T1 encoded font (in pdfTeX). If you are using csplain with UTF-8 support then you can do this by adding the following lines at beginning of your document: </p><pre class='pr-3'><code>in pdfTeX:  \input t1code  % T1 encoding is set 
            \input lmfonts % LM fonty (alternative of CM fonts) in T1 encoding 
 
in XeTeX:   \input ucode   % Unicode encoding is set 
            \input lmfonts % LM fonty (alternative of CM fonts) in Unicode 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#sb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0156</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-09'>06/09/2016</time></span> </footer></article> <article id='stripspace' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Stripping last space from parameter</h3> <a href='#stripspace'><i class='fas fa-link'></i></a></div></header><section><p>When a&nbsp;parameter (for example separated by <code>\par</code>) is read then we cannot be sure that there is or isn't a&nbsp;last space in such parameter. We create the expandable macro <code>\stripspace</code> which removes the last space if exists. Another spaces inside the parameter are untouched. Example of usage: </p><pre class='pr-3'><code>\def\foo#1\par{% maybe #1 ends by an unwanted space 
    \stripspace\fooA{#1}} 
\def\fooA#1{% now, #1 does not include the terminating space. 
    ... \message{"#1"}} 
</code></pre><p>The <code>\stripspace</code> macro has the following code: </p><pre class='pr-3'><code>\def\stripspace#1#2{\stripspaceA#2\end/ \end/!#1{#2}} 
\def\stripspaceA#1 \end/#2!#3#4{% 
   \ifx!#2!\stripspaceB{#3{#4}}\else\stripspaceB{#3{#1}}\fi 
} 
\def\stripspaceB#1#2\fi{\fi#1} 
</code></pre><p>The <code>\end/␣\end/</code> is added at the end of parameter <code>#1</code> and this parameter is scanned again separated by <code>␣\end/</code>. If the rest is empty, then <code>#1</code> is without terminating space else <code>#1</code> includes terminating space. </p></section><footer class='text-right'><a href='opmac-tricks.html#stripspace' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0164</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-10-29'>10/29/2017</time></span> </footer></article> <article id='varsep' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Variant separators of parameters</h3> <a href='#varsep'><i class='fas fa-link'></i></a></div></header><section><p>We can use more variant separators of a&nbsp;queue of parameters. For example comma, semicolon and <code>--</code>. We need to process each parameter individually. For example: </p><pre class='pr-3'><code>\macro {AAA,BBB;CCC--DDD,EEE} 
</code></pre><p>must be processed by </p><pre class='pr-3'><code>\macroX{AAA}{,}\macroX{BBB}{;}\macroX{CCC}{--}\macroX{DDD}{,}\macroX{EEE}{} 
</code></pre><p>The <code>\macroX</code> gets the separated parameter in <code>#1</code> and used separator in <code>#2</code>. </p><p>We solve this problem using <code>\replacestrings</code> macro. Each separator is replaced by the <code>&</code> character followed by the separator. Next, we read parameters separated by <code>&</code> and the original separator follows immediately. The definition of the <code>\macro</code> from previous example can look like: </p><pre class='pr-3'><code>\def\macro#1{\def\tmpb{#1}% 
   \replacestrings {,}  {&amp;,}% 
   \replacestrings {;}  {&amp;;}% 
   \replacestrings {--} {&amp;{--}}% 
   \expandafter\macroA\tmpb&amp;{}% 
} 
\def\macroA#1&amp;#2{\macroX{#1}{#2}\ifx&amp;#2&amp;\else\expandafter\makroA\fi} 
</code></pre><p>Note that the composed separator (from more than one token) must be placed in braces when <code>\replacestrings</code> is used. And the final parameter has no separator, so <code>#2</code> in <code>\macroX</code> is empty. </p></section><footer class='text-right'><a href='opmac-tricks.html#varsep' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0165</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-10-29'>10/29/2017</time></span> </footer></article> <article id='vardelim' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Parameter delimited by variant separator</h3> <a href='#vardelim'><i class='fas fa-link'></i></a></div></header><section><p>The previous OPmac trick 0165 reads a&nbsp;block of parameters and then the parameters are separated in such block. We need another approach when we are reading only one parameter separated by variant separator and then the next text must be processed normally. </p><p>For example, <code>\mymacro</code> have to read a&nbsp;text to the end of current paragraph or to the <code>\enditems</code> token. We can use <code>\vardelim{list of separators}</code> as an prefix of <code>\def\mymacro</code> or <code>\edef\mymacro</code> which is defined with one nonseparated parameter. </p><pre class='pr-3'><code>\vardelim{\par\enditems}\def\mymacro#1{\message{param:"#1"}} 
 
usage: \mymacro text text 
       \enditems 
</code></pre><p>The <code>#1</code> includes <code>text text </code> in this example and the reading of the parameter is finished by <code>\enditems</code>. Warning: the delimiter is kept in the input queue and it is processed after <code>\mymacro</code> is executed. This is important difference from usage of <code>\def\foo#1\separator{...}</code>. If you need to remove the separator, then yo can define <code>\mymacro</code> with two parameters: </p><pre class='pr-3'><code>\vardelim{\par\enditems}\def\memakro#1#2{\message{param:"#1", separator: "\noexpand#2"}} 
</code></pre><p>The variant separator must be sigle token in the solution here. If you need more complex macros with multiple-token separators and with more variants then you can use my solution presented <a href='https://tex.stackexchange.com/questions/200452/' title='here at TeX stackexchange'>here at TeX stackexchange</a> </p><pre class='pr-3'><code>\long\def\vardelim#1#2#3{% 
   \def#3{\expandafter\vardelimA\csname var\string#3\endcsname{#1}}% 
   \long\expandafter#2\csname var\string#3\endcsname 
} 
\long\def\vardelimA#1#2{\bgroup \let\bgroupT=\bgroup \let\bgroup=\relax \def\tmp{}% 
   \def\vardelimF##1\vardelimN{\fi\expandafter\egroup\expandafter#1\expandafter{\tmp}}% 
   \def\vardelimP{}% 
   \vardelimB#2\vardelimB 
} 
\long\def\vardelimB#1{% 
   \ifx\vardelimB#1\expandafter\vardelimC\else 
      \addto\vardelimP{\vardelimH#1}\expandafter\vardelimB \fi 
} 
\def\vardelimC{\futurelet\next\vardelimD} 
\def\vardelimD{% 
   \ifx\next\bgroupT \vardelimG \fi 
   \expandafter\ifx\space\next \vardelimS \fi 
   \vardelimP 
   \vardelimN 
} 
\long\def\vardelimG#1\vardelimN#2{\fi\addto\tmp{{#2}}\vardelimC} 
\def\vardelimS#1\vardelimN{\fi\addto\tmp{ }\afterassignment\vardelimC\let\next= } 
\long\def\vardelimN#1{\addto\tmp#1\vardelimC} 
\long\def\vardelimH#1{\ifx\next#1\vardelimF\fi} 
</code></pre><p>The macro reads the parameter token per token {the exception is the token list in the braces} and saves it to <code>\tmp</code> macro. Then the defined macro is processed with <code>{expanded \tmp}</code> as its parameter. The macro works like the <code>\long</code> prefix was used. </p></section><footer class='text-right'><a href='opmac-tricks.html#vardelim' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0166</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2018-04-07'>04/07/2018</time></span> </footer></article>
                            </section>  <section id="struktura" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Markup</h2>
                                    <a href="#struktura"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='latexchap' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>LaTeX markup of chapters and sections</h3> <a href='#latexchap'><i class='fas fa-link'></i></a></div></header><section><p>Some text editors are able hide or extract the whole text of chapters, sections, subsections etc. and provides the clickable tree oriented menu for this. Unfortunately, OPmac is here 30 years later than LaTeX and editors don't support the structure markup of chapters, sections and subsections given by OPmac today. If you needn't to solve the reconfiguration of your text editor, you can simply define the basics macros and use the LaTeX markup. For example: </p><pre class='pr-3'><code>\def\bracedparam#1{\csname\string#1:M\endcsname} 
\def\chapter{\bracedparam\chap} 
\def\section{\bracedparam\sec} 
\def\subsection{\bracedparam\secc} 
</code></pre><p>If somebody will tune the configuration of used text editor in order to it accepts the OPmac markup, I'll welcome information about it and I'll give the link at my web pages to such solution with pleasure. </p></section><footer class='text-right'><a href='opmac-tricks.html#latexchap' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0036</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-01-29'>01/29/2014</time></span> </footer></article> <article id='sec' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Name conflict with \sec macro</h3> <a href='#sec'><i class='fas fa-link'></i></a></div></header><section><p>OPmac redefines the plain TeX original <code>\sec</code> (secans) to <code>\sec</code> (section). This was an intention of OPmac author because the original meaning <code>\sec</code> (like secans) is almost not used anytime. On the other hand, if you need to use <code>\sec</code> as secans in math mode and <code>\sec</code> as section outside math mode then you can do this by: </p><pre class='pr-3'><code>\let\section=\sec 
\def\secans{\mathop{\rm sec}\nolimits} 
\def\sec{\relax\ifmmode\secans \else \expandafter\section\fi} 
\addprotect\sec 
</code></pre><p>Note that <code>\sec</code> is <code>\addproteced</code>. The reason is for working <code>$\sec$</code> in table of contents, for example: </p><pre class='pr-3'><code>\sec The meaning of the math function $\sec$ 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#sec' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0129</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-11-05'>11/05/2015</time></span> </footer></article>
                            </section>  <section id="jazyky" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Languages</h2>
                                    <a href="#jazyky"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='multilang' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Multilingual texts</h3> <a href='#multilang'><i class='fas fa-link'></i></a></div></header><section><p>OPmac generates the words Chapter/Kapitola/Kapitola, Table/Tabulka/Tabuľka and Figure/Obrázek/Obrázok. There are three variants of each word for English, Czech and Slovak languages. The right variant is used dependent on the current value of the <code>\language</code> register. How to add or modify these words by <code>\sdef</code> can be found in the documentation. </p><p>The templates <a href='custyle.html' title='CUstyle'>CUstyle</a> and <a href='ctustyle.html' title='CTUstyle'>CTUstyle</a> use much more words in three language variants. I&nbsp;used a&nbsp;shorthand macro <code>\mtdef</code> instead or repeated use of <code>\sdef</code>: </p><pre class='pr-3'><code>\def\slet#1#2{\expandafter\let\csname#1\expandafter\endcsname\csname#2\endcsname} 
\def\mtdef#1#2#3#4{\sdef{mt:#1:en}{#2} \sdef{mt:#1:cs}{#3} 
  \if$#4$\slet{mt:#1:sk}{mt:#1:cs}\else \sdef{mt:#1:sk}{#4}\fi} 
 
\mtdef {abstract}     {Abstract}          {Abstrakt}       {} 
\mtdef {author}       {Author}            {Autor}          {} 
\mtdef {thanks}       {Acknowledgement}   {Poděkování}     {Poďakovanie} 
\mtdef {declaration}  {Declaration}       {Prohlášení}     {Prehlásenie} 
\mtdef {keywords}     {Keywords}          {Klíčová slova}  {Kľúčové slová} 
\mtdef {title}        {Title}             {Název práce}    {Názov práce} 
\mtdef {contents}     {Contents}          {Obsah}          {} 
\mtdef {tables}       {Tables}            {Tabulky}        {Tabuľky} 
\mtdef {figures}      {Figures}           {Obrázky}        {} 
\mtdef {supervisor}   {Supervisor}        {Vedoucí práce}  {Vedúci práce} 
\mtdef {supervisorD}  {Supervisor}        {Školitel}       {Školiteľ} 
\mtdef {bibliography} {References}        {Literatura}     {Literatúra} 
\mtdef {appendix}     {Appendix}          {Příloha}        {Príloha} 
\mtdef {specifi}      {Specification}     {Zadání}         {Zadanie} 
 
\mtdef {B} {Bachelor's thesis} {Bakalářská práce}  {Bakalárska práca} 
\mtdef {M} {Master's thesis}   {Diplomová práce}   {Diplomová práca} 
\mtdef {D} {Ph.D. thesis}      {Dizertační práce}  {Dizertačná práca} 
</code></pre><p>If the item for Slovak language is missing then it means that it ti the same as for Czech language. </p><p>The word is specified by the <code>\mtext</code> macro, for example <code>\mtext{abstract}</code>, <code>\mtext{author}</code>, <code>\mtext{B}</code> etc. The right variant is used depending on the <code>\ehyph</code>, <code>\chyph</code> or <code>\shyph</code> switchers, i.e. depending on the <code>\language</code> register. </p></section><footer class='text-right'><a href='opmac-tricks.html#multilang' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0014</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-17'>08/17/2013</time></span> </footer></article> <article id='nextlang' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Adding a new language</h3> <a href='#nextlang'><i class='fas fa-link'></i></a></div></header><section><p>The language management is described in the file <code>hyphen.lan</code> from CSplain package. For the following example we suppose, that the German and Polish languages are added. The <code>\delang</code> and <code>\pllang</code> hyphenation selectors are available after that. We can enlarge the <code>\mtdef</code> macro from previous OPmac trick, we create <code>\mtdefx</code> and we put the word variants in the new languages. </p><pre class='pr-3'><code>\sdef{lan:21}{de}  \sdef{lan:121}{de} 
\sdef{lan:23}{pl}  \sdef{lan:123}{pl} 
\def\mtdefx#1#2#3{\sdef{mt:#1:de}{#2}\sdef{mt:#1:pl}{#3}} 
 
             % German              % Polish 
\mtdefx {D}  {Ph.D. Dissertation}  {Praca doktorska} 
... 
</code></pre><p>When the <code>\pllang</code> is active (for example) then <code>\mtext{D}</code> expands to the phrase “Praca doktorska”. </p></section><footer class='text-right'><a href='opmac-tricks.html#nextlang' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0049</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-26'>04/26/2014</time></span> </footer></article> <article id='Uppercase' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Uppercase of German ß</h3> <a href='#Uppercase'><i class='fas fa-link'></i></a></div></header><section><p>The UTF-8 character ß is encoded by <code>\ss</code> control sequence in CSplain by encTeX. If we need to print texts converted to upper case, we need to change the ß to SS. This can be done by: </p><pre class='pr-3'><code>\def\Uppercase#1{\begingroup 
   \def\ss{SS}\uppercase{\edef\tmp{#1}}% 
   \expandafter\endgroup\tmp 
} 
 
\Uppercase{Mainstraße} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#Uppercase' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0083</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-12-20'>12/20/2014</time></span> </footer></article> <article id='exseven' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Uppercase \mtext phrases</h3> <a href='#exseven'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\mtext{id}</code> is expanded to the right text in three expansion steps: </p><pre class='pr-3'><code>\mtext{id} -&gt; \csname mt:id:\csname lan:\the\language\endcsname\endcsname 
\csname mt:id:\csname lan:\the\language\endcsname\endcsname -&gt; \mt:id:cs 
\mt:id:cs -&gt; the declared text 
</code></pre><p>If we need to convert the declared text to upper case, we need to do it by seven <code>\expandafter</code>'s: </p><pre class='pr-3'><code>\def\exseven{\expandafter\expandafter\expandafter 
             \expandafter\expandafter\expandafter\expandafter} 
...\uppercase\exseven{\mtext{id}}... 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#exseven' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0091</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-25'>01/25/2015</time></span> </footer></article> <article id='hebrew' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Hebrew -- right to left typesetting</h3> <a href='#hebrew'><i class='fas fa-link'></i></a></div></header><section><p>The right to left typesetting is possible by TeXXeT module which is a&nbsp;part of eTeX extension of pdfTeX, for example. CSplain is usually initialized with eTeX extension, so this module is available. The TeXXeT module works with <code>\beginR...\endR</code> commands where right to left typesetting is done, but you need to initialize this by <code>\TeXXeTstate=1</code> at the beginning of your document. </p><p>We prepare the macros <code>\hebrew{...text in Hebrew...}</code> and <code>\hebrewpar{... more paragraphs in Hebrew ...}</code> for typesetting a&nbsp;short parts of text in Hebrew language. We use 8bit font <code>rcjhbltx.tfm</code> which is available in TeX distributions and pdfTeX is able to work with it. The UTF-8 to font encoding is processed by encTeX. </p><p>Note: You type the Hebrew characters in the normal order in the UNICODE text editor, but the editor prints the text in reversed order on the screen because it is well known what UNICODE characters can be printed in this reversed order. The characters are saved in normal order into the file. This is reason, why we need to reverse them again in TeX by <code>\beginR...\endR</code> commands. </p><pre class='pr-3'><code>\TeXXeTstate=1 
\font\hebrewfont=rcjhbltx 
\def\texthebrew#1{\leavevmode\beginR{\hebrewfont#1}\endR} 
\long\def\hebrewpar#1{\par\hbox{\beginR\vbox{\hebrewfont#1}\endR}} 
 
%      sequvence            UTF-8 code                               code in the font 
\mubyte\HEBalef             ^^d7^^90\endmubyte      \chardef\HEBalef              39 
\mubyte\HEBbet              ^^d7^^91\endmubyte      \cahrdef\HEBbet               98 
... 
\mubyte\HEBshin             ^^d7^^a9\endmubyte      \chardef\HEBshin             152 
\mubyte\HEBshinshindotdages ^^ef^^ac^^ab\endmubyte  \chardef\HEBshinshindotdages 153 
... 
</code></pre><p>The code in the font can be found out in the file <code>cjhebltx.enc</code> which is a&nbsp;part of the TeX distributions. If you are lazy to find UTF-8 codes of all Hebrew alphabet and you are able to write the raw Hebrew characters in the text editor then you can declare the encoding by writing these raw characters directly (without knowledge of their UTF-8 codes). The abbreviation heb-char is used instead raw Hebrew characters in the following example because this WWW page doesn't support Hebrew characters. </p><pre class='pr-3'><code>\mubytein=0 
%      sequvence           raw character                         code in the font 
\mubyte\HEBalef             heb-char\endmubyte  \chardef\HEBalef              39 
\mubyte\HEBbet              heb-char\endmubyte  \cahrdef\HEBbet               98 
... 
\mubyte\HEBshin             heb-char\endmubyte  \chardef\HEBshin             152 
\mubyte\HEBshinshindotdages heb-char\endmubyte  \chardef\HEBshinshindotdages 153 
... 
\mubytein=1 
</code></pre><p>If somebody is willing to release the whole encoding file of Hebrew characters using this OPmac trick, I'll be happy to give the link here. </p><p>The similar technique (but without right to left typesetting) is used in the file <code>cyrchars.tex</code> for Cyrillic characters. This file is the part of the CSplain package and the documentation and examples are included in this file. </p></section><footer class='text-right'><a href='opmac-tricks.html#hebrew' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0092</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-01-26'>01/26/2015</time></span> </footer></article>
                            </section>  <section id="matematicka-sazba" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Math</h2>
                                    <a href="#matematicka-sazba"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='alphachars' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Czech texts in math</h3> <a href='#alphachars'><i class='fas fa-link'></i></a></div></header><section><p>The accented characters from Czech alphabet (č, á, ř etc.) don't work in math because they have no class 7&nbsp;and they are no a&nbsp;part of the math alphabet. In the fraction <code>$cena \over výkon$</code> (i.e. <code>$price \over performance$</code>) we need to print the texts in script size. The solution <code>$\hbox{cena}\over\hbox{výkon}$</code> doesn't set the right size of the texts. The solution <code>$\rm cena\over výkon$</code> does work with CSfonts but when we switch to another font family, the ý will not print. We can put the Czech alphabet into math class 7&nbsp;by: </p><pre class='pr-3'><code>\def\setmathalphabetcode#1{\ifx\XeTeXmathcode\undefined 
     \tmpnum=\itfam \multiply\tmpnum by256 \advance\tmpnum by`#1 
     \advance\tmpnum by"7000 \mathcode`#1 = \tmpnum \relax 
   \else \XeTeXmathcode`#1 = 7 \itfam `#1 \fi 
} 
\def\mathalphabetchars#1{\if^#1^\else 
   \setmathalphabetcode#1\expandafter\mathalphabetchars\fi} 
 
\mathalphabetchars ÁáÄäČčĎďÉéĚěÍíĹĺĽľŇňÓóÖöÔôŔŕŘřŠšŤťÚúŮůÜüÝýŽž{} 
</code></pre><p>Now, all Czech characters have the same property as another characters for math typesetting. The are default in math italics and they are switchable to another math families. It is needed to load the math fonts wit these characters, of course. This cannot be always implemented (unfortunately). </p><p>The macro <code>\setmathalphabetcode</code> sets the class 7&nbsp;with the default family <code>\tifam</code>. If there isn't present Unicoded TeX-engine then the <code>\mathcode</code> primitive is used else <code>\XeTeXmathcode</code> primitive is used. </p></section><footer class='text-right'><a href='opmac-tricks.html#alphachars' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0025</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-02'>09/02/2013</time></span> </footer></article> <article id='eqnum' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The reference to the previous equation</h3> <a href='#eqnum'><i class='fas fa-link'></i></a></div></header><section><p>We need to refer to the immediate previous equation in our math text very often. It is less comfortable to create labels for such references. It is sufficient to write <code>\eqmark</code> in the equation and to do the reference by <code>\lasteq</code> sequence and to do the reference to the previous last or pre-previous last equation by <code>\preveq2</code> or <code>\preveq3</code> sequences. For example: </p><pre class='pr-3'><code>$$a^2 + b^2 = c^2  \eqmark$ 
Previous equation \lasteq\ is the assertion of the Pythagoras Theorem. 
</code></pre><p>We can implement the <code>\lasteq</code> and <code>\preveq</code> by the code: </p><pre class='pr-3'><code>\newcount\eqlabnum 
\addto\eqmark{{\global\advance\eqlabnum by1 
               \edef\lastlabel{.eqlab:\the\eqlabnum}\wlabel\thednum}} 
\def\preveq#1{\tmpnum=\eqlabnum\advance\tmpnum by-#1\advance\tmpnum by1 
              \ref[.eqlab:\the\tmpnum]} 
\def\lasteq{\preveq1} 
</code></pre><p>The global register <code>\eqlabnum</code> is introduced here. The internal label <code>.eqlab:\the\eqlabnum</code> is saved by <code>\eqmark</code> and <code>\eqlabnum</code> is incremented. </p></section><footer class='text-right'><a href='opmac-tricks.html#eqnum' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0028</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-09-06'>09/06/2013</time></span> </footer></article> <article id='overtilde' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Expandable tilde over math formula of arbitrary size</h3> <a href='#overtilde'><i class='fas fa-link'></i></a></div></header><section><p>The plain TeX's macro <code>\widetilde</code> provides three sizes of the tilde used by font pointers. No more. This isn't sufficient when we need to set the tilde above a&nbsp;large formula. The macro <code>\overtilde</code> is suggested here. It measures the formula width and set the appropriate tilde scaled by <code>\pdfscale</code>. For example: </p><pre class='pr-3'><code>$$\displaylines{ 
  \overtilde{b} + \overtilde{ab} + \overtilde{a+bc}+{}\cr 
  {}+\overtilde{b+c+d}+ \overtilde{a+b+c+df} 
}$$ 
</code></pre><p>gives the result: </p><p><img src='img/overtilde.png' alt='overtilde example' title='overtilde example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The macro <code>\overtilde</code> is defined by: </p><pre class='pr-3'><code>\mathchardef\widetildemax="0367 
 
\def\widetildeto #1{\bgroup\tmpdim=#1\setbox0=\hbox{$\widetildemax$}% 
   \tmpdim=16\tmpdim \tmpnum=\tmpdim \tmpdim=\wd0 \divide\tmpdim by16 
   \divide\tmpnum by\tmpdim 
   \hbox to#1{\pdfsave\rlap{\pdfscale{\the\tmpnum}{\ifnum\tmpnum&lt;588 1\else\the\tmpnum\fi}% 
                            \pdfscale{.00390625}{\ifnum\tmpnum&lt;588 1\else.0017\fi}% 
                            \vbox to0pt{\hbox{$\widetildemax$}\vss}}\pdfrestore\hss}% 
   \egroup 
} 
\def\overtilde#1{\setbox1=\hbox{$#1$}% 
  \vbox{\offinterlineskip \halign{\hfil##\hfil\cr 
        \widetildeto{\wd1}\cr\noalign{\kern.5ex\kern.02\wd1}\box1\cr}}% 
} 
</code></pre><p>The macro <code>\widetildeto</code> does resizing of <code>\widetildemax</code> to the desired size <code>#1</code>. The numerator for the ratio calculation is scaled by <code>16</code> and the denominator is scaled by <code>1/16</code>. So, the result is scale by <code>256</code> than the real ratio. This is the reason why the <code>\pdfscale{ratio}</code> id followed by <code>\pdfscale{.00390625}</code> which is <code>1/256</code>. The height of the tilde is unscaled up to the ration <code>588/256</code>. If the ratio is greater then the height is scaled by 0.4352 times original height. The macro <code>\overtilde</code> measures the formula in <code>\box1</code> and calls the <code>\widetildeto</code>. The tilde is typeset above the formula by <code>\halign</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#overtilde' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0070</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-17'>06/17/2014</time></span> </footer></article> <article id='mathbox' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Math text (in box) depending on mathstyle</h3> <a href='#mathbox'><i class='fas fa-link'></i></a></div></header><section><p>LaTeX provides the <code>\text{foo}</code> macro which prints foo in math mode similarly as <code>\hbox{foo}</code> but the size of the text depends on the math style (text/script/scriptscript). The outer math context is saved, so the <code>$...$</code> inside the <code>\text</code> parameter opens the math typesetting in the same context (displaystyle, textstyle, etc.). </p><p>We create the similar macro <code>\mathbox{text}</code> which behaves as described above. Only three lines of code is needed when OPmac is used: </p><pre class='pr-3'><code>\def\mathbox#1{{\mathchoice{\mathboxA\displaystyle[]{#1}}{\mathboxA\textstyle[]{#1}} 
    {\mathboxA\textstyle[700]{#1}}{\mathboxA\textstyle[500]{#1}}}} 
\def\mathboxA#1[#2]#3{\hbox{\everymath={#1}\if^#2^\else\typoscale[#2/]\relax\fi #3}} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#mathbox' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0078</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-09-04'>09/04/2014</time></span> </footer></article> <article id='mrepeat' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Repeating math symbols at break points</h3> <a href='#mrepeat'><i class='fas fa-link'></i></a></div></header><section><p>There is a&nbsp;rule about repeating math binary operators and relations at break points in traditional Czech typesetting (maybe elsewhere too). We prepare a&nbsp;macro <code>\mrepeatchar</code> char, it re-declares the char as math-active and the character repeats itself at break points in paragraph. Also, we prepare a&nbsp;macro <code>\mrepeatcs \seqA \seqB \seqC ... \relax</code>, it re-declares given control sequences in similar manner. For example: </p><pre class='pr-3'><code>\mrepeatchar+ \mrepeatchar- \mrepeatchar= \mrepeatchar&lt; \mrepeatchar&gt; 
\mrepeatcs \approx \asymp \bot \cap \cdot \circ \cup \diamond 
   \div \equiv \geq \gg \in \leq \ll \odot \oplus \oslash \otimes \paralell 
   \perp \pm \prec \peceq \sim \simeq \subset \subseteq \supset \supseteq 
   \top \triangle \triangleleft \triangleright \uplus \vdash \vee \wedge \relax 
 
\hsize=5cm 
Test $a\sim b\sim c\sim d\sim e\sim f\sim g\sim i\sim k\sim l\sim m$. 
 
Also test $a+b+c+d+e+f+g+h+y+f&lt;e&lt;w&lt;e$. 
</code></pre><p>When a&nbsp;character is re-declared (for example <code>\mrepeatchar+</code>) then you can use <code>\NR+</code>. This behaves as normal <code>+</code> in math typesetting. When a&nbsp;sequence is re-declared (for example <code>\mrepeatcs \sim \relax</code>) then the <code>\NRsim</code> control sequence is available with the original meaning of <code>\sim</code>. </p><p>The implementation follows: </p><pre class='pr-3'><code>\def\NR#1{\csname NR:\string#1\endcsname} 
\def\mrepset#1{\begingroup \lccode`\~=`#1\lowercase{\endgroup\edef~}} 
\def\mrepeatchar#1{% 
   \isNRno\NR#1{\mathchardef\NR#1=\mathcode`#1 }% 
   \mrepset#1{\NR#1\nobreak \discretionary{}{\hbox{$\NR#1$}}{}} 
   \mathcode`#1="8000 
} 
\def\NRs#1{\csname NR\expandafter\NRx\string#1\endcsname} \def\NRx#1{} 
\def\mrepeatcs#1{\ifx#1\relax \else 
   \isNRno\NRs#1{\let\NRs#1=#1}% 
   \edef#1{\NRs#1\noexpand\nobreak \discretionary{}{\hbox{$\NRs#1$}}{}}% 
   \expandafter\mrepeatcs\fi 
} 
\def\isNRno#1#2#3{\expandafter\expandafter\expandafter\ifx#1#2\relax 
   \expandafter\expandafter\expandafter#3\else 
   \message{\string#2\space declared already}\fi} 
</code></pre><p>The solution is robust. You can use smart characters in titles of chapters or sections without problems. </p></section><footer class='text-right'><a href='opmac-tricks.html#mrepeat' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0148</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-05-18'>05/18/2016</time></span> </footer></article> <article id='dots' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Intelligent \dots like in AMSTeX</h3> <a href='#dots'><i class='fas fa-link'></i></a></div></header><section><p>AMSTeX provides interesting macros. You can do <code>\input amstex</code> *before* <code>\input opmac</code> and you can utilize these macros. But you must write <code>\catcode\@=12</code> immediately after <code>\input amstex</code> because AMSTeX sets this character as active and this brings only problems. </p><p>Or you can use your own macros. For example the <code>\dots</code> macro works by the context in AMSTeX. It behaves as normal <code>\dots</code> in text mode, as <code>\cdots</code> or <code>\ldots</code> in mathmode. The result depends on the fact, what characters are surrounded by the <code>\dots</code>. It means: </p><pre class='pr-3'><code>$$ 
  a_1,\dots a_n, \quad           % behaves like \ldots 
  a_1 + \dots + a_n, \quad       % behaves like \cdots 
  A_1 \subset \dots \subset A_n  % behaves like \cdots 
$$ 
</code></pre><p>This intelligence can be given to the <code>\dots</code> macro by the code: </p><pre class='pr-3'><code>\let\textdots=\dots 
\def\dots{\ifmmode \expandafter\mathdots \else \expandafter\textdots \fi} 
\def\mathdots{\futurelet\next\mathdotsA} 
\def\mathdotsA{\mathdotsB +-=&lt;&gt;()[]\{\}\langle\rangle \end 
   \edef\tmpb{!\meaning\next}% 
   \expandafter\isinlist\expandafter\tmpb\expandafter{\expandafter!\string\mathchar"}% 
   \iftrue \expandafter\mathdotsC\tmpb \end \else \ldots \fi 
   \relax 
} 
\def\mathdotsB#1{\ifx\end#1\else 
      \ifx\next#1\cdots \expandafter\expandafter\expandafter\skiptorelax 
      \else \expandafter\expandafter\expandafter\mathdotsB 
   \fi\fi 
} 
\def\mathdotsC#1"#2#3\end{\let\next=\ldots 
   \ifnum#2=1 \let\next=\cdots \fi % Big OP 
   \ifnum#2=2 \let\next=\cdots \fi % Bin 
   \ifnum#2=3 \let\next=\cdots \fi % Rel 
   \ifnum#2=4 \let\next=\cdots \fi % Open 
   \ifnum#2=5 \let\next=\cdots \fi % Close 
   \next 
} 
</code></pre><p>The <code>\mathdots</code> macro inserts to the <code>\next</code> the following token in math mode. The test is processed by <code>\mathdotsA</code> and <code>\mathdotsB</code>: if the following token is one of <code>+-=<>()[]{}</code> then <code>\cdots</code> is inserted and the <code>\skiptorelax</code> finishes the work. Else the token is tested to <code>\matchar</code> type (like <code>\le</code>). If no, <code>\ldots</code> is inserted. Else the class of the <code>\matchar</code> is examined. If the class is 1, 2, 3, 4&nbsp;or 5&nbsp;then <code>\cdots</code> is inserted else <code>\ldots</code> is used. </p></section><footer class='text-right'><a href='opmac-tricks.html#dots' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0084</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-12-20'>12/20/2014</time></span> </footer></article> <article id='dddot' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>\dddot for third derivation</h3> <a href='#dddot'><i class='fas fa-link'></i></a></div></header><section><p>Plain TeX provides only <code>\ddot x</code> for second derivations of <code>x</code> by t. The macro <code>\ddot</code> is implemented by <code>\mathaccent</code>. But there is no triple dot as an accent in math fonts. So, the macro <code>\dddot</code> for third derivations is slight more complicated: </p><pre class='pr-3'><code>\def\dddot#1{{\mathpalette\dddotA{#1}}} 
\def\dddotA#1#2{\setbox0=\hbox{$#2$}\tmpdim=\ht0 \mathop{#2\kern0pt}\limits 
   ^{\vbox to0pt{\kern-.04em\hbox to0pt{\hss\it$#1.\mkern-1.5mu.\mkern-1.5mu.$% 
     \kern-\slantcorr\hss}\vss}}} 
</code></pre><p>The macro works in all math sizes due to <code>\mathpalette</code>. The <code>\slantcorr</code> macro from OPmac is used for horizontal placement of the accent with respect to the slanted axis of the base character. The constants used in the macro were chosen in order to reach the maximal likeness with <code>\ddot</code> output. You can compare the quality of the output of this <code>\dddot</code> and the LaTeX output with <code>amstex.sty</code> package... </p></section><footer class='text-right'><a href='opmac-tricks.html#dddot' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0145</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-04-27'>04/27/2016</time></span> </footer></article> <article id='bbgreek' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Greek letters in \bbchar family</h3> <a href='#bbgreek'><i class='fas fa-link'></i></a></div></header><section><p>OPmac uses <code>ams-math.tex</code> file where the <code>msbm*.tfm</code> fonts (from AMS) are loaded for <code>\bbchar</code> math family. The letters are better, but the blackboard lowercase Greek letters are missing here. These are included in <code>bbold*.tfm</code> fonts, but the letters are more ugly. If you need the bb Greek letters then we show here how to replace one math family by another font. Specially the font <code>msbm*</code> by <code>bbchar*</code>. Then you can write: </p><pre class='pr-3'><code>$\alpha = {\bbchar\alpha}$ 
</code></pre><p>and the result is “normal alpha is equal to blackboard alpha”. The file <code>ams-math.tex</code> shows that <code>\bbchar</code> is math family 5&nbsp;with the label <code>msbm</code>, so you can use the following macros: </p><pre class='pr-3'><code>\regtfm msbm 0 bbold5 5.5 bbold6 6.5 bbold7 7.5 bbold8 8.5 bbold9 
             9.5 bbold10 11.1 bbold12 15 bbold17 * % using bbchar from bbold*.tfm 
 
\mathchardef\bbalpha="50B   \mathchardef\bbbeta="50C    \mathchardef\bbgamma="50D 
\mathchardef\bbdelta="50E   \mathchardef\bbepsilon="50F \mathchardef\bbzeta="510 
\mathchardef\bbeta="511     \mathchardef\bbtheta="512   \mathchardef\bbiota="513 
\mathchardef\bbkappa="514   \mathchardef\bblambda="515  \mathchardef\bbmu="516 
\mathchardef\bbnu="517      \mathchardef\bbxi="518      \mathchardef\bbpi="519 
\mathchardef\bbrho="51A     \mathchardef\bbsigma="51B   \mathchardef\bbtau="51C 
\mathchardef\bbupsilon="51D \mathchardef\bbphi="51E     \mathchardef\bbchi="50F 
\mathchardef\bbpsi="520     \mathchardef\bbomega="57F 
 
\addto\bbchar{\let\alpha\bbalpha \let\beta\bbbeta \let\gamma\bbgamma 
   \let\delta\bbdelda \let\epsilon\bbepsilon \let\zeta\bbzeta \let\theta\bbtheta 
   \let\iota\bbiota \let\kappa\bbkappa \let\lambda\bblambda \let\mu\bbmu 
   \let\nu\bbnu \let\xi\bbxi \let\pi\bbpi \let\rho\bbrho \let\sigma\bbsigma 
   \let\tau\bbtau \let\upsilon\bbupsilon \let\phi\bbphi \let\chi\bbchi 
   \let\psi\bbpsi \let\omega\bbomega 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#bbgreek' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0144</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-04-11'>04/11/2016</time></span> </footer></article> <article id='smartgreek' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Upright greek letters in math</h3> <a href='#smartgreek'><i class='fas fa-link'></i></a></div></header><section><p>The <code>$\beta$</code> and <code>$\rm\beta$</code> prints the same result: italic beta. This behavior can be changed by <code>\smartgreek</code> declaration. Then the <code>\rm</code> selector prints greek lowercase letters in math upright. The <code>\smartgreek</code> macro looks like: </p><pre class='pr-3'><code>\def\setsmartgreek{% 
   \expandafter\ifx\csname updelta\endcsname\relax \eurmgreek \fi 
   \escapechar=-1 \setsmartgreekA 
      \alpha\beta\gamma\delta\epsilon\zeta\eta\theta\iota\kappa\lambda\mu\nu\xi\pi\rho\sigma 
      \tau\upsilon\phi\chi\omega\varepsilon\vartheta\varpi\varrho\varsigma\varphi\relax 
   \escapechar=`\\ 
} 
\def\setsmartgreekA#1{\ifx#1\relax \else 
   \expandafter \let \csname ori\string#1\endcsname = #1% 
   \edef#1{\relax \noexpand\ifnum\fam=0 \thecsname up\string#1\endcsname 
           \noexpand\else \noexpand\ifnum\fam=\rmfam \thecsname up\string#1\endcsname 
           \noexpand\else \thecsname ori\string#1\endcsname 
           \noexpand\fi \noexpand\fi}% 
   \expandafter\setsmartgreekA \fi 
} 
\def\thecsname{\expandafter\noexpand\csname} 
\def\eurmgreek{\regtfm eurm 0 eurm5 6 eurm7 8.5 eurm10 * 
   \csname newfam\endcsname \eurmfam \tmpnum=\eurmfam \advance\tmpnum by-10 
   \edef\eurmh{\ifcase\tmpnum A\or B\or C\or D\or E\or F\fi}% 
   \addto\normalmath{\loadmathfamily {\eurmfam} eurm }\normalmath 
   \addto\boldmath{\loadmathfamily {\eurmfam} eurm }% 
   \mathchardef \upalpha "0\eurmh 0B    \mathchardef \upbeta  "0\eurmh 0C 
   \mathchardef \upgamma "0\eurmh 0D    \mathchardef \updelta "0\eurmh 0E 
   \mathchardef \upepsilon "0\eurmh 0F  \mathchardef \upzeta  "0\eurmh 10 
   \mathchardef \upeta   "0\eurmh 11    \mathchardef \uptheta "0\eurmh 12 
   \mathchardef \upiota  "0\eurmh 13    \mathchardef \upkappa "0\eurmh 14 
   \mathchardef \uplambda "0\eurmh 15   \mathchardef \upmu    "0\eurmh 16 
   \mathchardef \upnu   "0\eurmh 17     \mathchardef \upxi   "0\eurmh 18 
   \mathchardef \uppi   "0\eurmh 19     \mathchardef \uprho   "0\eurmh 1A 
   \mathchardef \upsigma   "0\eurmh 1B  \mathchardef \uptau   "0\eurmh 1C 
   \mathchardef \upupsilon "0\eurmh 1D  \mathchardef \upphi   "0\eurmh 1E 
   \mathchardef \upchi   "0\eurmh 1F    \mathchardef \uppsi   "0\eurmh 20 
   \mathchardef \upomega   "0\eurmh 21  \mathchardef \upvarepsilon "0\eurmh 22 
   \mathchardef \upvartheta "0\eurmh 23 \mathchardef \upvarpi   "0\eurmh 24 
   \let \upvarrho=\varrho \let \upvarsigma=\varsigma 
   \mathchardef \upvarphi   "0\eurmh 27 
} 
</code></pre><p>If tx-math is loaded then <code>\upalpha</code>, <code>\upbeta</code> etc. are ready and they are used. Else the upvariants are declared using eurm font and using macro <code>\eurmgreek</code>. The <code>\setsmartgreek</code> macro redefines characters <code>\alpha</code>, <code>\beta</code>, etc. by the following way: </p><pre class='pr-3'><code>\let\orialpha=\alpha 
\def\alpha{\relax \ifnum\fam=0 \upalpha \else \ifnum\fam=\rmfam \upalpha \else \orialpha \fi\fi} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#smartgreek' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0130</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-11-11'>11/11/2015</time></span> </footer></article> <article id='bfmath' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Normal \bf and \bi in math mode</h3> <a href='#bfmath'><i class='fas fa-link'></i></a></div></header><section><p>OPmac uses <code>ams-math.tex</code> macro (from CSplain) to load the math fonts. This file sets math <code>\bf</code> and <code>\bi</code> as *sans serif* variants of bold fonts becaue it is common in Czech math typesetting. If you need to use normal <code>\bf</code> and <code>\bi</code> in math mode then you can write: </p><pre class='pr-3'><code>\addto\normalmath{% 
   \setmathfamily {\bffam} \tenbf  \setmathfamily {\bifam} \tenbi 
} 
\addto\boldmath{% 
   \setmathfamily {\bffam} \tenbf  \setmathfamily {\bifam} \tenbi 
} 
\normalmath 
</code></pre><p>It is very uncommon to have super-bold variants in font family, thus <code>\boldmath</code> is declared with the same fonts as <code>\normalmath</code>. If you have superbold variants (say heavy-bf and heavy-bi) then you can write: </p><pre class='pr-3'><code>\addto\boldmath{% 
   \loadmathfamily {\bffam} heavy-bf \setmathfamily {\bifam} heavy-bi 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#bfmath' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0146</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-05-02'>05/02/2016</time></span> </footer></article> <article id='vecmath' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Vectors in sansserif bold including greek letters</h3> <a href='#vecmath'><i class='fas fa-link'></i></a></div></header><section><p>The OPmac trick above mentions the bahavior of <code>\bf</code> and <code>\bi</code> in math as sansserif bold because this is more common in Czech traditional typesetting of math. Sometimes we need to use upright sansserif bold letters for matrices and slanted for vectors, but both will be marked by the same way:  <code>\_A\_x = \_b</code>. Moreover, default <code>\bf</code> nor <code>\bi</code> does not work with greek letters, but we need to use <code>\_\gamma</code> for bold sansserif gamma, for instance. This should be done by the following code: </p><pre class='pr-3'><code>\addto\normalmath{\loadmathfamily 12 cmbrmb10 \loadmathfamily 13 cmssbx10 } 
\normalmath 
 
\def\_#1{{\expandafter\vecboldify\string#1\end}} 
\addto\boldmath{\loadmathfamily 12 cmbrmb10 \loadmathfamily 13 cmssbx10 } 
\def\vecboldify#1#2\end{% 
   \ifx\relax#2\relax 
      \ifnum\lccode`#1=`#1\bi#1\else\bf#1\fi % skolněná malá, stojatá velká  
   \else 
      \expandafter\expandafter\expandafter\vecboldifyG % tučný sans pro řečtinu 
      \expandafter\meaning \csname #2\endcsname\end 
   \fi 
} 
\def\vecboldifyG #1"#2#3\end{\ifx7#2\fam13\mathchar"7#3 \else \mathchar"C#3 \fi} 
</code></pre><p>First, the font cmbrmb10 with greek sansserif bold is included as math family 12. It does not include upright uppercase greek letters, unfortunately. So, the font cmssbx10 with such letters is loaded too. </p><p>The <code>\_</code> macro checks if given parameter is letter or control sequence using <code>\string</code>. If it is letter then <code>\bi</code> or <code>\bf</code> is used. Else we need to know the mathcode of given control sequence: the \meaning is used. If such code begins by 7&nbsp;then it is uppercase greek (family 13 is used} else it is  lowercase greek (family 12=C is used). </p></section><footer class='text-right'><a href='opmac-tricks.html#vecmath' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0170</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2019-10-20'>10/20/2019</time></span> </footer></article> <article id='dfam' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Dynamically allocated math families</h3> <a href='#dfam'><i class='fas fa-link'></i></a></div></header><section><p>Classical TeX and pdfTeX have a&nbsp;limit of maximal 16 math families of fonts in one formula. OPmac uses <code>ams-math.tex</code> or <code>tx-math.tex</code> and these macros allocate 12 resp. 14 math families statically (for whole document). But you can allocate less math families statically and other families will be allocated dynamically (on demand) inside each formula. The result: you can have arbitrary number of math families in your document (but the limit 16 to one formula is still valid). </p><p>We create a&nbsp;macro <code>\dfam{family-name}</code> which behaves similar as <code>\fam=family-number</code> inside formula, but the family is dynamically allocated. Moreover, we create a&nbsp;macro </p><pre class='pr-3'><code>\dmathchardef \sequence class{family-name}hexa-code 
</code></pre><p>which declares the <code>\sequence</code> similarly as <code>\matchardef</code> does it, but the appropriate math family is dynamicaly allocated only if the <code>\sequence</code> is used in the formula. For example, we suppose that the families eufm (for fractur) and rsfs (for script) are not loaded statically. Then you can declare families at beginning of your document: </p><pre class='pr-3'><code>% in general: \sdef{dfam:family-name}{font-name-as-in-\loadmathfamily} 
\sdef{dfam:fractur}{eufm}   \def\fractur{\dfam{fractur}} 
\sdef{dfam:script}{rsfs}    \def\script{\dfam{script}} 
% ... 
\dmathchardef\foo 0{fractur}00  % character class 0 code 00 (hex) from fractur family 
% ... 
</code></pre><p>and next you can use it: </p><pre class='pr-3'><code>$a \times {\script B} = {\fractur C}$, a taky $ \beta = \foo^2 $. 
</code></pre><p>Two formulae are in this example. The script and fractur families are loaded in the first formula and only fractur is loaded in the second formula. Of course, the statically loaded families are used in both formulae too. </p><p>The implementation: </p><pre class='pr-3'><code>\chardef\numfamilies=\count18  % the number of statically loaded families 
\everymath={\dfamstart} \everydisplay{\dfamstart} \def\dfamlist{} 
\def\dfamstart{\aftergroup\dfamreset \let\dfamstart=\relax} 
\def\dfamreset{\global\count18=\numfamilies \gdef\dfamlist{}} 
 
\def\dfam#1{\relax 
   \expandafter\ifx\csname dfam:#1\endcsname \relax 
      \opwarning{dynamic math family "#1" is not declared}% 
   \else 
      \isinlist\dfamlist{,#1,}\iftrue \else 
         \begingroup \def\wlog##1{}% 
            \csname newfam\expandafter\endcsname \csname dmn:#1\endcsname 
            \globaldefs=1 
            \loadmathfamily{\csname dmn:#1\endcsname} {\csname dfam:#1\endcsname} 
         \endgroup 
         \global\addto\dfamlist{,#1,}% 
         \tmpnum=\csname dmn:#1\endcsname 
         \ifnum \tmpnum&lt;10 \sxdef{dmh:#1}{\the\tmpnum}\else 
            \advance\tmpnum by-10 
            \sxdef{dmh:#1}{\ifcase\tmpnum A\or B\or C\or D\or E\or F\fi}% 
      \fi\fi 
      \fam=\csname dmn:#1\endcsname\relax 
   \fi 
} 
\def\dmathchar#1#2#3#4{\relax 
   \ifnum#1=0{\fi  % 2^\foo will work, don't need to write 2^{\foo} 
   \isinlist\dfamlist{,#2,}\iftrue\else\begingroup\dfam{#2}\endgroup\fi 
   \mathchar"#1\csname dmh:#2\endcsname#3#4 
   \ifnum#1=0}\fi 
} 
\def\dmathchardef #1#2#3#4#5{\def#1{\dmathchar#2{#3}#4#5}} 
\addprotect\dfam \addprotect\dmathchar 
</code></pre><p>Dynamically allocated families are loaded by <code>\loadmathfamily</code> on demand and with global settings. The names of such families are stored into <code>\famlist</code>. The control sequence <code>\dmn:name</code> includes the number of the family and <code>\dmh:name</code> includes the hexa digit of such number. The data about loaded families are reset at the end of the formula using <code>\dfamreset</code>. The nested formulae (like <code>\hbox{...$formula$...}</code> inside another formula) don't reset the data because the <code>\dfamstart</code> is set to <code>\relax</code> temporary. </p><p>When <code>\dfam</code> is used then small number of statically allocated families are recommended. You do this by redefining <code>\normalmath</code> and <code>\boldmath</code> and by decreasing the <code>\count18</code> number. The families 0, 1, 2&nbsp;ad 3&nbsp;must be loaded statically because the metric information from these families is used by TeX in each formula. </p><p>If the family have the bold variant then you can declare such family like this: </p><pre class='pr-3'><code>\newif \ifboldmath   \boldmathfalse 
\addto\normalmath{\boldmathfalse}  \addto\boldmath{\boldmathtrue} 
% příklad eufm a eufb: 
\sdef{dfam:fractur}{\ifboldmath eufb\else eufm\fi} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#dfam' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0131</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-11-22'>11/22/2015</time></span> </footer></article> <article id='matrixR' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Matrices with one column outside</h3> <a href='#matrixR'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/ukazka-matrixR.png' alt='MatrixR' title='MatrixR' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>We create a&nbsp;macro <code>\matrixR</code> for matrices with typical large brackets, but the last column insn't placed inside these brackets, but alongside the right bracket. For example </p><pre class='pr-3'><code>$$ 
  \matrixR(){ccc}{1&amp;2&amp;3&amp;první řádek\cr 4&amp;5&amp;6&amp;druhý\cr 7&amp;8&amp;9\cr 10&amp;11&amp;12&amp;poslední} 
$$ 
</code></pre><p>creates the matrix like in the image. The syntax rule for <code>\matrixR</code> is </p><pre class='pr-3'><code>\matrixR left-bracket right-bracket {declaration} {data} 
</code></pre><p>where <code>declaration</code> includes a&nbsp;declaration of the inside columns only but <code>data</code> includes next undeclared column which will be printed in text mode outside the matrix brackets. </p><p>The implementation: </p><pre class='pr-3'><code>\def\matrixR#1#2#3#4{% 
   \bgroup \def\tabiteml{$\ }\def\tabitemr{\ $}\dimen0=0pt 
   \def\tabdeclareR{\setbox0=\hbox{\,####\unsskip}\ifdim\dimen0&lt;\wd0 \global\dimen0=\wd0 \fi}% 
   \setbox1=\vbox{\table{#3R}{#4}}% 
   \setbox2=\hbox{$\left#1\vcenter{\copy1}\right#2$}% 
   \dimen1=\wd2 \advance\dimen1 by-\wd1 \divide\dimen1 by2 
   \def\tabdeclareR{\rlap{\kern\dimen1 \,####\unsskip}}% 
   \left#1\vcenter{\table{#3R}{#4}}\right#2\kern\dimen0 
   \egroup 
} 
</code></pre><p>The printing is done in two steps. The <code>\table</code> with additional declarator R&nbsp;is used in the first step. The R&nbsp;declaration doesn't print the column, only measures the maximal width and stores it to <code>\dimen0</code>. The result of the first step is saved to box1. The box2 includes the large brackets around box1. We calculate the width of the large bracket (from the difference between box2 and box2) and save this width to <code>\dimen1</code>. The second step prints the matrix. The last column R&nbsp;is printed as <code>\rlap</code> with <code>\kern\dimen1</code>. Finally the <code>\kern\dimen0</code> is added after matrix is printed in order to the (possibly) next printing material be placed after the last column. </p><p>You can create <code>\matrixL</code> or <code>\matrixLR</code> macros analogically. </p></section><footer class='text-right'><a href='opmac-tricks.html#matrixR' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0137</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-01-15'>01/15/2016</time></span> </footer></article> <article id='matrixA' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Matrices with one row outside</h3> <a href='#matrixA'><i class='fas fa-link'></i></a></div></header><section><p>We create a&nbsp;macro <code>\matrixA</code> which behaves the same as <code>\matrixR</code> from previous OPmac trick 0137, but the first row is above the matrix. The user can combine this feature with the last undeclared column which is alongside the matrix. If the undeclared column isn't used then only first row is outside the matrix. The macro <code>\matrixB</code> acts like <code>\matrixA</code>, but first row is normally inside the matrix and the last row is below the matrix. </p><p>The syntax rule for <code>\matrixA</code> and <code>\matrixB</code> is the same as for <code>\matrixR</code>: </p><pre class='pr-3'><code>\matrixA left-bracket right-bracket {declaration} {data} 
</code></pre><p>The implementation: </p><pre class='pr-3'><code>\def\matrixA#1#2#3#4{% 
   {\mathop{\matrixI#1#2{#3}{\noalign{\kern-\normalbaselineskip}#4}}% 
    \limits^{\textstyle\mathstrut}}} 
\def\matrixB#1#2#3#4{% 
   {\mathop{\matrixI#1#2{#3}{#4\crcr\noalign{\kern-\normalbaselineskip}}}% 
    \limits_{\textstyle\mathstrut}}} 
\let\matrixI=\matrixR  % use \matrixR from OPmac trick 0137 
</code></pre><p>The matrix has the row outside because of <code>\kern-\normalbaselineskip</code>. The matrix is typeset as <code>\mathop</code> and the invisible sup/super-script is added above/below the matrix in order to the lapped row have its common height. The user can say <code>\let\matrixI=\matrixL</code> or <code>\let\matrixI=\matrixLR</code> if the left-outside column is needed and if <code>\matrixL</code> and <code>\matrixLR</code> macros are defined. </p></section><footer class='text-right'><a href='opmac-tricks.html#matrixA' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0138</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-01-16'>01/16/2016</time></span> </footer></article> <article id='mspecdef' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Visual marks in math</h3> <a href='#mspecdef'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/mspecdef.png' alt='mspecdef example' title='mspecdef example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>It is more comfortable to use <code><=</code> instead <code>\leq</code>, <code>==></code> instead <code>\Rightarrow</code>, <code>+-</code> instead <code>\pm</code> etc. in source file in math. For example: </p><pre class='pr-3'><code>$$ a &lt;= b &lt;= c ==&gt; a &lt;= c $$ 
</code></pre><p>This feature can be declared by <code>\mspecdef</code> macro, for example: </p><pre class='pr-3'><code>\mspecdef &lt;&lt;   \ll 
\mspecdef &lt;&gt;   \neq 
\mspecdef &lt;=   \leq 
\mspecdef &lt;=&gt;  \Leftrightarrow 
\mspecdef &gt;&gt;   \gg 
\mspecdef &gt;=   \geq 
\mspecdef -+   \mp 
\mspecdef +-   \pm 
\mspecdef ==   \equiv 
\mspecdef =.   \doteq 
\mspecdef ==&gt;  \Rightarrow 
</code></pre><p>The <code>\mspecdef</code> macro is defined as follows: </p><pre class='pr-3'><code>\def\skipnext#1#2{#1} 
\def\trynext#1{\trynextA#1.\relax\relax} 
\def\trynextA#1#2\relax#3\relax#4#5{% 
   \ifx\relax#2\relax \def\next{#4}\else 
      \def\next{\isnextchar#1{\skipnext{\trynextA#2\relax#3#1\relax{#4}{#5}}}{#5#3}}\fi 
   \next 
} 
\def\mspecdefA#1#2#3 #4{\ifx#2\undefined 
   \def#2{\trynext{#3}{#4}{#1}}\else 
   \toks0={\trynext{#3}{#4}}\toks1=\expandafter{#2}% 
   \edef#2{\the\toks0{\the\toks1}}\fi 
} 
\def\mspecdef#1{% 
   \ifcat_#1 \expandafter\let\csname m:#1\endcsname=X \catcode`#1=12 \fi 
   \expandafter\ifx\csname m:#1\endcsname\relax 
      \expandafter\mathchardef\csname m:#1\endcsname=\mathcode`#1 \fi 
   \mathcode`#1="8000 \begingroup \lccode`~=`#1 
   \lowercase{\endgroup\expandafter\mspecdefA\csname m:#1\endcsname~}% 
} 
\def\tmp{\adef_##1{_{##1}}\adef^##1{^{##1}}}\tmp 
\catcode`_=12 \catcode`^=12 \mathcode`_="8000 \mathcode`^="8000 
</code></pre><p>The idea: when we do <code>\mspecdef ax \U \mspecdef axy \V \mspecdef abcd \W</code> then the <code>a</code> character is set as math-active (i.e. <code>\matcode</code> is <code>"8000</code>) and it is defined as </p><pre class='pr-3'><code>\def a{\trynext{bcd}\W{\trynext{xy}\V{\trynext{x}\U{normal a}}}} 
</code></pre><p>This macro does test if the following string is <code>bcd</code> (using repeatedly called <code>\isnextchar</code>). If it is true then next part of the macro is skipped and <code>\W</code> is processed. Else next part of the macro is processed. This means, that <code>xy</code> is tested. If fails then <code>x</code> is tested and if fails then normal <code>a</code> is printed. Note that the declared strings with the same beginning part (ax, axy here) must be declared in the order from shortest string to longer. </p><p>The last two lines solve the problem like <code>$a_+$</code> when <code>\mspecdef +- \pm</code> is declared. User need not to write <code>$a_{+}$</code>, macros converts the first syntax to second automatically. </p></section><footer class='text-right'><a href='opmac-tricks.html#mspecdef' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0149</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-05-26'>05/26/2016</time></span> </footer></article> <article id='varstyle' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Math style dependent macros</h3> <a href='#varstyle'><i class='fas fa-link'></i></a></div></header><section><p>For various typesetting in mathematical mode (display, text, script, scriptscript), the primitive command <code>\mathchoice</code> is used. And plain TeX defines the macro <code>\mathpalette</code>. Both are awkward. The <code>\mathchoice</code> feature could be implemented in TeX using a&nbsp;delayed argument (as in <code>\write</code>) without having to typeset all four math style variations in the TeX. But we cannot do this without interfering with the TeX itself. On the other hand, the macro <code>\mathpalette</code> can be abandoned. We make the macro <code>\varstyle</code>, which is more user-friendly and with far wider options. Macro <code>\varstyle</code> has one parameter to create a&nbsp;math list. Within this parameter it is possible to use <code>\usestyle</code> to switch to math style active at the time of use <code>\varstyle</code>, and it is also possible to use <code>\mathaxis</code> for the distance of the baseline from the mathematical axis and we can define another style-dependent macros using <code>\ifcase\mstylenum D \or T \or S \or SS \fi</code>. For example, a&nbsp;double sum macro (two summation characters across) may look like this: </p><pre class='pr-3'><code>\def\dbsumR{\ifcase\mstylenum .35\or.25\or.21\or.15\fi em} 
\def\dbsumU{\ifcase\mstylenum .15\or.12\or.09\or.07\fi em} 
\def\doublesum{\mathop{\varstyle{\raise\dbsumU\rlap{$\usestyle\sum$}{\kern\dbsumR\sum}}}} 
 
$\displaystyle \doublesum_{ij}^{DN} \textstyle \doublesum_{ij}^{DN}$ 
</code></pre><p>The makro <code>\varstyle</code> and friends are defined by <code>\mathchoice</code>: </p><pre class='pr-3'><code>\newcount\mstylenum 
\def\varstyle#1{\mathchoice{\mstylenum=0 #1}{\mstylenum=1 #1}{\mstylenum=2 #1}{\mstylenum=3 #1}} 
\def\usestyle{\ifcase\mstylenum \displaystyle\or\textstyle\or\scriptstyle\or\scriptscriptstyle\fi} 
\def\mathaxis{\fontdimen22\ifcase\mstylenum \textfont\or\textfont\or\scriptfont\or\scriptscriptfont\fi2 } 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#varstyle' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0157</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-05-03'>05/03/2017</time></span> </footer></article>
                            </section>  <section id="tabulky" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Tables</h2>
                                    <a href="#tabulky"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='etable' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Table which spans to more columns and rows</h3> <a href='#etable'><i class='fas fa-link'></i></a></div></header><section><p>New features of the <code>\table</code> macro are introduced in OPmac version Jun. 2017: repeating of declaration parts, the p&nbsp;declarator for paragraphs, the <code>\crlp</code> macro for end rows with partial horizontal line after it and the <code>\mspan</code> macro for table cells over more columns. </p><p>We show how to prepare the table </p><p><img src='img/etable-ukazka.png' alt='Table example' title='Table example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>using <code>\table</code> macro. The example is inspired by the <a href='https://tex.stackexchange.com/questions/132445/' title='StackExchange question'>StackExchange question</a>. You can compare the complexity of the LaTeX code mentioned at the StackExchange with the code shown here. </p><pre class='pr-3'><code>\def\low#1{\vbox to 0pt{\kern1.5ex\hbox{#1}\vss}} 
\def\tabstrut{\vrule height 20pt depth10pt width0pt} 
 
\table{|8{c|}}{\crlp{3-8} 
   \mspan2[c|]{} &amp;\mspan3[c|]{Singular} &amp;\mspan3[c|]{Plural} \crlp{3-8} 
   \mspan2[c|]{} &amp; Neuter &amp; Masculine &amp; Feminine &amp; Masculine &amp; Feminine &amp; Neuter \crl 
   \low I    &amp; Inclusive &amp;\mspan3[c|]{\low O} &amp;\mspan3[c|] X \crlp{2,6-8} 
             &amp; Exclusive &amp;\mspan3[c|]{} &amp;\mspan3[c|] X \crl 
   \low{II}  &amp; Informal  &amp;\mspan3[c|] X &amp;\mspan3[c|] X \crlp{2-8} 
             &amp; Formal    &amp;\mspan6[c|] X \crl 
   \low{III} &amp; Informal  &amp; \low O &amp; X &amp; X &amp;\mspan2[c|] X &amp; \low O \crlp{2,4-7} 
             &amp; Formal    &amp; &amp;\mspan4[c|] X &amp; \crl 
} 
</code></pre><p>The <code>\tabstrut</code> is redefined here in order to make better table. The <code>\mspan</code> macro is used for spanning cells to more columns and the \crlp macro is used for partial horizontal lines. The <code>\low</code> macro is used for lowering the text to achieve the visual illusion that the text is verticaly aligned over two rows. More general macro for such cases is described in the following OPmac trick 0159. </p></section><footer class='text-right'><a href='opmac-tricks.html#etable' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0158</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-17'>06/17/2017</time></span> </footer></article> <article id='tabcrow' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Vertical centered text in more rows</h3> <a href='#tabcrow'><i class='fas fa-link'></i></a></div></header><section><p>We create the <code>\crow number {text}</code> macro which lowers the given <code>text</code> to achieve the visual illusion that it is aligned verticaly in <code>number</code> rows, the first of them is the actual row. Then we can replace the ad hoc macro <code>\low {text}</code> (from previous example) by more general <code>\crow2 {text}</code>. </p><pre class='pr-3'><code>\def\crow{\afterassignment\crowA \tmpnum=} 
\def\crowA#1{\setbox0=\hbox{\tabstrut}\tmpdim=\ht0 \advance\tmpdim by\dp0 
   \tmpdim=\the\tmpnum\tmpdim 
   \vbox to0pt{\kern-\ht0 \vbox to\tmpdim{\vss\hbox{#1}\kern-\prevdepth\vss}\vss}% 
} 
 
</code></pre><p>The <code>\crow</code> macro saves the number in <code>\tmpnum</code> and starts <code>\crowA</code>. The <code>\tmpdim</code> is saved as <code>number</code> times the total height of the <code>\tabstrut</code> and the <code>\vbox to\tmpdim</code> is constructed hidden in <code>\vbox to0pt</code>. </p><p>Note that the <code>\crow</code> macro works properly only when all table rows have the same <code>\tabstrut</code> height. It will not work when table rows include a&nbsp;multirow cells (paragraphs), where we don't know the exact rows height beforehand. Then you must return to a&nbsp;macro like <code>\low</code> from previous OPmac trick and you must set the position of the text manually. If you insist on automatic calculation for such vertical centering then you can replace <code>\halign</code> by the “transposed” primitive <code>\valign</code>, see <a href='https://tex.stackexchange.com/questions/183235/' title='this thread'>this thread</a> for more information about it. </p></section><footer class='text-right'><a href='opmac-tricks.html#tabcrow' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0159</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-17'>06/17/2017</time></span> </footer></article> <article id='tabpmod' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Variations of paragraphs with p declarator</h3> <a href='#tabpmod'><i class='fas fa-link'></i></a></div></header><section><p>The OPmac manual writes that the paragraph in the table cell declared by <code>p{size}</code> is left-right aligned as default paragraphs. But this can bring some problems in narrow columns. This is a&nbsp;reason why <code>p{size\raggedright}</code> is mentioned in the manual as an alternative which declares left aligned paragraps. We can define more alternatives: </p><pre class='pr-3'><code>\let\fL=\raggedright 
\def\fR{\leftskip=0pt plus 1fill} 
\def\fC{\leftskip=0pt plus1fill \rightskip=0pt plus 1fill} 
\def\fX{\leftskip=\iindent plus1fil 
        \rightskip=\iindent plus-1fil 
        \parfillskip=0pt plus2fil} 
</code></pre><p>and then the <code>p</code> declaration gives following paragraps: </p><pre class='pr-3'><code>p{42mm}     ... left-right alligned, 
p{42mm\fL}  ... left aligned, 
p{42mm\fR}  ... right aligned, 
p{42mm\fC}  ... no aligned, centered lines, 
p{42mm\fX}  ... left-right aligned but last line centered. 
</code></pre><p>Note that left aligned alternative allows word hyphenation but right aligned alternative not (for good typographical reasons). If you want to deny the word hyphenation when <code>\fL</code> is used then you can define simply </p><pre class='pr-3'><code>\def\fL{\rightskip=0pt plus 1fil} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#tabpmod' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0160</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-17'>06/17/2017</time></span> </footer></article> <article id='tablemb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Vertical alignment of p cells in table row</h3> <a href='#tablemb'><i class='fas fa-link'></i></a></div></header><section><p>OPmac provides only <code>p{size}</code> declarator for pararaph-like table cells. If there are more such cells in one table row then they are aligned vertically by the first line (like <code>\vtop</code>). If you need another alignment (<code>\vcenter</code> or <code>\vbox</code> from TeX primitive point of view), you can define LaTeX like declarators <code>m{size}</code> for vertical centering and <code>b{size}</code> for alignment by the last line. The following code solves it. </p><pre class='pr-3'><code>\def\paramtabdeclarem#1{\tabiteml{$\vcenter{\hsize=#1\relax 
   \baselineskip=\normalbaselineskip \lineskiplimit=0pt 
   \noindent\vbox{\hbox{\tabstrutA}\kern-\prevdepth}##\unsskip 
   \vbox to0pt{\vss\hbox{\tabstrutA}}}$}\tabitemr 
} 
\def\paramtabdeclareb#1{\tabiteml\vbox{\hsize=#1\relax 
   \baselineskip=\normalbaselineskip \lineskiplimit=0pt 
   \noindent\vbox{\hbox{\tabstrutA}\kern-\prevdepth}##\unsskip}\tabitemr 
} 
</code></pre><p>Note that we add one strut at the beginning of the text with zero depth and second strut at the end of the text with zero height. The interline spacing in the paragraph is given by <code>\normalbaselineskip</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#tablemb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0161</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-17'>06/17/2017</time></span> </footer></article> <article id='crlpvv' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>\crlp and double vertical lines</h3> <a href='#crlpvv'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\crlp{list}</code> ends the table row and adds the horizontal lines only in selected columns given by the list. It behaves like <code>\crli</code>, it means that the double vertical lines are not intersect. We have the alternative to <code>\crli</code> with the name <code>\crl</code> (including intersections). Is there something similar alternative to <code>\crlp</code>? </p><p>The alternative is following: finish the line by <code>\cr</code> and draw the partial horizontal line by <code>\multispan</code>'s in each columns. The <code>\multispan</code> can be with empty data cell or with <code>\hrulefill</code>. For example: </p><pre class='pr-3'><code>\cr \multispan2 &amp; \multispan3\hrulefill &amp; \multipan1 &amp; \mutispan4\hrulefill \cr 
</code></pre><p>This example behaves like <code>\crlp { 3-5, 7-10 }</code>, but double vertical lines are intersect. You can try: </p><pre class='pr-3'><code>\def\spankern{\kern-\vvkern\kern-\drulewidth} 
 
\table{||c||c||l}{\crl 
  a &amp; b &amp; c \crli 
  d &amp; e &amp; f \crlp{1-2} 
  g &amp; h &amp; i \cr \multispan2\hrulefill &amp; \multispan1 \cr 
  j &amp; k &amp; l \cr \multispan1\hrulefill &amp; \multispan2 \cr 
  m &amp; n &amp; o \crlp{1} 
  p &amp; q &amp; r \cr \multispan1 &amp; \multispan1\spankern\hrulefill &amp; \multispan1 \cr 
  s &amp; t &amp; u \crlp{2} 
  v &amp; w &amp; x \crl 
} 
</code></pre><p>See carefully the result---there is another problem: the line created by <code>\multispan</code>'s behaves like a&nbsp;little strut, so the another vertical lines are not continuous. We need to hide the horizontal line into typesetting by negative vertical kern. Insert <code>\noalign{\kern-\drulewidth}</code> at the end of the <code>j&k&l</code> and <code>p&q&r</code> lines (after the second <code>\cr</code> in both cases). The <code>\crlp</code> macro inserts such kern automatically, so we need not to solve such problem when using <code>\crlp</code> macro. </p><p>Note the definition and usage of <code>\spankern</code> macro. It is used in order to intersect the double line in the previous column. </p></section><footer class='text-right'><a href='opmac-tricks.html#crlpvv' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0163</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-18'>06/18/2017</time></span> </footer></article> <article id='tableverb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Verbatim text in tables</h3> <a href='#tableverb'><i class='fas fa-link'></i></a></div></header><section><p>We cannot use verbatim text (or another catcode dancing) in the <code>\table</code> data because the parameters <code>\table {declaration}{data}</code> are read before typesetting, the <code>{data}</code> parameter is not read during typesetting. But you can use a&nbsp;slight modified macro <code>\verbtable</code>: </p><pre class='pr-3'><code>\activettchar" 
 
\tableverb{declaration} 
data including "#&amp;$" verbatim 
\etable 
</code></pre><p>Note that there is a&nbsp;differnece: <code>data</code> is not in the barces but it is closed by <code>\etable</code> macro. </p><pre class='pr-3'><code>\def\tableverb{\vbox\bgroup \catcode`\|=12 \tableB} 
\def\tableB#1{\offinterlineskip \colnum=0 \def\tmpa{}\tabdata={}\scantabdata#1\ 
   \halign\expandafter\bgroup\the\tabdata\cr} 
\def\etable{\crcr\egroup\egroup} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#tableverb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0162</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2017-06-17'>06/17/2017</time></span> </footer></article> <article id='booktabs' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Tables like in booktabs package</h3> <a href='#booktabs'><i class='fas fa-link'></i></a></div></header><section><p>The orthodox advocates of LaTeX booktabs package don't like the tables form the example above and they point out that I&nbsp;am loser because I&nbsp;don't know that the vertical rules in the table are out. Only horizontal rules are allowed but not double rules. And less rules is better than more. They have the following example in the documentation: </p><p><img src='img/tab3-ukazka.png' alt='Table example' title='Table example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>we can create such table by OPmac and without booktabs package: </p><pre class='pr-3'><code>\table{llr}{                            \crtop 
  \multispan2\hfil Item\hfil&amp;           \cr 
  \multispan2\tablinefil\kern.5em       \cr 
   Animal    &amp; Description &amp; Price (\$) \crmid 
   Gnat      &amp; per gram    &amp;      13.65 \cr 
             &amp; each        &amp;       0.01 \cr 
   Gnu       &amp; stuffed     &amp;      92.50 \cr 
   Emu       &amp; stuffed     &amp;      33.33 \cr 
   Armadillo &amp; frozen      &amp;       8.99 \crbot} 
</code></pre><p>We only need to define <code>\crtop</code>, <code>\crmid</code>, <code>\crbot</code> macros and to change the width of the <code>\tablinefil</code>: </p><pre class='pr-3'><code>\def\crtop{\crcr \noalign{\hrule height.6pt \kern2.5pt}} 
\def\crbot{\crcr \noalign{\kern2.5pt\hrule height.6pt}} 
\def\crmid{\crcr \noalign{\kern1pt\hrule\kern1pt}} 
\def\tablinefil{\leaders\hrule height.2pt\hfil\vrule height1.7pt depth1.5pt width0pt } 
</code></pre><p>Finally, we need to remove the spaces left in the first cell and right in the last cell because the rules have to be aligned wit the text. I've added <code>\kern-.5em</code> to left and right into the line declaration because <code>\tabiteml</code> and <code>\tabitemr</code> are defined by <code>\enspace</code>. This is the reason why the internal OPmac macro <code>\tableA</code> is slightly redefined: </p><pre class='pr-3'><code>\def\tableA#1#2{\offinterlineskip \def\tmpa{}\tabdata={\kern-.5em}\scantabdata#1\relax 
   \halign\expandafter{\the\tabdata\kern-.5em\tabstrutA\cr#2\crcr}\egroup} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#booktabs' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0009</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-15'>08/15/2013</time></span> </footer></article> <article id='crx' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Colored lines in the table</h3> <a href='#crx'><i class='fas fa-link'></i></a></div></header><section><p>We can see the trend to use colored tables like this: </p><p><img src='img/tab2-ukazka.png' alt='Table example' title='Table example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The table above can be created by the <code>\table</code> macro from OPmac: </p><pre class='pr-3'><code>\frame{\table{llllll}{\crx 
  aa &amp; bb &amp; cc &amp; dd &amp; ee &amp; ff \crx 
  gg &amp; hh &amp; ii &amp; jj &amp; kk &amp; ll \crx 
  mm &amp; nn &amp; oo &amp; pp &amp; qq &amp; rr \crx 
  ss &amp; tt &amp; uu &amp; vv &amp; ww &amp; xx \crx 
  ab &amp; cd &amp; ef &amp; gh &amp; ij &amp; kl \crx 
  mn &amp; op &amp; qr &amp; st &amp; uv &amp; wx}} 
</code></pre><p>We need to define the <code>\crx</code> macro which inserts the grey rule before each odd line into the vertical list: </p><pre class='pr-3'><code>\newcount\tabline  \tabline=1 
\def\crx{\crcr \ifodd\tabline \colortabline \fi 
         \global\advance\tabline by1 } 
\def\colortabline{\noalign{\localcolor\LightGrey 
   \hrule height\ht\strutbox depth\dp\strutbox \kern-\ht\strutbox \kern-\dp\strutbox}} 
\def\tabiteml{\quad}\def\tabitemr{\quad} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#crx' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0010</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-15'>08/15/2013</time></span> </footer></article> <article id='cellcolor' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Colored cells in the table</h3> <a href='#cellcolor'><i class='fas fa-link'></i></a></div></header><section><p>We create the column declarators C, R&nbsp;and L&nbsp;with similar behaviour as c, r&nbsp;and l, but the background of each cell can be cloered by chosen color. If the first item in the cell data is color switcher then this color is used for the background of the cell. For example: </p><pre class='pr-3'><code>   ... &amp; \Blue Text &amp;        ... % blue background and black text 
   ... &amp; \Green \Red  Text &amp; ... % green background and red text 
   ... &amp; \relax \Blue Text &amp; ... % blue text and default background 
</code></pre><p>The color of the background will stretch as spaces in the common cells in normal table, i.e. C&nbsp;declarator means that colored space will stretch from both sides, L&nbsp;declarator means right stretching and R&nbsp;declarator means left stretching. The spaces from <code>\tabiteml</code> and <code>\tabitemr</code> are colored too. </p><p>If <code>\cellcolor</code> sequence is set by <code>\let</code> to the color (example <code>\let\cellcolor=\Yellow</code>) then this color will be used as default background. If the <code>\cellcolor</code> is undefined then default background is transparent. </p><p>You can insert the white space between columns by nonzero <code>\tabskip</code> and you can insert the white space between lines by <code>\noalign{\kern...}</code>. Example: </p><pre class='pr-3'><code>\def\tabstrut{\lower4pt\vbox to15pt{}} 
\tabskip=2pt \def\cskip{\noalign{\kern2pt}} \let\cellcolor=\Yellow 
\table{CLR}{first item      &amp; second &amp; \Blue \White third item \cr\cskip 
            next long item  &amp; \Red X &amp; \Green       YES } 
</code></pre><p>creates the table: </p><p><img src='img/tab4-ukazka.png' alt='Table example' title='Table example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>Implementation: </p><pre class='pr-3'><code>\def\tabdeclareC{\futurelet\next\setcellcolor##\end\hfil\hfil} 
\def\tabdeclareL{\futurelet\next\setcellcolor##\end\relax\hfil} 
\def\tabdeclareR{\futurelet\next\setcellcolor##\end\hfil\relax} 
\def\setcellcolor{\ifx\next\global \expandafter\setcellcolorC\else \expandafter\setcellcolorD\fi} 
\def\setcellcolorC#1\fi#2\end#3#4{% 
   \setbox0=\hbox{{\tabiteml\localcolor#2\unskip\tabitemr}}% 
   {\localcolor#1\fi\tabstrut\leaders\vrule\hskip\wd0 \ifx#3\hfil plus1fil\fi}% 
   \kern-\wd0 \box0 
   \ifx#4\hfil {\kern-.2pt \localcolor#1\fi\leaders\vrule\hskip.2pt plus1fil}\fi 
} 
\def\setcellcolorD{\ifx\cellcolor\undefined \let\next=\setcellcolorN 
   \else \def\next{\expandafter\expandafter\expandafter\setcellcolorC\cellcolor}% 
   \fi \next 
} 
\def\setcellcolorN#1\end#2#3{#2\tabiteml{\localcolor#1\unskip}\tabitemr#3} 
</code></pre><p>The <code>\setcellcolor</code> macro scans the first token from the cell data. The macro works in declaration part of the <code>\halign</code>, so the first token is scanned as the first unexpandable token after expansion. This token is <code>\global</code> when color macro is presented here (see the <code>\setcmykcolor</code> definition). If this is true then the <code>\setcellcolorC</code> macro is executed, <code>#1</code> is the expanded part of <code>\setcmykcolor</code> (to the last <code>\fi</code>), <code>#2</code> is the rest of the cell data, <code>#3</code> and <code>#4</code> include the message about the align style. This macro measures the cell text in the box0 and does the colored backround by <code>\leaders</code>. If the first token isn't <code>\global</code> then the macro <code>\setcellcolorD</code> decides if the <code>\cellcolor</code> is defined. If it is true then <code>\setcellcolorC</code> is execuded (with patrially expanded <code>\cellcolor</code> as parameter). Else the <code>\setcellcolorN</code> is executed. This macro prints no background. </p></section><footer class='text-right'><a href='opmac-tricks.html#cellcolor' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0094</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-02'>04/02/2015</time></span> </footer></article> <article id='multispanc' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Colored multispan</h3> <a href='#multispanc'><i class='fas fa-link'></i></a></div></header><section><p>We follow the previous <a href='#cellcolor' title='OPmac trick'>OPmac trick</a> and we add the macro <code>\multispanc{number} \Color {Text}</code> which creates the colored cell by <code>\Color</code> background over <code>number</code> columns. If you need to use default background color, write <code>\relax</code> instead <code>\Color</code>. </p><p>Example: </p><pre class='pr-3'><code>\def\tabstrut{\lower4pt\vbox to15pt{}} 
\tabskip=2pt \def\cskip{\noalign{\kern2pt}} \let\cellcolor=\Yellow 
\table{CLR}{\Black\White\bf Table &amp;\multispanc2 \Black {\White\bf Title} \cr\cskip 
            first item      &amp; second &amp; \Blue \White third item \cr\cskip 
            next long item  &amp; \Red X &amp; \Green       YES } 
</code></pre><p>creates: </p><p><img src='img/tab5-ukazka.png' alt='Table example' title='Table example' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>The makro <code>\multispanc</code> can be defined by: </p><pre class='pr-3'><code>\def\multispanc#1#2#3{\multispan{#1}% 
   \expandafter\expandafter\expandafter\cellcolexp#2#3\end\hfil\hfil\ignorespaces} 
\def\cellcolexp{\futurelet\next\setcellcolor} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#multispanc' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0103</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-23'>04/23/2015</time></span> </footer></article> <article id='tableto' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Tables with the given width</h3> <a href='#tableto'><i class='fas fa-link'></i></a></div></header><section><p>We create the macro <code>\tableto{width}{declaration}{data}</code> which prints the table with the given width. The intercolumn spaces will be adjusted to this width. The macro is inspired by <code>\table</code> macro from OPmac and the <code>\tabskip</code> primitive is used here. </p><pre class='pr-3'><code>\def\tableto{\vbox\bgroup \catcode`\|=12 \tableAto} 
\def\tableAto#1#2#3{\offinterlineskip \def\tmpa{}% 
   \tabdata={\tabskip=0pt plus1fil minus1fil}\scantabdata#2\relax 
   \halign to#1\expandafter{\the\tabdata\tabskip=0pt\tabstrutA\cr#3\crcr}\egroup} 
</code></pre><p>The spaces <code>\tabiteml</code> and <code>\tabitemr</code> are used only at the left boundary and right boundary of the table. The intercolumn spaces are adjusted. </p><p>You can use this macro for example for tables from previous two OPmac tricks. The vertical rules between cells don't work. If you are not the orthodox advocate of the LaTeX booktabs package (and I&nbsp;am not) then you need (we need) to use another macro for vertical rules between cells: </p><pre class='pr-3'><code>\newdimen\tabw 
\def\countcols#1{\ifx#1\relax\else 
   \ifx#1|\else\advance\tmpnum by2 \fi \expandafter\countcols \fi} 
\def\tableto#1#2#3{{\def\tabiteml{}\def\tabitemr{}\setbox0=\table{#2}{#3}% 
   \tmpnum=0 \countcols#2\relax \tabw=#1\advance\tabw by-\wd0 \divide\tabw by\tmpnum 
   \def\tabiteml{\kern\tabw}\def\tabitemr{\kern\tabw}\table{#2}{#3}}} 
</code></pre><p>This macro does printing into the box0 first and the <code>\tabiteml</code> and <code>\tabitemr</code> are empty at this state. The desired width is subtracted by width of the box0 and divided by the double number of columns. The result is used in <code>\tabiteml</code> and <code>\tabitemr</code> and the table is printed again. </p><p>The advantage of such solution (in comparison to the solution form TBN, page 141) is that we needn't to change the markup of the table in the data. The number of the internal columns is kept. </p></section><footer class='text-right'><a href='opmac-tricks.html#tableto' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0011</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-16'>08/16/2013</time></span> </footer></article> <article id='partab' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The cells with paragraph-like formatting</h3> <a href='#partab'><i class='fas fa-link'></i></a></div></header><section><p>The LaTeX users know the column declaration p&nbsp;and they call this as “parbox” declaration. OPmac provides only c, l&nbsp;and r&nbsp;declarations but user can create another declarations. The following code defines the declaration <code>P</code> for the columns where the text is formatted as paragraph with the given <code>\Pwidth</code>. </p><pre class='pr-3'><code>\newdimen\Pwidth 
\def\tabdeclareP {\tabiteml\vtop{\hsize=\Pwidth \rightskip=0pt plus1fil 
   \baselineskip=1.2em \lineskiplimit=0pt \noindent ##\tabstrutA}\hss\tabitemr} 
</code></pre><p>The example of the usage: </p><pre class='pr-3'><code>\Pwidth=3cm \table{|c|P|}{\crl \tskip3pt 
   aaa &amp; This is text which is divided to more lines. \crl \tskip3pt 
    bb &amp; And here is another long long text. \crl} 
</code></pre><p>Now, we create the macro <code>\tableto{width}{declaration}{data}</code> similar as in the previous OPmac trick. We suppose that only one <code>P</code> declaration is used in the declaration. The width of the <code>P</code> column will be calculated in order to the whole width of the table is the same as given width. </p><pre class='pr-3'><code>\newdimen\tabw 
\def\tableto#1#2#3{{\Pwidth=.5\hsize \setbox0=\table{#2}{#3} 
   \tabw=#1\relax \advance\tabw by-\wd0 \advance\Pwidth by\tabw \table{#2}{#3}}} 
</code></pre><p>This macro prints the table into box0 first with <code>\Pwidth=\hsize</code>. The width of the box0 is measured and the <code>\Pwidth</code> is corrected to the final value. Then the table is printed again. </p></section><footer class='text-right'><a href='opmac-tricks.html#partab' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0012</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-16'>08/16/2013</time></span> </footer></article> <article id='decltab' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The extended multiletter column declarations</h3> <a href='#decltab'><i class='fas fa-link'></i></a></div></header><section><p>You can define the column declaration which consist from more than one letter. If such declaration is used then it have to be surrounded by {braces} in the declaration. This keeps the clarity of the declaration. For example we define the set of <code>ic</code>,<code>ir</code>,<code>il</code> declarations which behave as <code>c</code>,<code>r</code>,<code>l</code>, but the italics font is used. </p><pre class='pr-3'><code>\def\tabdeclareic{\tabiteml\it\hfil##\unsskip\hfil\tabitemr} 
\def\tabdeclareil{\tabiteml\it##\unsskip\hfil\tabitemr} 
\def\tabdeclareir{\tabiteml\it\hfil##\unsskip\tabitemr} 
</code></pre><p>The example of the usage: </p><pre class='pr-3'><code>\table{cc{ic}c}{first &amp; second &amp; third &amp; fourth \cr 
                    a &amp;     b &amp;     c &amp;      d } 
</code></pre><p>The third column will be in the italics but other columns use the current font. </p></section><footer class='text-right'><a href='opmac-tricks.html#decltab' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0015</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-17'>08/17/2013</time></span> </footer></article> <article id='dekadic' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The decimal point aligned in the table</h3> <a href='#dekadic'><i class='fas fa-link'></i></a></div></header><section><p>We create the <code>D</code> declaration which provides the typesetting of the aligning of the decimal numbers with decimal comma (the decimal comma is used instead decimal point in Czech). </p><pre class='pr-3'><code>\def\tabdeclareD{\tabiteml\hfil\scandecnumber##&amp;##\hfil\tabitemr} 
\def\scandecnumber#1,{#1\ifdim\lastskip&gt;0pt \unskip\phantom,\else,\fi&amp;} 
</code></pre><p>The example of the usage: </p><pre class='pr-3'><code>\table{lDr}{číslo &amp;   3,24   &amp; první \cr 
            jiné  &amp; 112,1    &amp; druhé \cr 
            celé  &amp;  13     ,&amp; čárka vzadu \cr 
            další &amp;   0,123  &amp; malé} 
</code></pre><p>Note that if there is a&nbsp;number without decimal comma we need to treat wit this as an exception, i. e. to put the comma at the end of the cell. Such comma will be ignored. </p><p>If we need to treat this exception automatically without the decimal comma at the end of the cell then the macro will be much more complicated. It will be outside the slogan “simplicity is power”. We needn't to create useless complicated macros. </p><p>The D&nbsp;declaration declares two internal columns of the table. This have to be considered when we skip the cells by <code>\multispan</code>, for example. </p></section><footer class='text-right'><a href='opmac-tricks.html#dekadic' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0016</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-17'>08/17/2013</time></span> </footer></article> <article id='dekadic2' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The decimal point aligned, another solution</h3> <a href='#dekadic2'><i class='fas fa-link'></i></a></div></header><section><p>The <a href='#dekadic' title='Opmac trick 0016'>Opmac trick 0016</a> solves the aligning of decimal digits in tables with respect to decimal points using two internal columns. But this solution is incompatible with using of <code>\tskip</code>, for example. This is a&nbsp;reason of this new one-column solution.  </p><p>The new declarator of table column <code>N<number></code> is created (for example <code>N3</code>). The <code><number></code> denotes the maximal number of digits after decimal point used in printed numbers of declared column. Each printed number si completed to this maximal <code><number></code> using invisible digits and such modified numbers are aligned  to right. So, the decimal points are aligned. The output can be decimal comma instead decimal point (usable in other languages than English) if you re-define the <code>\decimalpoint</code> macro. </p><p>The numbers are printed in math mode, so the minus character is printed as real minus. </p><p>If the printed item does not include any dot then such text is printed in text mode and it is aligned to center with respect to all decimal numbers in the column. But if such non-dot text is wider than decimal numbers then it is right-aligned. You can declare more decimal digits than they are in real, for example if you need to print wider non-dot text visually better than simply right-aligned. Example: </p><pre class='pr-3'><code>\table{c|N3}{ 
  Ingredients      &amp; w/w (\%) \crl \tskip.2em 
  Water            &amp; -97.5    \cr 
  Agar powder      &amp;  2.0     \cr 
  Solidum chloride &amp;  0.43  
} 
</code></pre><p>If the number of digits after decimal points are more than 9&nbsp;then you must use brackets: <code>N{12}</code>. Finally, you can use non-integer number of decimal digits (<code>N{2.5}</code> for example), if you need to do fine tuning of aligning. The implementation follows: </p><pre class='pr-3'><code>\def\decimalpoint{.} 
 
\def\paramtabdeclareN#1{\tabiteml\hfil\aligndecdigit#1##.\relax\tabitemr} 
\def\aligndecdigit#1#2.#3{% 
   \ifx\relax#3\hfil#2\unsskip\hfil \else 
   \dimen0=.5em \dimen0=#1\dimen0 $#2$\decimalpoint 
   \expandafter\aligndecdigitA\expandafter#3\fi 
} 
\def\aligndecdigitA#1.\relax{\hbox to\dimen0{$#1$\hss}} 
 
\def\tableA#1#2{\offinterlineskip \colnum=0 \def\tmpa{}\tabdata={}\scantabdata#1\relax 
   \def\tmpb{#2}\replacestrings{\crl}{\crcr\crl}% 
      \replacestrings{\crli}{\crcr\crli}\replacestrings{\crll}{\crcr\crll}% 
      \replacestrings{\crlli}{\crcr\crlli}\replacestrings{\crlp}{\crcr\crlp}% 
   \halign\expandafter{\the\tabdata\cr\tmpb\crcr}\egroup} 
 
</code></pre><p>The <code>N</code> declarator is defined by <code>\paramtabdeclareN</code> macro, it means a&nbsp;declarator with parameter. The <code>\aligndecdigit</code> macro prints first part of decimal number and <code>\aligndecdigitA</code> does the rest. </p><p>The items must be terminated by <code>&</code> or by <code>\cr</code> when <code>N</code> column is created.  Using a&nbsp;macro which includes such terminators is unsufficient. But OPmac manual menitons macros <code>\crl</code>, <code>\crli</code> etc., they include <code>\cr</code> terminator. So, we re-define the <code>\Atable</code> preprocessor in order to each occurrence of such <code>\crl</code> (and others) is replaced by <code>\crcr\crl</code> which does the same work in the table. There is another way: you need not to redefine <code>\tableA</code> macro but you must to type <code>\cr\crl</code> instead <code>\crl</code> itself when the <code>N</code> column is the last column of the table. </p></section><footer class='text-right'><a href='opmac-tricks.html#dekadic2' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0171</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2019-12-07'>12/07/2019</time></span> </footer></article> <article id='ltable1' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The table over more than one page</h3> <a href='#ltable1'><i class='fas fa-link'></i></a></div></header><section><p>The primitive <code>\halign</code> creates the lines of the table and puts them to the vertical list. This list is breakable to the pages if it is not included in the internal <code>\vbox</code>. This feature can be demonstrated by the simple long table. We need to have the horizontal rules between each line and we needn't to repeat the header of the table at each new page (the header repeating is solved by the next OPmac trick). The user write: </p><pre class='pr-3'><code>\longtable{|c|c|}{data &amp; data \cr 
                  data &amp; data \cr 
                  ... much more &amp; data ... \cr} 
</code></pre><p>and the centered table over more pages is printed. The usage of <code>\raggedbottom</code> is recommended for this situation because the lines of the table are not vertically stretchable. The <code>\longtable</code> can be implemented by few lines of the code: </p><pre class='pr-3'><code>\def\longtable{\goodbreak \bgroup \catcode`\|=12 \tableL} 
\def\tableL#1#2{\setbox0=\table{#1}{#2}\setbox0=\hbox to\wd0{} % table draft 
   \tmpdim=\hsize \advance\tmpdim by-\wd0 \divide\tmpdim by2   % calculation of indent 
   \def\tabstrut{\vrule height1.1em depth.5em width0pt }       %  baselineskip 
   \everycr={\longtablecr}\offinterlineskip                    % \everycr 
   \def\tmpa{}\tabdata={\kern\tmpdim}\scantabdata#1\relax      % \tabdata 
   \halign\expandafter{\the\tabdata\tabstrutA\cr#2\crcr}\egroup\goodbreak} 
\def\longtablecr{\noalign{\nobreak\ltrule\penalty0\kern-.4pt\ltrule\nobreak}} 
\def\ltrule{\moveright\tmpdim\hbox to\wd0{\hrulefill}} 
</code></pre><p>The main idea of this macro is in the <code>\everycr</code> which inserts after each <code>\cr</code> the code: <code>\noalign{\hrule\penalty0\kern-.4pt\hrule\nobreak}</code>. Two equal rules are printed between each two lines, one rule overlap the second. The penalty 0&nbsp;between the rules is the point of potential page break. The first rule keeps on the previous page and the second rule starts the new page if the penalty 0&nbsp;is real page break. </p><p>The next trick of this code solves the centering of this long table. This is the reason why we print the draft of the table first in the box0 and we calculate the indentation of the table in <code>\tmpdim</code>. This indentation is inserted into the table declaration before the first cell. The <code>\ltrule</code> is the <code>\hrule</code> shifted by the indentation. </p></section><footer class='text-right'><a href='opmac-tricks.html#ltable1' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0023</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-31'>08/31/2013</time></span> </footer></article> <article id='ltable2' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Long tables with the repeated title</h3> <a href='#ltable2'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\longtableT</code> macro creates the long table over more pages with repeated title at the start of each page with rules above and below the title and the rule below the part of the table at each page. The usage: </p><pre class='pr-3'><code>\def\strutT {\vrule height1.1em depth.8em width0pt} % strut for the title 
\longtableT {|c|c|c|}{ head1 &amp; head2 &amp; head22 \cr \tskip3pt  % title 
                       data  &amp; data  &amp; data   \cr 
                       data  &amp; ... much more &amp; data ...\cr} 
</code></pre><p>The <code>\strutT</code> have to be defined for the header. The header will be surrounded by the horizontal rules and the normal interline strut seems to be small in such special case. The <code>\tskip</code> usage after the header is mandatory, it is used after each occurrence of the header and before the closing rule at the bottom of the pages. The horizontal rule between data lines isn't allowed. The <code>\longtableT</code> macro is implemented by: </p><pre class='pr-3'><code>\def\longtableT#1#2{\goodbreak \bgroup \setbox0=\table{#1}{\strutT\relax#2} 
   \setbox1=\vbox{\unvbox0 \setbox2=\vbox{}\revertbox} 
   \setbox2=\vbox{\unvbox2 \global\setbox4=\lastbox\unskip \global\setbox5=\lastbox\unskip} 
   \whatfree4 \advance\tmpdim by-.8pt \ifdim\tmpdim&lt;\baselineskip \vfil\break \fi 
   \offinterlineskip \crule\center4\crule\center5 \printboxes 
   \center5\crule \egroup \goodbreak 
} 
\def\whatfree#1{\tmpdim=\vsize \advance\tmpdim by-\pagetotal 
   \advance\tmpdim by-\prevdepth \advance\tmpdim by-.4pt 
   \advance\tmpdim by-\ht#1 \advance\tmpdim by-\dp#1 \advance\tmpdim by-\ht5 } 
\def\revertbox {\setbox0=\lastbox\unskip 
   \ifvoid0 \else \global\setbox2=\vbox{\unvbox2\box0} \revertbox\fi } 
\def\printboxes{\setbox2=\vbox{\unvbox2 \global\setbox0=\lastbox\unskip} 
   \ifvoid0 \else \whatfree0 
      \ifdim\tmpdim&lt;0pt \center5\crule\vfil\break \crule\center4\crule\center5 \fi 
      \center0 \nobreak \printboxes \fi } 
\def\crule{\centerline{\hbox to\wd4{\hrulefill}}\nobreak} 
\def\center#1{\centerline{\copy#1}\nobreak} 
</code></pre><p>The macro creates the draft of the table in the box0. This box is reassembled by <code>\revertbox</code> and saved to box2. The header is saved to box4 and the <code>\tskip</code> after header is in the box5. The macro <code>\printboxes</code> takes the lines from box2 and puts them into the page by <code>\center</code>. The <code>\whatfree</code> macro measures the rest of the free space on the page. If there isn't free space here then <code>\box5\crule</code> is added, new page is started and <code>\crule\box4\crule\box5</code> is printed at the begin of the next page. </p></section><footer class='text-right'><a href='opmac-tricks.html#ltable2' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0024</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-31'>08/31/2013</time></span> </footer></article>
                            </section>  <section id="obrazky" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Images</h2>
                                    <a href="#obrazky"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='inspicspace' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The space as a separator of \inspic parameter</h3> <a href='#inspicspace'><i class='fas fa-link'></i></a></div></header><section><p>OPmac supposes that the name of the image file (i.e. the parameter of the <code>\inspic</code> macro) is separated by space. This is similar (but not exactly the same) as behavior of the primitive command <code>\input</code>. We needn't to use braces, only the space (or the end of line) must be inserted after the end of the filename. If you need to read the file with the space inside its name then braces can be used but space after right brace must be inserted too: </p><pre class='pr-3'><code>\inspic {special file with spaces in the name.pdf} % &lt;- mandatory space here 
</code></pre><p>If you hate to use space at the end of filename and you like to use only braces then you can deactivate the mandatory space separator from <code>\inspic</code> macro by this trick: </p><pre class='pr-3'><code>\expandafter\def\expandafter\inspic\expandafter#\expandafter1\expandafter{\inspic{#1} } 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#inspicspace' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0141</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-04-09'>04/09/2016</time></span> </footer></article> <article id='inkinspic' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The Inkscape labels for pictures</h3> <a href='#inkinspic'><i class='fas fa-link'></i></a></div></header><section><p>The program Inkscape is able to split the text labels from the rest graphics: you need to specify PDF+LaTeX option in the dialog window when the image is saved. Th rest graphics is saved into <code>file.pdf</code> and the additional file with the name <code>file.pdf_tex</code> is created where the labels and their positions are saved by the LaTeX syntax. We can write in our document: </p><pre class='pr-3'><code>\inkinspic file.pdf 
</code></pre><p>This macro loads the <code>file.pdf</code> with the graphics and the <code>file.pdf_tex</code> with the text labels. The width of the image will be <code>\picw</code> like the normal OPmac <code>\inspic</code> is used. </p><p>The text labels are printed in the same font family as the surrounded text. Inkscape doesn't solve this font. We can use arbitrary font in arbitrary size in the preview in the Inkscape. This is irrelevant for the final typesetting. You can write TeX commands into labels when Inkscape is used (for example the math symbols between dollars). The text label position can be left aligned, right aligned or centered (see the menu items in the Inkscape). This alignment defines the point which will be at the same place in the final typesetting. You can rotate or colorize the text. </p><p>In order we can use these feature (prepared with LaTeX syntax) in OPmac we need to emulate some LaTeX macros which are present in the exported file: <code>\begin{picture}</code>, <code>\put</code>, <code>\makebox</code>, etc. The following code  is sufficient for this: </p><pre class='pr-3'><code>\def\inkinspic #1 {\bgroup 
  \ifdim\picw=0pt 
    \setbox0=\hbox{\inspic#1 }% 
    \picw=\wd0 
  \fi 
  \the\inkdefs \input \picdir#1_tex \egroup 
} 
\newtoks\inkdefs  \inkdefs={%  
  %\ifdim\picw=0pt \message{inkinspic: \picw set to \hsize}\picw=\hsize \fi  
  \def\makeatletter#1\makeatother{}%  
  \def\includegraphics[#1]#2{\inkscanpage#1,page=,\end \inspic #2 \hss}%  
  \def\inkscanpage#1page=#2,#3\end{\ifx,#2,\else\def\inspicpage{page#2}\fi}%  
  \def\put(#1,#2)#3{\nointerlineskip\vbox to0pt{\vss\hbox to0pt{\kern#1\picw  
      \pdfsave\hbox to0pt{#3}\pdfrestore\hss}\kern#2\picw}}%  
  \def\begin#1{\csname begin#1\endcsname}% 
  \def\beginpicture(#1,#2){\vbox\bgroup\hbox to\picw{}\kern#2\picw \def\end##1{\egroup}}% 
  \def\begintabular[#1]#2#3\end#4{\vtop{\def\\{\cr}\def\tabiteml{}\def\tabitemr{}\table{#2}{#3}}}% 
  \def\color[#1]#2{\scancolor #2,}%  
  \def\scancolor#1,#2,#3,{\pdfliteral{#1 #2 #3 rg}}%  
  \def\makebox(#1)[#2]#3{\hbox to0pt{\csname mbx:#2\endcsname{#3}}}%  
  \sdef{mbx:lb}#1{#1\hss}\sdef{mbx:rb}#1{\hss#1}\sdef{mbx:b}#1{\hss#1\hss}%  
  \sdef{mbx:lt}#1{#1\hss}\sdef{mbx:rt}#1{\hss#1}\sdef{mbx:t}#1{\hss#1\hss}%  
  \def\rotatebox#1#2{\pdfrotate{#1}#2}% 
  \def\lineheight#1{}% 
  \def\setlength#1#2{}% 
} 
</code></pre><p>Warning, space syntax: the <code>\nkinspic</code> macro (similar as <code>\inspic</code>) experts one parameter as file name separated by space. This is analogical behavior as \input command. But the space is needed always when <code>\inspic</code>, <code>\inkinspic</code> macros are used. If you need the picture to be centered, you have to write: </p><pre class='pr-3'><code>\centerline{\picw=7cm \inkinspic picture.pdf } 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#inkinspic' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0032</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-10-02'>10/02/2013</time></span> </footer></article> <article id='capside' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Caption beside of the image</h3> <a href='#capside'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/cap-side.png' alt='Caption side by image' title='Caption side by image' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>If the image is more tall than wide then it is more convenient to put the caption beside of the image, no above or below. This can be done by the following code: </p><pre class='pr-3'><code>\hbox to\hsize{\picw=.4\hsize \inspic mapa.jpg 
  \hfil\vbox{\hsize=.55\hsize \iindent=0pt \emergencystretch=2em 
    \caption/f Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
       ... 
       Fusce sagittis lobortis nisi sed consectetur. 
   \par}} 
</code></pre><p>Note that the internal <code>\vbox</code> must be finished by <code>\par</code> because OPmac redefines <code>\par</code> in <code>\caption</code> macro. The first usage of <code>\par</code> returns the original meaning of <code>\par</code>. Next issue is setting <code>\iindent=0pt</code> because we need not to print the narrower text here. </p></section><footer class='text-right'><a href='opmac-tricks.html#capside' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0136</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-01-06'>01/06/2016</time></span> </footer></article> <article id='inspic' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>\inspic loads the same image only once</h3> <a href='#inspic'><i class='fas fa-link'></i></a></div></header><section><p>We know that <code>\pdfximage</code> primitive provides the possibility to insert ti image only once and if you need to thow it at different places in the document then all such occurrences are realized only by pointer <code>\pdfrefximage</code>. But <code>\inspic</code> macro from OPmac doesn't provide this feature. If you print the same image using <code>\inspic</code>, then the PDF file has bigger size. </p><p>We implemented the partial show of slides (see <a href='#slidekuk' title='OPmac trick 0022'>OPmac trick 0022</a> and <a href='http://petr.olsak.net/ctustyle.html' title='CTUstyle'>CTUstyle</a>). The <code>\inspic</code> macro was modified for this purpose: the data of each unique image are stored only once in the PDF file. The solution is simple: </p><pre class='pr-3'><code>\let\oriinspic=\inspic 
\def\picdim{\the\picwidth:\the\picheight} 
\def\inspic#1 {% 
   \expandafter\ifx\csname pic:#1:\picdim\endcsname \relax 
      \oriinspic#1 % first insertion of the image 
      \global\expandafter\mathchardef\csname pic:#1:\picdim\endcsname=\pdflastximage 
   \else \expandafter\pdfrefximage \csname pic:#1:\picdim\endcsname % second and more 
   \fi 
} 
</code></pre><p>We see that the reference number of the image is a&nbsp;part of control sequence with the values of <code>\picwidth</code> and <code>\picheight</code> registers. The different values of these registers needs new loading of the image or user can use it but with a&nbsp;linear transformation. </p><p>The solution is based on the features of pdfTeX (available in LuaTeX too) but this isn't usable in XeTeX. The XeTeX implementation isn't done. </p></section><footer class='text-right'><a href='opmac-tricks.html#inspic' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0110</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-06-04'>06/04/2015</time></span> </footer></article>
                            </section>  <section id="odstavec" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Paragraph</h2>
                                    <a href="#odstavec"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='setparshape' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Comfortable \parshape setting</h3> <a href='#setparshape'><i class='fas fa-link'></i></a></div></header><section><p>The common shape of a&nbsp;paragraph can be declared by <code>\parshape</code> primitive, but the parameters for this primitive has non-comfortable syntax. Thus, TBN page 236 mentions the macro <code>\oblom</code> which can be used for rectangular croppings. The macro <code>\setparshape</code> presented here is able to set more general croppings. Examples: </p><pre class='pr-3'><code>\setparshape\left (3*0, 7*35)mm  % three normal lines, then 7 shorten lines 
% or 
\setparshape\right (4*0, 5,10,15,20,25,20,15,10,5)mm % triangular cropping right 
</code></pre><p>The macro <code>\setparshape</code> reads <code>\left</code> or <code>\right</code> first in order to decide the side where margins will be modified. The parentheses include the comma separated list of items in the form <code>number*dimen</code>, where <code>number</code> denotes the number of lines which are shorten by <code>dimen</code> value. If there isn't the <code>*</code> operator then only one line is shorten by <code>dimen</code> specified. The unit associated for all <code>dimens</code> is included after the closing parenthesis and it is separated by space. If you want to specify the unit explicitly in the data, you can use <code>(...){}</code> syntax, it means: </p><pre class='pr-3'><code>\setparshape\left (3*0pt, 7*.4\hsize){} 
</code></pre><p>This creates rectangular cropping over seven lines after three untouched lines and the same result can be achieved by </p><pre class='pr-3'><code>\setparshape\left (3*0, 7*.4){\hsize} 
</code></pre><p>The <code>\setparshape</code> setting is local in only one following paragraph (like <code>\parshape</code> does). If you need to influence more than one paragraph then you must to write <code>\globalshape</code> before, for example: </p><pre class='pr-3'><code>\globalshape\setparshape\left (3*0, 12*55)mm 
</code></pre><p>The implementation follows: </p><pre class='pr-3'><code>\newcount\parshapenum \newcount\globpar 
 
\def\setparshape#1(#2)#3 {\def\parshapedata{}\parshapenum=1 
   \let\parshapeside=#1\def\parshapeunit{#3}\setparshapeA#2,,% 
} 
\def\setparshapeA#1,{\ifx,#1,\parshape=\parshapenum\parshapedata0pt\hsize 
   \else\fihere\setparshapeB#1\empty*\empty\end\fi 
} 
\def\setparshapeB#1*#2\empty#3\end{% 
   \ifx,#3,\tmpnum=1 \tmpdim=#1\parshapeunit \relax 
   \else \tmpnum=#1\tmpdim=#2\parshapeunit \relax \fi 
   \loop \ifnum\tmpnum&gt;0 
      \advance\tmpnum by-1 \advance\parshapenum by1 
      \dimen0=\hsize \advance\dimen0 by-\tmpdim 
      \ifx\parshapeside\left 
          \edef\parshapedata{\parshapedata\the\tmpdim\space\the\dimen0}% 
      \else\edef\parshapedata{\parshapedata0pt\the\dimen0}\fi 
   \repeat 
   \setparshapeA 
} 
\def\fihere#1\fi{\fi#1} 
\def\globalshape{% TBN page 237 
   \global\globpar=0 \gdef\par{\ifhmode\shapepar\fi}% 
} 
\def\shapepar{\prevgraf=\globpar \parshape=\parshapenum\parshapedata0pt\hsize 
   \endgraf \global\globpar=\prevgraf 
   \ifnum\prevgraf&lt;\parshapenum \else \global\let\par=\endgraf\fi 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#setparshape' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0154</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-07'>06/07/2016</time></span> </footer></article> <article id='putshape' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Rectangular text-cropping with an image</h3> <a href='#putshape'><i class='fas fa-link'></i></a></div></header><section><p><img src='img/ukazka-kachna.png' alt='Sample duck' title='Sample duck' class='img-fluid rounded mx-auto my-2 d-block'> </p><p>We create the macro <code>\putshape side number {object}</code>. It inserts an <code>object</code> into the next paragraph with rectangular copping for the <code>object</code> after <code>number</code> lines at left side (<code>side</code> is \left) or right side (<code>side</code> is <code>\right</code>). The number of indented lines and the indentation size are computed from the dimensions of the <code>object</code> automatically. The typical usage looks like: </p><pre class='pr-3'><code>\putshape\right 4 {\picw=3cm \inspic duck.png } 
</code></pre><p>The macro from this example inserts the image at right side after four normal lines of the paragraph. There are margins above and below the <code>object</code> given by <code>\putvargin</code> register and the space alongside the <code>object</code> and the the text is given by <code>\puthmarhin</code>. Both registers are set to <code>5pt</code> by default. </p><p>The implementation is based on <code>\setparshape</code> macro from previous <a href='#setparshape' title='OPmac trick 0154'>OPmac trick 0154</a>: </p><pre class='pr-3'><code>\newdimen\putvmargin \newdimen\puthmargin 
\putvmargin=5pt \puthmargin=5pt 
 
\def\putshape#1#2#{\let\tmpa=#1\def\tmpb{#2}\putshapeA} 
\def\putshapeA#1{\vskip\parskip 
   \setbox0=\vbox{\kern\putvmargin\hbox{#1}\kern\putvmargin}\tmpnum=\ht0 
   \advance\tmpnum by-10 \divide\tmpnum by\baselineskip \advance\tmpnum by1 
   \dimen0=\wd0 \advance\dimen0 by\puthmargin 
   \hbox to\hsize{\ifx\tmpa\right \hfill\fi 
      \vbox to0pt{\kern\tmpb\baselineskip\kern-.8\baselineskip 
         \vbox to\the\tmpnum\baselineskip{\vss\box0\vss}\vss}\hss} 
   \nobreak\vskip-\parskip\vskip-\baselineskip 
   \edef\tmpb{\tmpa(\tmpb*0pt,\the\tmpnum*\the\dimen0)} 
   \globalshape\expandafter\setparshape\tmpb{} 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#putshape' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0155</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-08'>06/08/2016</time></span> </footer></article>
                            </section>  <section id="slidy" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Slides</h2>
                                    <a href="#slidy"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='sparta' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Simple slides</h3> <a href='#sparta'><i class='fas fa-link'></i></a></div></header><section><p>If we need to use data projector for displaying our text then we need landscape format and sufficiently big size of the font. The sans-serif font is recommended. If you needn't more specials then you can simply do this: </p><pre class='pr-3'><code>\input opmac 
 
\margins/1 a5l (1,1,1,1.2)cm        % landscape format 
\input chelvet  \typosize[17/22]    % big sansserif font 
 
\def\sec#1\par{\centerline 
     {\secfont#1\unskip}\bigskip}   % sections centered without numbers 
\def\pg{\vfil\break}                % the new-page macro 
\begitems                           % whole document is an item list 
</code></pre><p>The text is structured by stars to the individual shouts. The <code>\sec</code> can be used for titles and <code>\pg</code> creates new slide. </p><pre class='pr-3'><code>\sec Some good idea 
 
* first shout 
* second shout 
* third shout 
 
\pg 
\sec Next amazing idea 
 
* fourth shout 
* fifth shout 
 
\enditems\end 
</code></pre><p>If you need logos at every slide, interesting graphics etc then you have to tune this and create a&nbsp;special template. I&nbsp;recommend to use <a href='#podklad' title='the OPmac trick about background image'>the OPmac trick about background image</a>. </p></section><footer class='text-right'><a href='opmac-tricks.html#sparta' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0017</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-18'>08/18/2013</time></span> </footer></article> <article id='slidekuk' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Slideshow -- partial exposure</h3> <a href='#slidekuk'><i class='fas fa-link'></i></a></div></header><section><p>Some projectionists prefer the gradual uncovering of their ideas: first only a&nbsp;part of the slide, next uncover another part etc. These projectionists can write <code>\kuk</code> in the place, where the next idea could be hidden first. The page will be created from the beginning of the page to the <code>\kuk</code>. The next page copies all information from previous page but adds the text after <code>\kuk</code> (from this <code>\kuk</code> to another <code>\kuk</code> or to the end of the page). The next page follows this principle, i.e copies previous page, if the <code>\kuk</code> was used. The definitive end of the page is marked by <code>\pg\kuk</code> (no <code>\kuk\pg</code>) and the document ends by <code>\enditems\end\kuk</code>. We have to use the <code>\kukstart</code> at the begin of the document (after all macro definitions are read and after the first <code>\begitems</code>). If the <code>\kukstart</code> sequence is commented out then normal slides are generated and <code>\kuk</code> sequences are ignored. </p><p>The <code>\kuk</code> implementation follows the previous OPmac trick and adds the following macros after first <code>\begitems</code>: </p><pre class='pr-3'><code>\let\kuk=\relax 
\def\kukdata{} 
\long\def\kukstart#1\kuk{\addto\kukdata{#1}% 
   \tmpnum=0 \def\endkukdata{}\expandafter\sumkuk \kukdata\sumkuk 
   \kukdata\endkukdata \vfil\break \kukstart 
} 
\long\def\sumkuk#1{\ifx\sumkuk#1% the end of the list 
   \loop \ifnum\tmpnum&gt;0 \addto\endkukdata{\enditems}\advance\tmpnum by-1 \repeat 
   \else 
     \ifx\begitems#1\global\advance\tmpnum by1 \fi 
     \ifx\enditems#1\global\advance\tmpnum by-1 \fi 
     \expandafter\sumkuk \fi 
} 
\count1=1 
\def\advancepageno{\ifx\kukdata\empty \global\advance\pageno by1 \global\count1=1 
                   \else \global\advance\count1 by1 \fi} 
\def\pg{\def\kukdata{}\vfil\break} 
\kukstart 
</code></pre><p>The macro <code>\kukstart</code> repeats in the loop and reads the text to the <code>\kuk</code> sequence. It adds the read parameter to the <code>\kukdata</code> from previous step of the loop and prints the pages. The <code>\pg</code> macro removes the <code>\kukdata</code>. If the <code>\kuk</code> is used inside the next level of the <code>\begitems...\enditems</code> environment then special care is needed. The <code>\sumkuk</code> macro calculates the level of the nesting and inserts the right number of closing <code>\enditems</code> into <code>\endkukdata</code>. </p><p>**Note**: More elaborate solution of creating slides with OPmac can be found in <a href='http://petr.olsak.net/ftp/olsak/ctustyle/slidy.pdf' title='CTUslides'>CTUslides</a> which is a&nbsp;part of the <a href='http://petr.olsak.net/ctustyle-e.html' title='CTUstyle'>CTUstyle</a> package. </p></section><footer class='text-right'><a href='opmac-tricks.html#slidekuk' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0022</span> <span class='badge badge-info'>Author: Mirek + P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-30'>08/30/2013</time></span> </footer></article>
                            </section>  <section id="bibliograficke-udaje" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Bibliography</h2>
                                    <a href="#bibliograficke-udaje"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='pcite' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Cites with the inserted text</h3> <a href='#pcite'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes we need to print the citation with inserted note, for example with the page of the cited book. For example </p><p>The flowing the text around the picture is solved in [27, p. 236]. </p><p>We can do this by <code>\rcite</code>: </p><pre class='pr-3'><code>The flowing the text around the picture is solved in~[\rcite[tbn], p.~236]. 
</code></pre><p>Maybe we found usable the extended syntax of the <code>\cite</code> macro: when the <code>[label]</code> is followed by slash: </p><pre class='pr-3'><code>The flowing the text around the picture is solved in~\cite[tbn]/{p.~236}. 
</code></pre><p>then the result [27, p. 236] is generated. The feature is implemented here: </p><pre class='pr-3'><code>\def\cite[#1]{\isnextchar/{\pcite[#1]}{[\rcite[#1]]}} 
\def\pcite[#1]/#2{[\rcite[#1],~#2]} 
</code></pre><p>Now, the <code>\cite</code> macro is sensitive to the presence of the following slash. If slash isn't present then <code>\rcite</code> surrounded by <code>[...]</code> is used. Else <code>\pcite</code> is executed. </p></section><footer class='text-right'><a href='opmac-tricks.html#pcite' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0038</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-01'>04/01/2014</time></span> </footer></article> <article id='ccite' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The [name year] condensed cites</h3> <a href='#ccite'><i class='fas fa-link'></i></a></div></header><section><p>When <code>\nonumcitations</code> is declared and the marks are in the form <code>[name, year]</code> then it is convenient to avoid the repetition of the same name in one bundle of citations. For example: </p><pre class='pr-3'><code>TeX is mentioned in Czech books \cite[tst,tbn,tpp,lpp]. 
</code></pre><p>we get [Olšák, 1995, Olšák, 1997, Olšák, 2013, Satrapa, 2011] but we want something like [Olšák, 1995, 1997, 2013, Satrapa, 2011]. This is possible to solve it by <code>\ecite</code>, for example: </p><pre class='pr-3'><code>[\rcite[tst], \ecite[tbn]{1997}, \ecite[tpp]{2013}, \rcite[lpp]] 
</code></pre><p>but more comfortable is to leave this work to TeX. The following code solve it. </p><pre class='pr-3'><code>\nonumcitations 
\def\printcite#1{\citesep 
   \prepcitelink{#1}\citelink{#1}{\the\bibmark}\def\citesep{,\hskip.2em\relax}% 
} 
\def\prepcitelink#1{% 
   \isdefined{bim:#1}\iftrue 
      \expandafter\expandafter\expandafter \ppclink \csname bim:#1\endcsname!\relax 
   \else \opwarning{condensed cites: empty bibmark}\bibmark={#1}% 
   \fi 
} 
\def\ppclink #1, #2!\relax{\def\tmpa{#1}% 
   \ifx \lastcitedname\tmpa \bibmark={#2}% 
   \else \let\lastcitedname=\tmpa \if^#2^\bibmark={#1}\else\bibmark={#1, #2}\fi 
   \fi 
} 
</code></pre><p>This code redefines the <code>\printcite</code> macro (from OPmac) in order to the <code>\citelink</code> is called with the parameter <code>\the\bibmark</code>. The <code>\bibmark</code> contents is prepared by <code>\prepcitelink</code>. The <code>\prepcitelink</code> macro decomposes the mark (using <code>\ppclink</code>) to the prat before comma-space and the rest. The macro <code>\lastcitedmane</code> is undefined at the start and it is set to the last cited name. If the next name is the same then only the year is saved to <code>\bibmark</code>. Else name plus year is saved. Because <code>\cite</code> is processed inside the group, the <code>\lastcitedname</code> is returned back to undefined meaning so the first item in the next <code>\cite</code> bundle will have name plus year always. </p><p>The code above works only if all marks are prepared in the form <code>name, year</code> (comma+space between them). When the <code>year</code> is empty then the name must be terminated by comma+space. The BibTeX style <code>apalike</code> is compatible with this. </p></section><footer class='text-right'><a href='opmac-tricks.html#ccite' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0039</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-01'>04/01/2014</time></span> </footer></article> <article id='modcite' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The modification of (name year) cites</h3> <a href='#modcite'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes somebody needs to print cite marks in the form “name year” (without comma between them), for example [Olšák 2013]. You can use the code from previous OPmac trick and correct it in one aspect: </p><pre class='pr-3'><code>\def\ppclink #1, #2!\relax{\def\tmpa{#1}% 
   \ifx \lastcitedname\tmpa \bibmark={#2}% 
   \else \let\lastcitedname=\tmpa \if^#2^\bibmark={#1}\else\bibmark={#1 #2}\fi 
   \fi 
} 
</code></pre><p>The BibTeX style <code>apalike</code> generates the commas between items but the <code>\ppclink</code> macro defined above removes them during printing. </p><p>Sometimes somebody wants to surround the mark(s) in rounded brackets as (Olšák 2013). If you needs to do it too then you can define: </p><pre class='pr-3'><code>\def\cite[#1]{(\rcite[#1])} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#modcite' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0043</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-02'>04/02/2014</time></span> </footer></article> <article id='abib' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Cite-marks in the bibliography when \nonumcitations is used</h3> <a href='#abib'><i class='fas fa-link'></i></a></div></header><section><p>OPmac (by default) doesn't print the cite-marks in the bibliography list when <code>\nonumcitations</code> is used. We suppose that the bibliography list is sorted by the name of the first author and the same is in the cite-mark. So, the copy of the cite-mark in the bibliography list is redundant, especially when the marks have long format like (Olsak, 2001). But when the marks are short [Ol01] then the copy of the mark may be usable in the bibliography list. </p><p>If you need to repeat the cite-marks in bibliography list when <code>\nonumcitations</code> is used then you have to re-define the <code>\printbib</code> macro. This macro is processed at the begin of each bibliography entry when the list is printed. Example: </p><pre class='pr-3'><code>\def\printbib{\hangindent=2\iindent 
   \noindent\hskip2\iindent \llap{[\the\bibmark] }% 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#abib' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0096</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-12'>04/12/2015</time></span> </footer></article> <article id='bibmark' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Short cite-marks generated by opmac-bib</h3> <a href='#bibmark'><i class='fas fa-link'></i></a></div></header><section><p>The <code>\cite</code> prints cite-marks (called bibmark) instead numbers when <code>\nonumcitations</code> is set. The <code>opmac-bib.tex</code> macro for direct reading of .bib databases provides two style files (<code>simple</code> and <code>iso690</code>). They generate long bibmarks by default, like (Knuth, 1984). Sometimes we need to generate the marks in the short form, like [Kn84]. We can set such marks as an exception using bibmark field in <code>.bib</code> file and we can use <a href='http://petr.olsak.net/opmac-tricks-e.html#abib' title='OPmac trick 0096'>OPmac trick 0096</a> to print them in the bibliography list. Now, we show how to redefine the bibmark generator in order to it generates the marks in short form. We needn't use bibmark exception field. </p><pre class='pr-3'><code>\def\mysetbibmark{% 
   \ifx\dobibmark\undefined \def\dobibmark{}\fi 
   \RetrieveFieldIn{bibmark}\tmp 
   \ifx\tmp\empty 
      \RetrieveFieldIn{year}\tmp 
      \edef\tmp{\expandafter\bibmarkA\dobibmark{}{}\relax\expandafter\bibmarkB\tmp{}{}{}{}\relax} 
   \fi 
   \bibmark=\expandafter{\tmp}% 
} 
\def\bibmarkA#1#2#3\relax{#1#2}     % first two letters from the author name 
\def\bibmarkB#1#2#3#4#5\relax{#3#4} % last two digits from the year 
 
\def\bibtexhook{\let\setbibmark=\mysetbibmark} 
</code></pre><p>The macro uses the last name of the first author saved in <code>\dobibmark</code> by the style file and extracts two first tokens from it by <code>\bibmarkA</code> and two digits from the year by <code>\bibmarkB</code>. </p><p>If you have generated two equal marks (citing a&nbsp;fertile author with more publications in one year) then you can declare an exception by bibmark field in the <code>.bib</code> file to distinguish the bibmarks. Another possibility is to create more intelligent macro which generates unique bibmarks by adding the letters a, b, c&nbsp;etc if needed. This is an exercise for a&nbsp;skilful macro programmer. </p></section><footer class='text-right'><a href='opmac-tricks.html#bibmark' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0097</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-12'>04/12/2015</time></span> </footer></article> <article id='bibmarkcheck' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Are cite-marks unique?</h3> <a href='#bibmarkcheck'><i class='fas fa-link'></i></a></div></header><section><p>If you have no contact to a&nbsp;skilful macro programmer mentioned in the previous OPmac trick then you can use the <code>\bibmarkcheck</code> macro. It checks if all used bibmarks (printed by <code>\cite</code> when <code>\nonumcitations</code> is set) are unique. OPmac doesn't do this check by default, so it is possible to have the same bibmark connected to more bibliography records in your document without any warning. </p><p>The check is done by <code>\bibmarkcheck</code>. The macro definition and the macro call can be inserted after <code>\input opmac</code> at beginning of your document. </p><pre class='pr-3'><code>\def\bibmarkcheck{\ifx\lastbibnum\undefined \else 
   \bgroup 
      \bibnum=0 
      \loop 
         \advance\bibnum by1 
         \isdefined{bim:\the\bibnum}\iftrue 
            \isdefined{\csname bim:\the\bibnum\endcsname}\iftrue 
               \opwarning{Duplicated bibmark: "\csname bim:\the\bibnum\endcsname"}% 
            \fi 
            \sdef{\csname bim:\the\bibnum\endcsname}{}% 
         \fi 
         \ifnum\bibnum&lt;\lastbibnum \relax \repeat 
   \egroup 
   \fi 
} 
\bibmarkcheck 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#bibmarkcheck' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0098</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-04-12'>04/12/2015</time></span> </footer></article> <article id='bibnumindent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Bibliography indentation by maximal cite number</h3> <a href='#bibnumindent'><i class='fas fa-link'></i></a></div></header><section><p>OPmac ignores the item (generated by BibTeX) about the number of digits of the maximal number in the bibliography list. The reason is that OPmac provides to assemble the bibliography list by <code>\bib</code> sequences outside BibTeX and it provides the usage of pre-generated databases in various form and the BibTeX-generated value cannot be exactly true. OPmac introduces the <code>\lastbibnum</code> which includes the maximal number in the bibliography list after REF file is read. By default this value isn't used but you can use this when you design the format of bibliography list. For example: </p><pre class='pr-3'><code>\def\printbib{% 
   \ifx\lastbibnum\undefined \tmpdim=\iindent 
   \else \setbox0=\hbox{[\lastbibnum] }% 
      \ifdim \parindent=0pt \tmpdim=\wd0 
      \else \tmpdim=0pt \loop \advance\tmpdim by\parindent 
                              \ifdim\tmpdim&lt;\wd0 \repeat 
   \fi\fi 
   \hangindent=\tmpdim \noindent \hskip\tmpdim \llap{[\the\bibnum] }% 
} 
</code></pre><p>The format-making macro <code>\printbib</code> is redefined here. It measures the box with the <code>[\lastbibnum]~</code>. If <code>\parindent</code> is zero then <code>\tmpdim</code> is set to the width of this box else <code>\tmpdim</code> is set to the multiply of the <code>\parindent</code> so, that the box fits into the generated space. The bibliography list is indented by <code>\tmpdim</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#bibnumindent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0040</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-01'>04/01/2014</time></span> </footer></article> <article id='bibmarkindent' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Bibliography indentation by maximal mark</h3> <a href='#bibmarkindent'><i class='fas fa-link'></i></a></div></header><section><p>The bibliography list needn't to be numbered; the marks can be used instead numbers. The last mark cannot be the mark with the maximal width (as opposite to the numbers). We need to indent the bibliography list by the maximal width of the marks. </p><p>The <code>\halign</code> primitive is one choice as to do it but this is not most practical here. We show another solution using REF file. The solution is usable for another similar situations, no only bibliography lists. </p><p>We ask user to add the sequence <code>\setbibindent</code> at the end of the bibliography list. This macro writes the value of the maximal width of used marks into REF file and this value is read in the next TeX run when REF file is read. The <code>\printbib</code> macro uses it. But <code>\printbib</code> measures the width of the marks and sent the value to <code>\setbibitem</code> macro in the <code>\bibindent</code> control sequence. The code is here: </p><pre class='pr-3'><code>\nonumcitations 
\def\printbib{% 
   \setbox0=\hbox{[\the\bibmark]\quad}% 
   \ifx\bibindent\undefined \def\bibindent{0pt}\fi 
   \ifdim\wd0&gt;\bibindent \edef\bibindent{\the\wd0}\fi 
   \ifx \Xbibindent\undefined 
      \hangindent=\wd0 \noindent [\the\bibmark]\quad 
   \else 
      \hangindent=\Xbibindent \noindent \hskip\Xbibindent \llap{[\the\bibmark]\quad}% 
   \fi 
} 
\def\setbibindent{\ifx\bibindent\undefined \else 
   \openref\immediate\write\reffile{\def\noexpand\Xbibindent{\bibindent}}\fi} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#bibmarkindent' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0041</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-01'>04/01/2014</time></span> </footer></article> <article id='morebibs' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>More independent bibliography lists</h3> <a href='#morebibs'><i class='fas fa-link'></i></a></div></header><section><p>Suppose we are creating a&nbsp;Proceedings of a&nbsp;conference. Each article have its own bibliography list. The bibliography items can be stretch in more articles with various numbers. Each bibliography list is numbered from one. Labels from various articles can interfere too. </p><p>For example, we have an article where TBN is cited under the number 3&nbsp;but another article where TBN is cited under the number 21. When the <code>\cite[tbn]</code> occurs in the first article then the [3] have to be printed and the hyperlink have to be created with right aim. When the <code>\cite[tbn]</code> occurs in the second article then [21] have to be printed and the hyperlink points to the second bibliography list. </p><p>We need to set <code>\bibnum</code> to zero an set an unambiguous identifier of each article at the start of reading each article: </p><pre class='pr-3'><code>\bibnum=0 \def\citelist{} \def\bibpart{A} %%% A is identifier of first article 
... first article 
... 
\bibnum=0 \def\citelist{} \def\bibpart{B} %%% B is identifier of second article 
... second article 
... 
</code></pre><p>The following code is sufficient: </p><pre class='pr-3'><code>\def\wbib#1#2#3{\dest[cite:\bibpart-\the\bibnum]% 
   \ifx\wref\wrefrelax\else \immediate\wref\Xbib{{\bibpart-#1}{\bibpart-#2}{#3}}\fi} 
 
\let\citeAA=\citeA 
\def\citeA #1#2,{\if#1,\def\citeAA##1,##2,{}\fi\citeAA \bibpart-#1#2,} 
 
\def\printcite#1{\citesep \prepcite#1\relax 
   \citelink{#1}{\tmpa}\def\citesep{,\hskip.2em\relax}} 
\def\prepcite #1-#2{\def\tmpa{\citelinkA{#2}}} 
\let\writeXcite=\addcitelist 
 
\def\nonumcitations{\lastcitenum=0 \def\sortcitesA{}\def\etalchar##1{$^{##1}$}% 
   \def\citelinkA##1{%  \citelinkA needs the \bibpart info: 
      \isdefined{bim:\bibpart-##1}\iftrue \csname bim:\bibpart-##1\endcsname 
      \else ##1% 
      \opwarning{\noexpand\nonumcitations + empty bibmark. Maybe bad BibTeX style}\fi} 
} 
</code></pre><p>The <code>\bibpart-</code> is added before each label and the same prefix is added before each number. We have labels and numbers prefixed by the appropriate prefix. The <code>\cite</code> macro removes the prefix when printing numbers and adds it to the labels. </p></section><footer class='text-right'><a href='opmac-tricks.html#morebibs' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0042</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-01'>04/01/2014</time></span> </footer></article> <article id='bibtexenc' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>OPmac-bib: no more BibTeX problems</h3> <a href='#bibtexenc'><i class='fas fa-link'></i></a></div></header><section><p><a href='http://www.bibtex.org/' title='BibTeX'>BibTeX</a> (1995) is able to work only in ASCII encoding, the accents have to be added by \TeX (or more exactly BibTeX) syntax. But today, we need to write all characters “natural”. Such characters can bring problems with normal BibTeX. It is unable to sort by these characters. This is partially solved by bibtex8 variant of BibTeX which uses 8bit encoding and sorting rules are expressed in external files <code>.csf</code>. But today, we are using UTF-8 encoding (this is more than 8bit encoding). The BibTeX is unable to work with this encoding. Id doesn't sort right and breaks the encoding when converts to the uppercase. Somebody converts the bib databases to 8bit encoding, uses BibTeX and the result is converted back to UTF-8. This is not so optimal. </p><p>There exists a&nbsp;patch of bibtex8 called <code>bibtexu</code>. The documentation declares that bibtexu is able to work with UTF-8 input/output and works internally in Unicode using ICU library. Unfortunately this project isn't active and the program doesn't work (sometimes it deads in the infinitive loop). </p><p>There exist the new and active project Biber which is *absolutely unusable* for the plain TeX users because the main principle “power is simplicity” is totally lost here. It expected the configuration files in XML (huh!) which is read by external program biber. The result of biber is almost human unreadable .bbl file which is understandable only by very complicated biblatex macros. This is not the way for OPmac. </p><p>OPmac is able to read <code>.bib</code> file directly in UTF-8 encoding. BibTeX nor another external program isn't needed. Use <code>\usebib</code> command: </p><pre class='pr-3'><code>... \cite[cosi] a \cite[jiny]. 
 
List: 
\usebib/s (simple) mybase 
\end 
</code></pre><p>The format of the reference list is declared in a&nbsp;style file <code>opmac-bib-simple.tex</code>. Features are documented in the <code>opmac-bib.tex</code> and in the second style file <code>opmac-bib-iso690.tex</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#bibtexenc' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0047</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-04-19'>04/19/2014</time></span> </footer></article>
                            </section>  <section id="slovnicek" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Glossary</h2>
                                    <a href="#slovnicek"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='gloslast' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Glossary at the end of the document</h3> <a href='#gloslast'><i class='fas fa-link'></i></a></div></header><section><p>The abbreviations or some else can be occurred in the document and we need to write some explanations of such items at the end of the document. We write <code>\glos{abbreviation}{explanation}</code>. Nothing occurs in this place of the document. For example: </p><pre class='pr-3'><code>\input opmac 
... 
I am working at CTU\glos{CTU}{Czech Technical University in Prague} in Prague. 
</code></pre><p>The macro <code>\glos</code> saves the information into memory and uses them at the place where <code>\makeglos</code> is used. You can implement <code>\glos</code> and <code>\makeglos</code> by: </p><pre class='pr-3'><code>\def\gloslist{} 
\def\glos #1#2{% 
   \expandafter\isinlist\expandafter\gloslist\csname;#1\endcsname 
   \iftrue \opwarning{Duplicated glossary item `#1'}% 
   \else 
      \global\sdef{;#1}{{#1}{#2}}% 
      \global\expandafter\addto\expandafter\gloslist\csname;#1\endcsname 
   \fi 
} 
\def\makeglos{% 
   \ifx\gloslist\empty \opwarning{Glossary data unavailable}% 
   \else 
      \bgroup 
        \let\iilist=\gloslist 
        \dosorting 
        \def\act##1{\ifx##1\relax \else \expandafter\printglos##1\expandafter\act\fi} 
        \expandafter\act\iilist\relax 
      \egroup 
   \fi 
} 
\newdimen\glosindent  \glosindent=2\parindent 
\def\printglos #1#2{\noindent \hangindent=\glosindent \hbox to\glosindent{#1\hss-- }#2\par} 
</code></pre><p>The glossary is automatically sorted by the alphabet. If you needn't such sorting and the order by the occurrence is sufficient then you can comment out the <code>\dosorting</code> sequence in the <code>\makeglos</code> definition. </p><p>Of course, you can program the <code>\printglos</code> by your wish, by your typography design. The <code>\printglos</code> macro has two parameters: {abbreviation}{explanation} and it prints one glossary item in the list. The <code>\printglos</code> defined above sets fixed indentation <code>2\parindent</code> for all items. You can use another indentation, for example the indentation is calculated fro the maximal length of the abbreviation, see <a href='#bibmarkindent' title='OPmac trick 0041'>OPmac trick 0041</a>. </p><p>Another more simple example of the <code>\printglos</code>: </p><pre class='pr-3'><code>\def\printglos #1#2{\noindent #1 -- #2\par} 
</code></pre><p>Explanation: The <code>\glos</code> macro saves <code>\;abbrev1</code> <code>\;abbrev2</code> etc. into <code>\gloslist</code> and defines <code>\;abbrev1</code> as <code>{abbrev1}{explanation}</code>, <code>\;abbrev2</code> as <code>{abbrev2}{explanation}</code> etc. The macro <code>\makeglos</code> converts <code>\gloslist</code> to <code>\iilist</code> locally and does the alphabetically sorting by the macro <code>\dosorting</code> from OPmac. Finally, the <code>\act</code> macro prints the items. </p></section><footer class='text-right'><a href='opmac-tricks.html#gloslast' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0051</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article> <article id='glosfirst' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Glossary at the begin of the document</h3> <a href='#glosfirst'><i class='fas fa-link'></i></a></div></header><section><p>If you need to place the <code>\makeglos</code> (from previous trick) at the beginning of the document then you have two variants: put all <code>\glos</code> data before <code>\makeglos</code> at beginning of the document or use REF file. The second variant is described here more precisely. </p><p>The data is saved to REF file during the first TeX run (and during each next TeX run) and the data is used in second TeX run (and in each next TeX run). </p><pre class='pr-3'><code>\def\gloslist{} 
\def\Xglos #1#2{% 
   \expandafter\isinlist\expandafter\gloslist\csname;#1\endcsname 
   \iftrue \opwarning{Duplicated glossary item `#1'}% 
   \else 
      \sdef{;#1}{{#1}{#2}}% 
      \expandafter\addto\expandafter\gloslist\csname;#1\endcsname 
   \fi 
} 
 
\input opmac 
 
\def\glos #1#2{\openref\toks0={#2}\immediate\wref\Xglos{{#1}{\the\toks0}}} 
</code></pre><p>Note that the auxiliary macro <code>\Xglos</code> and the resetting of <code>\gloslist</code> have to be inserted before <code>\input opmac</code> because OPmac reads the REF file from previous TeX during <code>\input opmac</code> and it needs to know all macros used in REF file. </p><p>The macro <code>\makeglos</code> is kept unchanged from previous OPmac trick. </p></section><footer class='text-right'><a href='opmac-tricks.html#glosfirst' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0052</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article> <article id='glossort' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Glossary sorted by Czech sorting rules</h3> <a href='#glossort'><i class='fas fa-link'></i></a></div></header><section><p>The glossary from <a href='#gloslast' title='OPmac trick 0051'>OPmac trick 0051</a> is sorted alphabetically by ASCII values of letters used in abbreviation. Sometimes this is not sufficient, we need to sort by Czech sorting rules, for example. The same feature is implemented when index is sorted by OPmac. You can add the <code>\preparespecialsorting</code> before <code>\dosorting</code> sequence into <code>\makeglos</code> macro and the rest is the same as in previous OPmac trick. The <code>\preparespecialsorting</code> can be defined by the code: </p><pre class='pr-3'><code>\def\makeglos{% 
   ... 
   \preparespecialsorting \dosorting 
   ... 
} 
\def\preparespecialsorting{% 
   \setprimarysorting 
   \def\act##1{\ifx##1\relax\else \preparesorting##1% 
      \expandafter\edef\csname\string##1\endcsname{\tmpb}% 
      \expandafter\act\fi}% 
   \expandafter\act\iilist\relax 
   \def\firstdata##1{\csname\string##1\endcsname&amp;}% 
} 
</code></pre><p>If <code>\chyph</code> is activated then the sorting will be by Czech rules. </p><p>Explanation: OPmac sorts <code>\iilist</code> where are control sequences <code>\?fooa \?foob \?fooc</code> and where <code>?</code> is arbitrary character. When Index is sorted then <code>?=comma</code>, i.e. <code>\,fooa \,foob \,fooc</code>. We use semicolon for glossary in our code: <code>\;fooa \;foob \;fooc</code>. The macros from <code>\iilist</code> have to include the data in the form <code>{first data}{second data}</code>. The sorting is done by <code>{first data}</code>. The macro <code>\preparesorting\?foo</code> saves the <code>csname</code> (foo in this example) into <code>\tmpb</code> converted using <code>\lccode</code> to the state appropriate for Czech sorting. This result is saved into <code>\\?foo</code> and the <code>\firstdata</code> macro is redirected to this new data so the sorting in the first pass is done by the <code>\\?foo</code>. The second pass of sorting works too because the new data for second pass is needn't to be saved. </p></section><footer class='text-right'><a href='opmac-tricks.html#glossort' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0053</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article> <article id='glosref' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Glossary with hyperlinks</h3> <a href='#glosref'><i class='fas fa-link'></i></a></div></header><section><p>If you need to create the hyperlinks in the place where the abbreviation is used then you can write: </p><pre class='pr-3'><code>...text... \glosref{abbrev1}{explanation} ...text... \glosref{abver2}{expl2} 
...text... \glosref{abbrev1}{} 
... 
\makeglos 
</code></pre><p>The abbreviations will be printed in the text colored and as hyperlinks with the aim in the glossary list created by <code>\makeglos</code>. The explanation is possible to give only once and if you repeat the same abbreviation then all others have to have the empty explanation. If you write explanation twice for the same abbreviation then the macro prints warning and second explanation will be ignored. </p><p>The solution could be: </p><pre class='pr-3'><code>\hyperlinks\Blue\Blue 
 
\def\glosref #1#2{\if^#2^\else \glos{#1}{#2}\fi 
   \expandafter\isinlist\expandafter\gloslist\csname;#1\endcsname 
   \iftrue \makegloslink{#1}\link[glos:\tmp]{\localcolor\Blue}{#1}% 
   \else #1% 
   \fi 
} 
\def\printglos#1#2{\noindent \makegloslink{#1}\dest[glos:\tmp]#1 .. #2\par} 
 
\def\makegloslink#1{\def\tmp{}\expandafter\makegloslinkA#1\relax} 
\def\makegloslinkA#1{\ifx#1\relax\else 
   \edef\tmp{\tmp\number`#1.}\expandafter\makegloslinkA\fi} 
</code></pre><p>The macros <code>\glos</code> and <code>\makeglos</code> are the same as in above OPmac tricks. The <code>\glosref</code> checks if the second parameter is empty. Else the normal <code>\glos</code> is used. The twice declaration is checked here. The hyperlink is created by <code>\link</code> only if the item is saved in <code>\gloslist</code>. This saving is done by <code>\glos</code> or when REF file is read. The reason: we need to avoid the broken links which is not typically true after first TeX run. </p><p>The <code>\printglos</code> macro *must* include the <code>\dest</code> declaration. </p><p>The internal link is is created using the abbreviation and the <code>\makegloslink</code>, but this is not exactly the abbreviation because the exact abbreviation can include accents but link with accents in its internal string doesn't work. So, each character is translated to its numeric code and the list of such codes is the internal string used in the link. </p><p>You can define the color of the borders around the links by <code>\def\glosborder{R G B}</code>, for example <code>\def\glosborder{1 0 0}</code>. </p><p>Note: hyperlinks works from the first occurrence of the <code>\glosref</code> with the nonempty explanation. If the same <code>\glosref</code> with the empty explanation precedes then it is not hyperlinked. What to do? You can put the whole list of <code>\glos{abbrev}{explanation}\glos{abbrev2}{expl2}</code> etc. at the beginning of the document and then you can use <code>\glosref</code>'s in the text with always empty explanation. </p></section><footer class='text-right'><a href='opmac-tricks.html#glosref' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0054</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-05-11'>05/11/2014</time></span> </footer></article> <article id='acronym' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Acronyms</h3> <a href='#acronym'><i class='fas fa-link'></i></a></div></header><section><p>We'll play with the macro <code>\ac[label]</code> which prints <code>long name (short)</code> at the first place in the document and prints <code>short</code> at next places. We need to declare the acronym first by </p><pre class='pr-3'><code>\acrodef [label] {short} {long name} 
</code></pre><p>The direct printing of <code>short</code> is done by <code>\acs[label]</code> and <code>long name</code> by <code>\acl[label]</code>. The list of all acronys (in the same order as they were declared) can be printed by <code>\acrolist</code> macro. You can put this macro somewhere in the document but after a&nbsp;set of all declarations. You can refer the page with the first occurrence of the acronym by <code>\pgref[acro:label]</code>. </p><p>If you need to print the acronym with the first letter capitalized then you can use <code>\Ac[label]</code>. If you need to print the acronym by special suffix, then you must to declare <code>\acrodefx[label-suffix]</code> similar as <code>\acrodef[label]</code> but with appropriate suffixes. Example </p><pre class='pr-3'><code>\acrodef  [CTU]    {CTU}   {Czech Technical University in Prague} 
\acrodefx [CTU-s]  {CTU's} {Czech Technical Iniversities in Prague} 
\acrodef  [UK]     {UK}    {Charles University} 
\acrodef  [water]  {$\rm H_2O$} {water} 
 
Here is \ac[CTU] and beside it is \ac[UK]. Second occurrence \ac[CTU] and \ac[UK]. 
\Ac[water] is basic of the life. So, \ac[water] can be used repeatedly. 
 
\acrolist 
</code></pre><p>The macro set for <code>\ac</code> can look like: </p><pre class='pr-3'><code>\def\acrolist{} 
\def\acrodef[#1]#2#3{\sdef{as:#1}{#2}\sdef{al:#1}{#3}\addto\acrolist{\acroitem{#1}}} 
\def\acrodefx[#1-#2]#3#4{\sdef{as:#1-#2}{#3}\sdef{al:#1-#2}{#4}} 
\def\acs[#1]{\isdefined{as:#1}\iftrue \acroprint{as:#1}\else\acno{#1}\fi} 
\def\acl[#1]{\isdefined{al:#1}\iftrue \acroprint{al:#1}\else\acno{#1}\fi} 
\def\acno#1{\opwarning{acro [#1] undefined}ac?#1} 
\def\ac[#1]{\acX#1-\end 
   \isdefined{ad:\acA}\iftrue \acs[\acA\acB]\else 
   \label[acro:\acA]\openref\wlabel{}\global\sdef{ad:\acA}{}% 
   \acl[\acA\acB] \let\acrocap=\undefined(\acs[\acA\acB])\fi} 
\def\acX#1-#2\end{\def\acA{#1}\ifx\end#2\end \def\acB{}\else\acY#2\fi} 
\def\acY#1-{\def\acB{-#1}} 
\def\acroprint#1{\expandafter\expandafter\expandafter\acroprintA\csname#1\endcsname\end} 
\def\acroprintA#1#2\end{\ifx\acrocap\undefined\expandafter\acroprintB\else\uppercase\fi{#1}# 
\def\acroprintB#1{#1} 
\def\Ac[#1]{{\let\acrocap=\active\ac[#1]}} 
\def\acroitem#1{\par\noindent{\bf\boldmath\acs[#1]} -- \acl[#1] \dotfill \pgref[acro:#1]\par} 
\addprotect\acs \addprotect\acl 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#acronym' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0113</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2015-06-25'>06/25/2015</time></span> </footer></article>
                            </section>  <section id="rejstrik" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Index</h2>
                                    <a href="#rejstrik"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='sort' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Using sort from indexes for another purposes</h3> <a href='#sort'><i class='fas fa-link'></i></a></div></header><section><p>OPmac includes the sorting algorithm connected to creating the Index. It is not so simple to separate this algorithm from Index printing. We do it in this trick. We create the <code>\sort</code> macro which reads its arguments, sorts them alphabetically and saves the result into the auxiliary macro <code>\tmpb</code>. For example: </p><pre class='pr-3'><code>\sort{uu}{tt}{zz}{aa}\relax 
now, the \tmpb macro includes: {aa}{tt}{uu}{zz} 
</code></pre><p>The list of parameters have to be terminated by <code>\relax</code>. The unexpanded parts of the parameters cannot be used (this is analogical to the normal <code>\iindex</code> behavior). The implementation would be: </p><pre class='pr-3'><code>\def\sort{\begingroup\setprimarysorting\def\iilist{}\sortA} 
\def\sortA#1{\ifx\relax#1\sortB\else 
  \expandafter\addto\expandafter\iilist\csname,#1\endcsname 
  \expandafter\preparesorting\csname,#1\endcsname 
  \expandafter\edef\csname,#1\endcsname{{\tmpb}{}}% 
  \expandafter\sortA\fi 
} 
\def\sortB{\def\message##1{}\dosorting 
  \def\act##1{\ifx##1\relax\else \expandafter\sortC\string##1\relax \expandafter\act\fi}% 
  \gdef\tmpb{}\expandafter\act\iilist\relax 
  \endgroup 
} 
\def\sortC#1#2#3\relax{\global\addto\tmpb{{#3}}} 
</code></pre><p>The macro <code>\sort</code> works in the group <code>\begingroup...\endgroup</code> in order to the outside data (for Index) keep intact. The parameters are prepared and saved locally to <code>\iilist</code>, then the <code>\dosorting</code> macro is executed. The result is saved to <code>\tmpb</code> globally. </p><p>Note that the macro defines the <code>{second data}</code> for <code>\,foo</code> sequences as empty (see last but one line of the <code>\sortA</code> macro). This data field can be used for your data and you can use them after sorting by <code>\seconddata</code> macro from OPmac. </p></section><footer class='text-right'><a href='opmac-tricks.html#sort' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0080</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-12-10'>12/10/2014</time></span> </footer></article> <article id='klikpgr' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Pages in the Index as hyperlinks</h3> <a href='#klikpgr'><i class='fas fa-link'></i></a></div></header><section><p>When the Index is created by the <code>\makeindex</code> macro then the pages alongside the Index items are printed normally without hyperlinks. The pages are hyperlinked only in table of contents (after <code>\hyperlinks</code> declaration). </p><p>There are two reasons why OPmac doesn't implement page hyperlinks in the Index by default. The credo “power is simplicity” is preferred and the macro-space of the TeX memory is spared. When we have thousands of Index items and average three pages per item then we need approximately 9&nbsp;thousands of tokens more in the TeX memory. This memory wasting is not supported by OPmac. </p><p>If you explicitly need to have the page numbers in the Index hyperlinked then you can use the code: </p><pre class='pr-3'><code>\def\printiipages#1&amp;{\usepglinks#1\relax\par} 
\def\usepglinks{\afterassignment\usepglinksA \tmpnum=} 
\def\usepglinksA{\pglink{\the\tmpnum}\futurelet\next\usepglinksB} 
\def\usepglinksB{\ifx\next\relax \def\next{}\else 
   \ifx\next,\def\next,{, \afterassignment\usepglinksA \tmpnum=}\else 
   \ifx\next-\def\next--{--\afterassignment\usepglinksA\tmpnum=}% 
   \fi\fi\fi\next} 
</code></pre><p>The macro <code>\usepglinks</code> has the parameter (for example) <code>5, 15--18, 24</code> terminated by <code>\relax</code>. The macro scans the numbers in its parameter and expands each number to the <code>\pglink{number}</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#klikpgr' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0006</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-13'>08/13/2013</time></span> </footer></article> <article id='iindexb' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Alternative page-lists in the index</h3> <a href='#iindexb'><i class='fas fa-link'></i></a></div></header><section><p>Sometimes we need alongside the Index items more than one page list. Fox example one page list is basic (in roman font), second page list in italics or bold with important occurrences of the Index item. You can be inspired in the Index of the TeXbook. The italic or underlined page numbers denote something more important. </p><p>The macro <code>\Xindexg{prefix}{word}{page}</code> is provided by OPmac since the version Jun. 2014. It can be used in the REF files similarly like <code>\Xindex{word}{page}</code>. This macro creates alternative pagelists in the macros <code>\prefixword</code> and the lists of such sequences are saved in <code>\iilist:prefix</code>. The pagelist is processed analogically as standard <code>\,word</code> is used, i.e. the data are in two parts. First part includes the attribute of the processing and the second part included the condensed page list (for example <code>3,4,4,4,5</code> is condensed to <code>3--5</code>). </p><p>Just for example, we create the macro <code>\iindexb{word}</code>, which saves the word occurrence into the separated page list prefixed by <code>b:</code>. If the word will have this page list, it will be printed in the Index before common page list in red and bold. </p><pre class='pr-3'><code>\def\iindexb#1{\openref\wref\Xindexg{{b:}{#1}{\the\pageno}}} 
\def\printiipages#1&amp;{ % second space between word and pagelist 
   \expandafter \isinlist \csname iilist:b:\expandafter\endcsname \csname b:\currii\endcsname 
   \iftrue 
      \expandafter\seconddata \csname b:\currii\endcsname \XindexB 
      {\localcolor\Red \bf \tmp}, \fi 
   #1\par 
} 
</code></pre><p>The <code>\iindexb</code> is defined at the first line. The word occurrence is sent to alternative page list prefixed by <code>b:</code>. The <code>\printiipages</code> is redefined in order it get the common pagelist in <code>#1</code> parameter and this to be printed. By the code <code>\isinlist \iilist:b: \b:word \iftrue</code> we do the test if the word has the alternative page list. If it is true then <code>{\localcolor\Red \bf \tmp}</code> is inserted. The <code>\tmp</code> macro includes the second data from <code>\b:word</code>. </p><p>The example above will work only in the case that the word have its normal occurrence because the <code>\makeindex</code> processes only <code>\iilist</code> with normal words. Next, we suppose that the alternative page list is closed or it includes only isolated pages. If this isn't true then we need to close the alternative page list. Both these problems are solved by the code: </p><pre class='pr-3'><code>\def\iindexb#1{\openref\wref\Xindexg{{b:}{#1}{\the\pageno}}\wref\Xindex{{#1}{}}} 
\def\printiipages#1&amp;{ % second space between word and pagelist 
   \expandafter \isinlist \csname iilist:b:\expandafter\endcsname \csname b:\currii\endcsname 
   \iftrue 
      \expandafter\firstdata  \csname b:\currii\endcsname \XindexA 
      \expandafter\seconddata \csname b:\currii\endcsname \XindexB 
      {\localcolor\Red \bf \tmp\ifx\tmpb-\pgfolioA{\tmpa}\fi}% 
      \if^#1^\else, \fi % comma only if the next list isn't empty 
   \fi 
   #1\par 
} 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#iindexb' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0072</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-22'>06/22/2014</time></span> </footer></article> <article id='iibe' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Index entry valid in page range</h3> <a href='#iibe'><i class='fas fa-link'></i></a></div></header><section><p>It is usable to say that the word (for Index) occurs at all pages of given chapter or at all pages between this occurrence and following occurrence. This cannot be always exactly true but this is not out problem now. The singular occurrences cannot be set (by <code>\iindex{}</code>) inside the declared page range. We create the macro pair <code>\iindexbeg{word} ... \iindexend{word}</code>, which declares the page range. This page range will be added to the page list and merged wit another pages. </p><pre class='pr-3'><code>\def\Xindexgend#1#2#3{\bgroup \def~{ }% #1=prefix, #2=index-item, #3=pageno 
   \expandafter\firstdata \csname#1#2\endcsname \XindexA 
   \expandafter\seconddata \csname#1#2\endcsname \XindexB 
   \ifnum#3=\tmpa \else 
      \if\tmpb+% 
         \sxdef{#1#2}{{#3/-}{\tmp\iiendash}} 
      \else 
         \sxdef{#1#2}{{#3/-}{\tmp}} 
   \fi\fi \egroup 
} 
\input opmac 
 
\def\iindexbeg#1{\iindex{#1}\expandafter\iimute\csname,#1\endcsname} 
\def\iindexend#1{\expandafter\isinlist\expandafter\iimutelist\csname,#1\endcsname\iftrue 
   \wref\Xindexgend{,{#1}{\the\pageno}}\expandafter\iiunmute\csname,#1\endcsname \fi 
} 
\def\iindex#1{\expandafter\isinlist\expandafter\iimutelist\csname,#1\endcsname\iftrue 
   \else \openref\wref\Xindex{{#1}{\the\pageno}}\fi 
} 
\def\iimute#1{\global\addto\iimutelist#1} 
\def\iiunmute#1{\def\tmp##1#1##2\end{\gdef\iimutelist{##1##2}}\expandafter\tmp\iimutelist\end} 
\def\iimutelist{} 
</code></pre><p>The auxiliary macro <code>\Xindexgend</code> is used in REF file. This is a&nbsp;reason why we need to define it before <code>\input opmac</code>. The <code>\iindexbeg</code> macro only saves the occurrence of the word by <code>\iindex</code> and it deactivates the <code>\iindex{word}</code> by <code>\iimute</code>. The <code>\iindex{word}</code> will be “mute” in the page range because the continuous page range can would be broken by it. The macro <code>\iindexend{word}</code> inserts the <code>\Xindexgend,{word}{page}</code> into REF file. During REF processing, this macro opens the actual page list from previous page number to actual page or prolongs the opened page list to the current page. </p><p>The <code>\iindex</code> is redefined so that only the words not included in <code>\iimutelist</code> are saved to the REF file. The macros <code>\iimute</code> and <code>\iiunmute</code> save and remove the word to/from the <code>\iimutelist</code> </p></section><footer class='text-right'><a href='opmac-tricks.html#iibe' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0073</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2014-06-24'>06/24/2014</time></span> </footer></article> <article id='strcmp' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>The sorting experiment</h3> <a href='#strcmp'><i class='fas fa-link'></i></a></div></header><section><p>PdfTeX implements the <code>\pdfstrcmp{string1}{string2}</code> primitive which returns zero if the strings are the same, returns <code>-1</code> if <code>string1</code> is less then <code>string2</code> else returns <code>+1</code>. OPmac don't use this primitive when it is sorting the Index because only classical TeX us used. This is a&nbsp;reason why OPmac implements this test by four recursive macros, reads token per token and does the test. I&nbsp;have performed the experiment to replace these recursive macros to mentioned primitive and to measure the time. The testing code redefines <code>\isAleB</code> form OPmac: </p><pre class='pr-3'><code>\def\isAleB #1#2{% 
   \edef\tmp{\noexpand\pdfstrcmp{\firstdata#1\empty}{\firstdata#2\empty}} 
   \ifnum\tmp&lt;0 \AleBtrue 
   \else \ifnum\tmp&gt;0 \AleBfalse 
   \else \bgroup \setsecondarysorting 
            \preparesorting#1\let\tmpa=\tmpb \preparesorting#2% 
            \edef\tmp{\noexpand\pdfstrcmp{\tmpa}{\tmpb}}% 
            \ifnum\tmp&lt;0 \global\AleBtrue \else \global\AleBfalse \fi 
         \egroup 
   \fi\fi 
} 
</code></pre><p>The result was surprising. The time is not saved. The sorting of the example <code>kuk8.tex</code> from my lecture from December 2012 (where are 6&nbsp;thousands of the index words) takes 4.13 sec by classical OPmac macros and 4.04 sec when \<code>pdfstrcmp</code> is used. It means that the macro expansion is implemented in TeX very effectively and build-in function <code>\pdfstrcmp</code> doesn't add new real power. </p></section><footer class='text-right'><a href='opmac-tricks.html#strcmp' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0018</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2013-08-26'>08/26/2013</time></span> </footer></article> <article id='currchar' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Sections inside the index by first letter</h3> <a href='#currchar'><i class='fas fa-link'></i></a></div></header><section><p>We need to divide the items in the index to sections by their first letter. Each section must be titled by the large and boldface letter significant for this section. </p><p>The solution is based on the <code>\everyii</code> macro which is empty by default and OPmac inserts this macro before printing of each index item. </p><pre class='pr-3'><code>\def\lastchar{} 
\def\everyii{\expandafter\makecurrchar\currii\end 
   \ifx\currchar\lastchar \else 
      \bigskip{\typosize[20/24]\bf\currchar}\par\nobreak\medskip\noindent 
      \let\lastchar=\currchar 
   \fi 
} 
\def\makecurrchar#1#2\end{\uppercase{\def\currchar{#1}}} 
</code></pre><p>First, the <code>\lastchar</code> is empty. The <code>\currchar</code> (first letter of processed item) is scanned before the item is printed. The <code>\currchar</code> is modified by <code>\uppercase</code> primitive. If <code>\currchar</code> differs from <code>\lastchar</code>, the heading of new “section” is printed and the <code>\latchar</code> is set to <code>\currchar</code>. </p></section><footer class='text-right'><a href='opmac-tricks.html#currchar' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0140</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-06-08'>06/08/2016</time></span> </footer></article>
                            </section>  <section id="meta" class="mb-5 rounded my-shadow" style="background-color: #778c94">
                                <header class="text-center">
                                  <div class="py-2">
                                    <h2 class="d-inline text-light font-weight-light">Format</h2>
                                    <a href="#meta"><i class="fas fa-link"></i></a>
                                  </div>
                                </header>
                                <article id='opformat' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>OPmac macros as part of a format</h3> <a href='#opformat'><i class='fas fa-link'></i></a></div></header><section><p>A&nbsp;user don't need to write <code>\input opmac</code> at beginning of the document if the appropriate format is generated. For example csplain + OPmac with PDF output can be generate by the following <code>.ini</code> file: </p><pre class='pr-3'><code>\input csfonts    % CSfonts as default fonts 
\input plain      % plain.tex by DEK 
\restorefont      % restoring of \font primitive 
\input csfontsm   % basic macros for font managing 
\input il2code    % default encoding IL2 (of CSfonts) 
\input etex-mac   % eTeX extensions for registers allocation 
\input hyphen.lan % hyphenatinon patterns of various languages 
\input plaina4    % A4 paper as default 
\input csenc-u    % UTF-8 encoding at input (using encTeX) 
\pdfoutput=1      % output to PDF 
\input opmac      % OPmac macros 
\everyjob=\expandafter{\the\everyjob 
   \message{The format: csplain + OPmac, PDF output}% 
   \inputref} 
\dump 
generate by:  pdftex -ini -etex -enc thisfile.ini 
</code></pre><p>The reading of <code>\jobname.ref</code> file must be realized by <code>\inputref</code> macro added in <code>\everyjob</code>. </p><p>If you want to combine OPmac with <code>etex.src</code> format then the <code>.ini</code> file can look more simple: </p><pre class='pr-3'><code>\pdfoutput=1 
\input etex.src 
\input opmac 
\everyjob=\expandafter{\the\everyjob 
   \message{The format: etex.src + OPmac, PDF output}% 
   \inputref} 
\dump 
generate by:  pdftex -ini -etex thisfile.ini 
</code></pre></section><footer class='text-right'><a href='opmac-tricks.html#opformat' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0139</span> <span class='badge badge-info'>Author: P. O.</span> <span class='badge badge-info'>Published <time datetime='2016-03-12'>03/12/2016</time></span> </footer></article> <article id='curl' class='mb-2 p-3 bg-white rounded border'><header><div class='pb-2'><h3 class='d-inline'>Sorted names of these tricks on your terminal</h3> <a href='#curl'><i class='fas fa-link'></i></a></div></header><section><p>Maybe you can find useful to show all names of these tricks sorted on your terminal, i.e. sorted (relatively) by time form oldest to newest. You can do it by the command: </p><pre class='pr-3'><code>  curl http://petr.olsak.net/opmac-tricks-e.html | tac \ 
   | sed -n '/CLASS.*datum/{:a;N;/&lt;h2&gt;&lt;a/!ba;s/\n.*\n//; s/&lt;a[^&gt;]*&gt;/ : /;s/&lt;[^&gt;]*&gt;//g;p}' | sort 
</code></pre><p>The author published this trick <a href='http://matouskojc.cz/pisalek.php?file_index=pcblog-2015' title='at his site'>at his site</a> in the article Opmac-triky -- sort. </p></section><footer class='text-right'><a href='opmac-tricks.html#curl' class='float-left badge badge-secondary'>Čeština <img src='img/cs.png' style='max-height: 1rem;'></a> <span class='badge badge-info'>ID: 0143</span> <span class='badge badge-info'>Author: Radek Matoušek</span> <span class='badge badge-info'>Published <time datetime='2015-12-11'>12/11/2015</time></span> </footer></article>
                            </section>

					</main>
				</div>
				<div class="py-3 px-2 px-sm-3 bg-light border-top">
					<footer class="my-content mb-5 mb-lg-0 mx-auto ml-xl-5">
						<p>Web design and automated generation of html and PDF was created by students Jan Jirman and Ondřej Šodek as <a href="http://petr.olsak.net/typotex.html">Typography and TeX</a> course semestral work in year 2018.</p>
					</footer>
				</div>
			</div>

		</div>
	</div>

	<a id="back-to-top" href="#" class="btn btn-primary btn-lg back-to-top" role="button" title="Back to top" data-toggle="tooltip" data-placement="left">
		<i class="fas fa-chevron-up"></i>
	</a>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

	<script>
	$(document).ready(function(){
		var offset = 600;
		var duration = 300;

		$(window).scroll(function () {
			if ($(this).scrollTop() > offset && $(window).width() < 992) {
				$('#back-to-top').fadeIn();
			} else {
				$('#back-to-top').fadeOut();
			}
		});

		$('#back-to-top').click(function () {
			$('#back-to-top').tooltip('hide');
			$('body,html').animate({scrollTop: 0}, duration);
			return false;
		});

		$('#back-to-top').tooltip();
	});
	</script>

</body>
</html>
